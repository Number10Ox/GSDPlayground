---
phase: 04-character-system
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/Character/StatDisplay.tsx
  - src/components/Character/CharacterSheet.tsx
  - src/components/Character/CharacterCreation.tsx
  - src/components/CharacterInfo/CharacterInfo.tsx
  - src/utils/dice.ts
  - src/hooks/useGameState.tsx
autonomous: true

must_haves:
  truths:
    - "Player sees stat dice in sidebar with western-religious icons"
    - "Stats visibly contribute dice to the cycle dice pool"
    - "Player can create a character with point-buy stat allocation"
    - "Character condition modifiers from stats affect pool quality"
  artifacts:
    - path: "src/components/Character/StatDisplay.tsx"
      provides: "Single stat with icon and dice visualization"
      min_lines: 30
    - path: "src/components/Character/CharacterSheet.tsx"
      provides: "Full character view with all stats"
      min_lines: 40
    - path: "src/components/Character/CharacterCreation.tsx"
      provides: "Point-buy allocation UI for character creation"
      min_lines: 80
    - path: "src/components/CharacterInfo/CharacterInfo.tsx"
      provides: "Updated sidebar showing real character data"
      min_lines: 40
  key_links:
    - from: "src/components/Character/StatDisplay.tsx"
      to: "src/types/character.ts"
      via: "imports Stat type"
      pattern: "import.*Stat.*from.*character"
    - from: "src/components/CharacterInfo/CharacterInfo.tsx"
      to: "src/hooks/useCharacter.tsx"
      via: "useCharacter hook for live data"
      pattern: "useCharacter\\(\\)"
    - from: "src/utils/dice.ts"
      to: "src/types/character.ts"
      via: "imports Character for stat-based pool generation"
      pattern: "import.*Character.*from.*character"
---

<objective>
Create the character display UI (stat icons in sidebar, character sheet) and character creation flow, then wire stats into the dice pool generation so stats visibly affect gameplay.

Purpose: This makes the character system visible and interactive. Players see their Dog's stats at all times, can create a character with DitV point-buy, and stats directly affect the dice they get each cycle.

Output: Stat display components, character creation UI, updated sidebar, stat-based dice pool generation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-character-system/04-CONTEXT.md
@.planning/phases/04-character-system/04-RESEARCH.md
@.planning/phases/04-character-system/04-01-SUMMARY.md
@src/types/character.ts
@src/hooks/useCharacter.tsx
@src/hooks/useGameState.tsx
@src/components/CharacterInfo/CharacterInfo.tsx
@src/utils/dice.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Character display components with Lucide icons</name>
  <files>src/components/Character/StatDisplay.tsx, src/components/Character/CharacterSheet.tsx, src/components/CharacterInfo/CharacterInfo.tsx</files>
  <action>
    Create `src/components/Character/StatDisplay.tsx`:
    - Props: stat: Stat, dimmed?: boolean (for conflicts where stat is inactive)
    - Import Lucide icons: Lightbulb (Acuity), Hand (Body), Heart (Heart), Cross (Will)
    - Map stat.name to appropriate icon
    - Display: icon + stat name + dice visualization
    - Dice visualization: small colored shapes showing each die type (reuse die colors from Phase 2: d4=red, d6=amber, d8=green, d10=blue)
    - Show modifier if non-zero: e.g., "3d6 (-1d6)" in red text for injuries
    - When dimmed=true, apply opacity-40 to entire stat row
    - Add data-testid="stat-{name}" for E2E testing

    Create `src/components/Character/CharacterSheet.tsx`:
    - Import useCharacter hook
    - Full character view showing: name, background, all stats, traits list, inventory, relationships
    - Stats section uses StatDisplay for each stat
    - Traits section lists trait name + dice notation (e.g., "Quick Draw: 1d6")
    - Inventory section lists items with category and dice
    - Relationships section lists NPC names with dice
    - If character is null, show "No character created" message
    - Add data-testid="character-sheet"

    Update `src/components/CharacterInfo/CharacterInfo.tsx`:
    - Replace placeholder content with real character data from useCharacter()
    - Show: character name, all four stats using StatDisplay (compact mode)
    - Show cycle number and condition from useGameState()
    - Keep "View Character Sheet" button (will toggle full sheet later)
    - If character is null, show a "Create Character" prompt/button
    - Add data-testid="character-info"
  </action>
  <verify>`npm run build` succeeds. App shows character info sidebar (null state shows create prompt).</verify>
  <done>StatDisplay shows icons with dice, CharacterSheet shows full character view, CharacterInfo sidebar shows real character data or creation prompt</done>
</task>

<task type="auto">
  <name>Task 2: Character creation UI and stat-based dice pool</name>
  <files>src/components/Character/CharacterCreation.tsx, src/utils/dice.ts, src/hooks/useGameState.tsx</files>
  <action>
    Create `src/components/Character/CharacterCreation.tsx`:
    - Point-buy allocation UI using buttons (not drag-and-drop, per research recommendation)
    - Step 1: Name input (text field, min 2 chars)
    - Step 2: Background selection (3 cards: complicated-history, strong-community, well-rounded)
      - Each card shows: description, stat dice count, trait/relationship dice summary
    - Step 3: Stat allocation
      - Show remaining d6 to allocate (e.g., "9 remaining" starting from total - 8 since min 2 per stat)
      - Each stat row: icon + name + current count + plus/minus buttons
      - Minimum 2d6 per stat, maximum 6d6 per stat
      - Plus button disabled when no remaining dice or at max
      - Minus button disabled when at minimum (2)
      - Show remaining dice count prominently
    - Step 4: Confirm button (disabled until all dice allocated, i.e., remaining = 0)
    - On confirm: call createCharacter() and dispatch SET_CHARACTER
    - Add data-testid attributes: "creation-name-input", "creation-background-{id}", "creation-stat-{name}-plus", "creation-stat-{name}-minus", "creation-confirm"

    Update `src/utils/dice.ts` - modify generateDicePool():
    - Add optional second parameter: character: Character | null
    - If character is provided, generate pool FROM character stats:
      - Collect all stat dice (acuity + body + heart + will)
      - Apply stat modifiers (modifier reduces dice count, minimum 0 per stat)
      - Apply condition as a FILTER: condition < 50 removes weakest dice, condition < 25 removes more
      - Roll each die and return with id, type, value, assignedTo: null
    - If character is null, fall back to existing condition-only generation (backward compatible)
    - Export the function with updated signature

    Update `src/hooks/useGameState.tsx`:
    - Import useCharacter in the GameProvider (or accept character as prop)
    - In START_CYCLE action: pass character to generateDicePool()
    - This requires either: (a) accessing character context inside gameReducer, or (b) computing dice pool in the component and passing via action
    - Preferred approach (b): Change START_CYCLE action to accept optional dicePool: Die[] parameter. If provided, use it directly. If not, fall back to condition-only generation.
    - In the CycleView or wherever START_CYCLE is dispatched, compute the pool using character + condition and pass it in the action.
    - Add new action type to GameAction union: update START_CYCLE to optionally carry dicePool
  </action>
  <verify>`npm run build` succeeds. Character creation flow works: name -> background -> allocate -> confirm produces character with stats in sidebar. Dice pool in cycle reflects character stats.</verify>
  <done>Character creation produces a Dog with allocated stats. Cycle dice pool is generated from character stats (stat dice rolled and available for allocation).</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Character creation flow: enter name, pick background, allocate stats, confirm
- Sidebar shows stat icons with dice counts
- Starting a new cycle generates dice pool from character stats
- Stat modifiers (injuries) reduce available dice
</verification>

<success_criteria>
- Stats display with Lucide western-religious icons (Lightbulb, Hand, Heart, Cross)
- Point-buy allocation with min 2 / max 6 per stat and remaining counter
- Character creation produces valid Dog stored in context
- Dice pool generation uses character stats instead of just condition number
</success_criteria>

<output>
After completion, create `.planning/phases/04-character-system/04-02-SUMMARY.md`
</output>
