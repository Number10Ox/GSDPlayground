---
phase: 04-character-system
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/components/Character/InventoryPanel.tsx
  - src/components/Character/TraitList.tsx
  - src/components/Character/TraitAndItemInvocation.tsx
  - src/types/conflict.ts
  - src/reducers/conflictReducer.ts
  - src/components/Conflict/ConflictView.tsx
autonomous: true

must_haves:
  truths:
    - "Player can see inventory items with their dice values"
    - "Player can invoke a trait mid-conflict during raise/see for bonus dice"
    - "Each trait can only be invoked once per conflict"
    - "Invoked trait dice are added to the player's conflict pool"
    - "Items can contribute dice to conflicts via the same invocation UI"
  artifacts:
    - path: "src/components/Character/InventoryPanel.tsx"
      provides: "Inventory display with item dice and categories"
      min_lines: 40
    - path: "src/components/Character/TraitList.tsx"
      provides: "Trait list with dice notation and source indicator"
      min_lines: 30
    - path: "src/components/Character/TraitAndItemInvocation.tsx"
      provides: "Mid-conflict trait and item selection UI"
      min_lines: 50
  key_links:
    - from: "src/components/Character/TraitAndItemInvocation.tsx"
      to: "src/reducers/conflictReducer.ts"
      via: "dispatches INVOKE_TRAIT and USE_ITEM actions"
      pattern: "INVOKE_TRAIT|USE_ITEM"
    - from: "src/reducers/conflictReducer.ts"
      to: "src/types/character.ts"
      via: "imports Trait type for invocation"
      pattern: "import.*Trait.*from.*character"
    - from: "src/components/Conflict/ConflictView.tsx"
      to: "src/components/Character/TraitAndItemInvocation.tsx"
      via: "renders TraitAndItemInvocation below escalation buttons during PLAYER_RAISE/PLAYER_SEE"
      pattern: "TraitAndItemInvocation"
---

<objective>
Create the inventory display, trait list, and mid-conflict trait/item invocation system so players can see and use their character's belongings and traits during gameplay.

Purpose: Items and traits are what make each Dog unique. Trait invocation mid-conflict is the signature DitV mechanic where players narrate their traits into the fiction for bonus dice. This plan makes the character's assets interactive and mechanically meaningful. Both traits AND items share the same invocation UI for a unified experience.

Output: Inventory panel, trait list, combined trait/item invocation UI integrated into conflict flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-character-system/04-CONTEXT.md
@.planning/phases/04-character-system/04-RESEARCH.md
@.planning/phases/04-character-system/04-01-SUMMARY.md
@src/types/character.ts
@src/types/conflict.ts
@src/reducers/conflictReducer.ts
@src/components/Conflict/ConflictView.tsx
@src/hooks/useCharacter.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Inventory and trait display components</name>
  <files>src/components/Character/InventoryPanel.tsx, src/components/Character/TraitList.tsx</files>
  <action>
    Create `src/components/Character/InventoryPanel.tsx`:
    - Props: items: Item[]
    - Display each item as a row: name, category badge, dice notation, gun indicator
    - Category badges use Tailwind colors: normal=gray, big=blue, excellent=green, big-excellent=emerald, crap=red
    - Gun items show a small bullet/target icon (from Lucide: Target or Crosshair)
    - Dice shown as small colored icons inline (reuse die color scheme)
    - Empty state: "No items" message
    - Add data-testid="inventory-panel" and data-testid="item-{id}" per item

    Create `src/components/Character/TraitList.tsx`:
    - Props: traits: Trait[], onInvoke?: (traitId: string) => void, usedTraitIds?: Set<string>
    - Display each trait: name, dice notation (e.g., "2d6"), source badge (creation=amber, fallout=red)
    - If onInvoke provided (conflict mode): show "Invoke" button next to each trait
    - If trait id is in usedTraitIds: show "Used" badge instead of invoke button, dim the row
    - Without onInvoke (passive display): just show traits as info
    - Add data-testid="trait-list" and data-testid="trait-{id}" per trait
    - Add data-testid="invoke-trait-{id}" on invoke buttons
  </action>
  <verify>`npm run build` succeeds. Components render correctly with test data.</verify>
  <done>InventoryPanel shows items with categories and dice. TraitList shows traits with invoke capability.</done>
</task>

<task type="auto">
  <name>Task 2: Trait and item invocation during conflict</name>
  <files>src/components/Character/TraitAndItemInvocation.tsx, src/types/conflict.ts, src/reducers/conflictReducer.ts, src/components/Conflict/ConflictView.tsx</files>
  <action>
    Update `src/types/conflict.ts`:
    - Add `usedTraits: string[]` to the ACTIVE phase of ConflictState (track invoked trait IDs)
    - Add `usedItems: string[]` to the ACTIVE phase (track used item IDs)
    - Add new ConflictAction:
      - { type: 'INVOKE_TRAIT'; traitId: string; dice: Die[] } — adds rolled trait dice to player pool
      - { type: 'USE_ITEM'; itemId: string; dice: Die[] } — adds rolled item dice to player pool
    - Initialize usedTraits: [] and usedItems: [] in START_CONFLICT

    Update `src/reducers/conflictReducer.ts`:
    - Handle INVOKE_TRAIT:
      - Guard: only valid when phase is ACTIVE and currentTurn is PLAYER_RAISE or PLAYER_SEE
      - Guard: traitId must NOT be in usedTraits array
      - Add traitId to usedTraits array
      - Add dice (already rolled by component) to playerPool
    - Handle USE_ITEM:
      - Guard: only valid when phase is ACTIVE and currentTurn is PLAYER_RAISE or PLAYER_SEE
      - Guard: itemId must NOT be in usedItems array
      - Add itemId to usedItems array
      - Add dice to playerPool

    Create `src/components/Character/TraitAndItemInvocation.tsx`:
    - Props: none (uses useCharacter and conflict state)
    - Shows available traits from character that haven't been used this conflict
    - Shows available items from character inventory that haven't been used this conflict
    - Unified UI: traits section header "Traits", then items section header "Items" — both in same panel
    - Each trait/item shows: name, dice it would add, "Invoke"/"Use" button
    - On invoke: rolls the trait/item dice (using rollDie from utils), dispatches INVOKE_TRAIT/USE_ITEM with rolled dice
    - Used traits/items shown as dimmed with "Used" badge
    - Collapsible panel that slides in from side (framer-motion)
    - Add data-testid="trait-invocation-panel"
    - Add data-testid="use-item-{id}" on item use buttons

    Update `src/components/Conflict/ConflictView.tsx`:
    - Import TraitAndItemInvocation
    - Render TraitAndItemInvocation BELOW the escalation buttons section (after line ~452 in the center column, inside the flex-1 flex-col container), still within the center "Controls and pool" area
    - Placement: After the escalation div, add a new section with header "Invoke Traits & Items" that renders TraitAndItemInvocation
    - Only render when conflict is ACTIVE and currentTurn is PLAYER_RAISE or PLAYER_SEE
    - Only show if character has traits or items to invoke
    - This keeps the main raise/see controls visible above while trait/item invocation is accessible below
  </action>
  <verify>`npm run build` succeeds. During conflict, player can invoke traits and use items to add dice to pool. Each trait/item usable only once per conflict.</verify>
  <done>Traits invoke mid-conflict adding dice to player pool. Items contribute dice when used. Each usable only once per conflict. Invocation UI appears below escalation buttons during player's raise/see turns.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- Inventory panel displays items with categories and dice
- Trait list shows traits with dice and source
- During conflict: trait/item invocation panel appears below escalation buttons on player's turn
- Invoking a trait adds its dice to player pool
- Using an item adds its dice to player pool
- Same trait/item cannot be invoked/used twice in same conflict
</verification>

<success_criteria>
- Inventory displays all items (coat, gun, Book of Life, sacred earth) with correct dice
- Traits display with source badges (creation vs fallout)
- Mid-conflict invocation works: select trait or item -> dice added to pool
- One-use-per-conflict rule enforced (used traits/items dimmed)
- Combined UI shows both traits and items in a single panel
</success_criteria>

<output>
After completion, create `.planning/phases/04-character-system/04-03-SUMMARY.md`
</output>
