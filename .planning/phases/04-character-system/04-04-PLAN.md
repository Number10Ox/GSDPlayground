---
phase: 04-character-system
plan: 04
type: execute
wave: 3
depends_on: ["04-02", "04-03"]
files_modified:
  - src/utils/falloutTraits.ts
  - src/components/Conflict/FalloutReveal.tsx
  - src/components/Conflict/ConflictResolution.tsx
  - src/components/Character/RelationshipDice.tsx
  - src/types/conflict.ts
  - src/reducers/conflictReducer.ts
autonomous: true

must_haves:
  truths:
    - "Conflict fallout can add new traits to the character"
    - "Fallout trait dice scale with severity (MINOR=1d4, SERIOUS=1d6, DEADLY=1d8)"
    - "Relationships with NPCs provide dice in relevant conflicts"
    - "Relationship dice are added to pool at conflict start when NPC is relevant"
  artifacts:
    - path: "src/utils/falloutTraits.ts"
      provides: "createTraitFromFallout utility function"
      exports: ["createTraitFromFallout", "FALLOUT_TRAIT_NAMES"]
    - path: "src/components/Character/RelationshipDice.tsx"
      provides: "UI showing which relationships provide dice for current conflict"
      min_lines: 30
  key_links:
    - from: "src/components/Conflict/FalloutReveal.tsx"
      to: "src/utils/falloutTraits.ts"
      via: "calls createTraitFromFallout after fallout calculated"
      pattern: "createTraitFromFallout"
    - from: "src/components/Conflict/FalloutReveal.tsx"
      to: "src/hooks/useCharacter.tsx"
      via: "dispatches ADD_TRAIT to character"
      pattern: "dispatch.*ADD_TRAIT"
    - from: "src/components/Character/RelationshipDice.tsx"
      to: "src/types/character.ts"
      via: "imports Relationship type"
      pattern: "import.*Relationship.*from.*character"
---

<objective>
Wire fallout-to-trait conversion (conflict consequences become character traits) and relationship dice bonus (NPCs the player knows provide dice in relevant conflicts).

Purpose: These two features close the character-gameplay loop. Fallout creates new traits (consequences of violence become part of your Dog's identity), and relationships make NPC connections mechanically meaningful (knowing the Sheriff means something when you confront the sinner).

Output: Fallout creates permanent character traits, relationship dice contribute to conflict pools.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-character-system/04-CONTEXT.md
@.planning/phases/04-character-system/04-01-SUMMARY.md
@.planning/phases/04-character-system/04-02-SUMMARY.md
@.planning/phases/04-character-system/04-03-SUMMARY.md
@src/types/character.ts
@src/types/conflict.ts
@src/utils/fallout.ts
@src/components/Conflict/FalloutReveal.tsx
@src/components/Conflict/ConflictResolution.tsx
@src/hooks/useCharacter.tsx
@src/reducers/conflictReducer.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fallout-to-trait conversion</name>
  <files>src/utils/falloutTraits.ts, src/components/Conflict/FalloutReveal.tsx, src/components/Conflict/ConflictResolution.tsx</files>
  <action>
    Create `src/utils/falloutTraits.ts`:
    - Import Trait, CharacterDie from '@/types/character'
    - Import FalloutSeverity, FalloutType from '@/types/conflict'
    - Export `FALLOUT_TRAIT_NAMES`: Record<FalloutType, string[]> with themed names:
      - SOCIAL: ["Shamed reputation", "Haunted by words", "Bitter tongue", "Broken trust", "Dark conviction"]
      - PHYSICAL: ["Bruised ribs", "Twisted ankle", "Split lip", "Aching shoulder", "Cracked knuckle"]
      - VIOLENT: ["Scarred face", "Broken arm", "Deep gash", "Shattered jaw", "Bullet graze"]
      - LETHAL: ["Gutshot survivor", "Near-death vision", "One good eye left", "Shattered leg", "Lung damage"]
    - Export `createTraitFromFallout(severity, falloutType, customName?)`:
      - Map severity to die type: MINOR=d4, SERIOUS=d6, DEADLY=d8
      - If severity is NONE or DEATH, return null (no trait created)
      - Pick a random name from FALLOUT_TRAIT_NAMES[falloutType] if customName not provided
      - Return Trait with: id (crypto.randomUUID), name, dice: [{ id, type: mappedDieType }], source: 'fallout'

    Update `src/components/Conflict/FalloutReveal.tsx`:
    - After fallout severity is calculated and shown (in the VERDICT phase of the reveal sequence):
      - If severity is MINOR, SERIOUS, or DEADLY:
        - Call createTraitFromFallout(severity, falloutType)
        - Show the new trait to the player: "You gained a new trait: {name} ({dieType})"
        - Dispatch ADD_TRAIT to character context with the new trait
      - Show trait gain as part of the fallout reveal animation (after severity shown, before dismissal)
    - Import useCharacter hook

    Update `src/components/Conflict/ConflictResolution.tsx` (if it handles post-conflict flow):
    - Ensure the fallout-to-trait path is triggered after APPLY_FALLOUT dispatched to game state
    - The trait addition should happen in the same flow as fallout application
  </action>
  <verify>`npm run build` succeeds. After a conflict with fallout, character gains a new trait visible in trait list.</verify>
  <done>MINOR/SERIOUS/DEADLY fallout creates a trait (d4/d6/d8). Trait appears in character's trait list with source: 'fallout'. Player sees "gained trait" message during fallout reveal.</done>
</task>

<task type="auto">
  <name>Task 2: Relationship dice in conflicts</name>
  <files>src/components/Character/RelationshipDice.tsx, src/types/conflict.ts, src/reducers/conflictReducer.ts, src/components/Conflict/ConflictView.tsx</files>
  <action>
    Create `src/components/Character/RelationshipDice.tsx`:
    - Props: relationships: Relationship[], conflictNpcId: string, usedRelationships: string[]
    - Filter relationships to show only relevant ones:
      - Direct: relationship.npcId === conflictNpcId (always relevant)
      - Others shown but marked "may be relevant" (player decides)
    - Display each relevant relationship: NPC name, dice it would add, "Use" button
    - Used relationships show "Applied" badge, dimmed
    - Add data-testid="relationship-dice-panel"
    - Add data-testid="use-relationship-{id}" on use buttons

    Update `src/types/conflict.ts`:
    - Add `usedRelationships: string[]` to the ACTIVE phase of ConflictState
    - Add new ConflictAction:
      - { type: 'USE_RELATIONSHIP'; relationshipId: string; dice: Die[] }
    - Initialize usedRelationships: [] in START_CONFLICT

    Update `src/reducers/conflictReducer.ts`:
    - Handle USE_RELATIONSHIP:
      - Guard: only valid when phase is ACTIVE and currentTurn is PLAYER_RAISE or PLAYER_SEE
      - Guard: relationshipId must NOT be in usedRelationships
      - Add relationshipId to usedRelationships
      - Add dice (already rolled) to playerPool

    Update `src/components/Conflict/ConflictView.tsx`:
    - Import RelationshipDice
    - Render RelationshipDice alongside TraitInvocation during player's turn
    - Pass current conflict npcId, character relationships, and usedRelationships from conflict state
    - Only show if character has relationships
  </action>
  <verify>`npm run build` succeeds. During conflict, player can use relationships to add dice. Each relationship usable once per conflict.</verify>
  <done>Relationships provide dice during conflicts. Direct relationship with conflict NPC highlighted as relevant. Each relationship usable once per conflict. Relationship dice added to player pool.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run build` succeeds
- After conflict fallout (MINOR/SERIOUS/DEADLY): new trait appears in character
- Trait has correct die type (d4/d6/d8) based on severity
- Fallout reveal shows "gained trait" message
- During conflict: relationship dice panel shows relevant NPCs
- Using relationship adds its dice to player pool
- Each relationship usable only once per conflict
</verification>

<success_criteria>
- Fallout-to-trait: MINOR creates d4 trait, SERIOUS creates d6, DEADLY creates d8
- Trait names are thematically appropriate to fallout type (social/physical/violent/lethal)
- Relationship dice: relevant relationships shown during conflict
- One-use-per-conflict rule enforced for relationships
- Character's trait list grows as they take fallout (consequences accumulate)
</success_criteria>

<output>
After completion, create `.planning/phases/04-character-system/04-04-SUMMARY.md`
</output>
