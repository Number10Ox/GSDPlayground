---
phase: 04-character-system
plan: 05
type: execute
wave: 4
depends_on: ["04-04"]
files_modified:
  - e2e/features/character.feature
  - e2e/steps/character.steps.ts
  - e2e/character.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify character creation flow end-to-end"
    - "E2E tests verify stat-based dice pool generation"
    - "E2E tests verify trait invocation during conflict"
    - "E2E tests verify fallout-to-trait conversion"
  artifacts:
    - path: "e2e/features/character.feature"
      provides: "BDD feature file with Gherkin scenarios"
      min_lines: 40
    - path: "e2e/steps/character.steps.ts"
      provides: "Step helper functions for character tests"
      min_lines: 60
    - path: "e2e/character.spec.ts"
      provides: "Playwright test specs for character system"
      min_lines: 80
  key_links:
    - from: "e2e/character.spec.ts"
      to: "e2e/steps/character.steps.ts"
      via: "imports step helpers"
      pattern: "import.*from.*character.steps"
    - from: "e2e/steps/character.steps.ts"
      to: "e2e/features/character.feature"
      via: "implements Gherkin steps"
      pattern: "data-testid"
---

<objective>
Create E2E tests for the character system covering creation, stat-based pools, trait invocation, and fallout-to-trait conversion.

Purpose: Automated browser tests validate the full character system works end-to-end, catching integration issues between components. Follows the established BDD pattern from Phase 2.1.

Output: BDD feature file, step helpers, and Playwright specs for character system.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-character-system/04-01-SUMMARY.md
@.planning/phases/04-character-system/04-02-SUMMARY.md
@.planning/phases/04-character-system/04-03-SUMMARY.md
@.planning/phases/04-character-system/04-04-SUMMARY.md
@e2e/features/conflict.feature
@e2e/steps/conflict.steps.ts
@e2e/conflict.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BDD feature file and step helpers</name>
  <files>e2e/features/character.feature, e2e/steps/character.steps.ts</files>
  <action>
    Create `e2e/features/character.feature` with Gherkin scenarios:

    ```gherkin
    Feature: Character System
      As a Dog in the Vineyard
      I want to create and develop my character
      So that my stats, traits, and items affect gameplay

      Scenario: Character creation with point-buy
        Given I am on the game screen with no character
        When I enter my character name "Brother Ezekiel"
        And I select the "well-rounded" background
        And I allocate 5 dice to Acuity
        And I allocate 4 dice to Body
        And I allocate 4 dice to Heart
        And I allocate 4 dice to Will
        And I confirm character creation
        Then I should see my character name "Brother Ezekiel" in the sidebar
        And I should see 4 stats with dice counts

      Scenario: Stats affect dice pool
        Given I have a character with 4d6 Acuity and 3d6 Body
        When I start a new cycle
        Then the dice pool should contain dice from my stats

      Scenario: Trait invocation during conflict
        Given I have a character with trait "Quick Draw" (1d6)
        And I am in a conflict during my raise turn
        When I invoke the trait "Quick Draw"
        Then my conflict pool should increase
        And "Quick Draw" should show as used

      Scenario: Trait cannot be invoked twice
        Given I have already invoked "Quick Draw" this conflict
        When I try to invoke "Quick Draw" again
        Then the invoke button should be disabled

      Scenario: Fallout creates new trait
        Given I have completed a conflict with SERIOUS fallout
        Then I should see a new trait with source "fallout"
        And the new trait should have a d6 die

      Scenario: Inventory items visible
        Given I have a character with starting inventory
        Then I should see "Coat" with a d8 die
        And I should see "Gun" marked as a gun
        And I should see "Book of Life" with a d6 die
        And I should see "Sacred Earth (jar)" with a d6 die
    ```

    Create `e2e/steps/character.steps.ts` with helper functions:
    - `enterCharacterName(page, name)`: fill data-testid="creation-name-input"
    - `selectBackground(page, background)`: click data-testid="creation-background-{background}"
    - `allocateStatDice(page, statName, count)`: click plus/minus buttons to reach target
    - `confirmCreation(page)`: click data-testid="creation-confirm"
    - `verifyCharacterInSidebar(page, name)`: check data-testid="character-info" contains name
    - `verifyStatCount(page, statName, count)`: check data-testid="stat-{name}" shows count
    - `verifyDicePoolFromStats(page)`: verify pool has dice (at least some present)
    - `invokeTrait(page, traitName)`: click data-testid="invoke-trait-{id}" for matching trait
    - `verifyTraitUsed(page, traitName)`: check trait shows "Used" badge
    - `verifyNewFalloutTrait(page)`: check trait list has item with source "fallout"
    - `verifyInventoryItem(page, name, dieType)`: check data-testid="inventory-panel" for item
    - `setupCharacterForTest(page)`: helper that creates a default character quickly (for tests that need a character but aren't testing creation)
    - `triggerConflictForTest(page)`: helper that starts a conflict with dev-mode trigger (reuse pattern from 03-05)

    All step helpers follow the established pattern from Phase 2.1 and 3:
    - Use data-testid selectors
    - Use page.waitForSelector for async UI
    - Return void (assertions use expect inside)
  </action>
  <verify>Files created with correct syntax. No TypeScript errors in step helpers.</verify>
  <done>BDD feature file describes 6 character scenarios. Step helpers provide reusable functions for character E2E testing.</done>
</task>

<task type="auto">
  <name>Task 2: Playwright test specs</name>
  <files>e2e/character.spec.ts</files>
  <action>
    Create `e2e/character.spec.ts`:
    - Import test, expect from '@playwright/test'
    - Import step helpers from './steps/character.steps'
    - Use same test structure as conflict.spec.ts (describe blocks, beforeEach navigates to app)

    Implement tests for each scenario:

    1. "Character creation with point-buy":
       - Navigate to app
       - Verify creation UI shows (no character exists)
       - Enter name, select background, allocate stats
       - Confirm creation
       - Verify sidebar shows character data
       - Verify all four stats visible

    2. "Stats affect dice pool":
       - Create character with known stats
       - Start cycle
       - Verify dice pool has dice (count based on stats)

    3. "Trait invocation during conflict":
       - Create character (use setupCharacterForTest)
       - Add a test trait to character (may need dev-mode helper or manual dispatch)
       - Trigger conflict (use dev-mode trigger from Phase 3)
       - On player raise turn, invoke trait
       - Verify pool increased
       - Verify trait shows as used

    4. "Trait cannot be invoked twice":
       - Same setup as above
       - After invoking trait, verify invoke button disabled/hidden

    5. "Fallout creates new trait":
       - Create character
       - Trigger and complete conflict with fallout
       - Verify new trait appears in trait list

    6. "Inventory items visible":
       - Create character (gets starting inventory)
       - Open character sheet or check sidebar
       - Verify each item present with correct dice

    Use deterministic dice pools where needed (reuse dev-mode pattern from 03-05).
    Use generous timeouts for animations (fallout reveal has delays).
    Each test should be independent (beforeEach reloads page).
  </action>
  <verify>`npm run test:e2e -- --grep "Character"` runs tests. At least 4 of 6 tests pass (trait invocation tests may need debugging due to conflict setup complexity).</verify>
  <done>E2E test suite for character system with 6 tests covering creation, stats, traits, fallout, and inventory. Tests run via standard `npm run test:e2e` command.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (test files compile)
- `npm run test:e2e -- --grep "Character"` executes character tests
- Character creation test passes end-to-end
- Inventory visibility test passes
- Stats-to-pool test passes
- Total E2E suite (all phases): still runs without regression
</verification>

<success_criteria>
- BDD feature file with 6 Gherkin scenarios
- Step helpers following established project patterns (data-testid, page helpers)
- Playwright specs implementing all scenarios
- Tests validate: creation flow, stat-based pools, trait invocation, fallout traits, inventory display
- No regression in existing cycle/conflict E2E tests
</success_criteria>

<output>
After completion, create `.planning/phases/04-character-system/04-05-SUMMARY.md`
</output>
