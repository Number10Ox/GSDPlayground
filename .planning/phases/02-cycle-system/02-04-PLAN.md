---
phase: 02-cycle-system
plan: 04
type: execute
wave: 3
depends_on: ["02-01", "02-02", "02-03"]
files_modified:
  - src/types/game.ts
  - src/components/Actions/ActionCard.tsx
  - src/components/Actions/ActionList.tsx
  - src/components/Actions/index.ts
  - src/components/CycleSummary/CycleSummary.tsx
  - src/components/CycleSummary/index.ts
  - src/components/CycleView/CycleView.tsx
  - src/components/CycleView/index.ts
  - src/pages/GameView.tsx
  - src/hooks/useGameState.tsx
autonomous: false

must_haves:
  truths:
    - "Player can see available actions for current location"
    - "Player can assign dice to actions by clicking"
    - "Player can unassign dice by clicking on assigned dice"
    - "Player sees which dice are assigned to which actions"
    - "Player can confirm allocations and see results"
    - "Day ends when player confirms and resolves"
    - "Summary screen shows what happened during the cycle"
  artifacts:
    - path: "src/types/game.ts"
      provides: "GameAction interface for available actions"
      contains: "interface GameAction"
    - path: "src/components/Actions/ActionCard.tsx"
      provides: "Action card with dice slot display"
      min_lines: 40
    - path: "src/components/Actions/ActionList.tsx"
      provides: "Container for available actions"
      min_lines: 25
    - path: "src/components/CycleSummary/CycleSummary.tsx"
      provides: "End-of-cycle summary display"
      min_lines: 30
    - path: "src/components/CycleView/CycleView.tsx"
      provides: "Main cycle UI orchestration"
      min_lines: 60
    - path: "src/pages/GameView.tsx"
      provides: "Updated to show cycle UI based on phase"
      min_lines: 40
  key_links:
    - from: "src/components/CycleView/CycleView.tsx"
      to: "src/components/DicePool/DicePool.tsx"
      via: "DicePool render"
      pattern: "<DicePool"
    - from: "src/components/CycleView/CycleView.tsx"
      to: "src/components/Actions/ActionList.tsx"
      via: "ActionList render"
      pattern: "<ActionList"
    - from: "src/components/CycleView/CycleView.tsx"
      to: "src/hooks/useGameState.tsx"
      via: "useGameState hook"
      pattern: "useGameState"
    - from: "src/components/Actions/ActionCard.tsx"
      to: "src/components/DicePool/DieIcon.tsx"
      via: "Shows assigned dice icons"
      pattern: "DieIcon"
---

<objective>
Build the action allocation UI and integrate all cycle components into a playable daily loop.

Purpose: This is where the game becomes interactive. Players allocate their dice to meaningful actions, see the results, and experience the core gameplay loop that defines the Citizen Sleeper-inspired design.
Output: Complete cycle UI with dice pool, action cards, allocation flow, and summary screen.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-cycle-system/02-CONTEXT.md
@.planning/phases/02-cycle-system/02-RESEARCH.md

# Required from prior plans
@src/types/game.ts
@src/utils/dice.ts
@src/hooks/useGameState.tsx
@src/components/DicePool/DicePool.tsx
@src/components/Clocks/Clock.tsx
@src/pages/GameView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GameAction type and sample actions</name>
  <files>src/types/game.ts, src/hooks/useGameState.tsx</files>
  <action>
    Add GameAction interface to types/game.ts (rename if conflicts with existing GameAction union - use AvailableAction or CycleAction):

    ```typescript
    export interface AvailableAction {
      id: string;
      name: string;
      description: string;
      locationId: LocationId | null;  // null = available anywhere
      diceCost: number;               // 0 = free action (movement, observation)
      available: boolean;             // Requirements met?
      requirementHint?: string;       // "Requires: Talk to Sheriff first"
    }
    ```

    Update GameState to include availableActions:
    ```typescript
    availableActions: AvailableAction[];
    ```

    Add sample actions to initialState in useGameState.tsx:
    ```typescript
    const SAMPLE_ACTIONS: AvailableAction[] = [
      { id: 'investigate-chapel', name: 'Investigate the Chapel', description: 'Look for signs of what troubles this place', locationId: 'church', diceCost: 1, available: true },
      { id: 'talk-sheriff', name: 'Talk to the Sheriff', description: 'The law might know something', locationId: 'sheriffs-office', diceCost: 1, available: true },
      { id: 'search-store', name: 'Search the Store', description: 'Ezekiel seems nervous', locationId: 'general-store', diceCost: 2, available: true },
      { id: 'pray', name: 'Pray for Guidance', description: 'Seek wisdom from the King of Life', locationId: null, diceCost: 1, available: true },
      { id: 'rest-early', name: 'Rest Early', description: 'End the day and recover', locationId: null, diceCost: 0, available: true },
    ];
    ```
  </action>
  <verify>TypeScript compiles: `npm run build` passes</verify>
  <done>AvailableAction type exists, sample actions in state</done>
</task>

<task type="auto">
  <name>Task 2: Build ActionCard and ActionList components</name>
  <files>src/components/Actions/ActionCard.tsx, src/components/Actions/ActionList.tsx, src/components/Actions/index.ts</files>
  <action>
    Create ActionCard component:

    Props:
    - action: AvailableAction
    - assignedDice: Die[] (dice assigned to this action)
    - onAssign: () => void (called when player clicks to assign selected die)
    - onUnassign: (dieId: string) => void
    - isAvailable: boolean
    - hasSelectedDie: boolean (to show visual hint that clicking will assign)

    Visual structure:
    - Card with bg-surface-light rounded-lg p-4
    - Action name as h3 (text-lg font-semibold)
    - Description as text-sm text-gray-400
    - Dice cost indicator (e.g., "Cost: 1 die" or "Free")
    - Assigned dice displayed as row of small DieIcon components
    - If unavailable: opacity-50, cursor-not-allowed, show lock icon and requirementHint
    - If hasSelectedDie and available: subtle border highlight (border-amber-500/50)
    - Clicking an assigned die calls onUnassign to return it to pool

    Create ActionList component:

    Props:
    - actions: AvailableAction[]
    - dicePool: Die[]
    - selectedDieId: string | null
    - onAssign: (actionId: string) => void
    - onUnassign: (dieId: string) => void

    Layout:
    - Vertical flex with gap-3
    - Filter actions by current location OR locationId: null
    - Pass assignedDice by filtering dicePool where assignedTo === action.id

    Create index.ts barrel export.
  </action>
  <verify>TypeScript compiles: `npm run build` passes</verify>
  <done>ActionCard shows action details and assigned dice, ActionList renders filtered actions</done>
</task>

<task type="auto">
  <name>Task 3: Build CycleSummary component</name>
  <files>src/components/CycleSummary/CycleSummary.tsx, src/components/CycleSummary/index.ts</files>
  <action>
    Create CycleSummary component for end-of-cycle display:

    Props:
    - cycleNumber: number
    - actionsCompleted: { action: AvailableAction; diceUsed: Die[]; result: string }[]
    - clockChanges: { clock: Clock; advanced: number }[]
    - onContinue: () => void

    Visual structure:
    - Modal overlay with bg-black/70 backdrop
    - Centered card with bg-surface max-w-lg rounded-lg p-6
    - Title: "End of Day {cycleNumber}"
    - Section: "Actions Taken" - list each action with dice used
    - Section: "Clocks Advanced" - show which clocks ticked (if any)
    - If no actions: "You rested the entire day"
    - "Continue" button that calls onContinue (transitions to WAKE)

    Use Framer Motion for fade-in animation (AnimatePresence + motion.div).

    For now, actionsCompleted can be derived from dice assignments, results can be placeholder strings like "You investigated..." - actual outcome logic is Phase 3+ territory.
  </action>
  <verify>TypeScript compiles: `npm run build` passes</verify>
  <done>CycleSummary displays end-of-cycle information with continue button</done>
</task>

<task type="auto">
  <name>Task 4: Build CycleView orchestration component</name>
  <files>src/components/CycleView/CycleView.tsx, src/components/CycleView/index.ts</files>
  <action>
    Create CycleView component that orchestrates the cycle UI based on phase:

    Uses useGameState() to get state and dispatch.

    Renders based on cyclePhase:

    WAKE phase:
    - "Day {cycleNumber} begins" message
    - "Start Day" button that dispatches START_CYCLE

    ALLOCATE phase:
    - DicePool at bottom showing unassigned dice
    - ActionList showing available actions for current location
    - ClockList showing active clocks (for awareness)
    - "Confirm Allocations" button (disabled if no dice assigned)
    - "Rest Early" button (always available)

    RESOLVE phase:
    - For now: immediately transition to SUMMARY
    - Dispatch VIEW_SUMMARY (actual resolution mechanics are Phase 3)

    SUMMARY phase:
    - Render CycleSummary overlay
    - On continue: dispatch END_CYCLE

    REST phase:
    - Brief rest message
    - Auto-transition to WAKE (or just show "Next Day" button)

    Wrap DicePool and ActionList in LayoutGroup from Framer Motion for dice animation.

    Handle dice selection flow:
    - Pass selectedDieId to DicePool
    - Pass onSelect that dispatches SELECT_DIE
    - Pass onAssign to ActionList that dispatches ASSIGN_DIE with action id
    - Pass onUnassign that dispatches UNASSIGN_DIE

    Create index.ts barrel export.
  </action>
  <verify>TypeScript compiles: `npm run build` passes</verify>
  <done>CycleView renders appropriate UI for each cycle phase</done>
</task>

<task type="auto">
  <name>Task 5: Integrate CycleView into GameView</name>
  <files>src/pages/GameView.tsx</files>
  <action>
    Update GameView to incorporate the cycle system:

    Layout changes:
    - Keep node map in background
    - Overlay CycleView when in cycle phases
    - During ALLOCATE: show DicePool as fixed bottom bar, ActionList as slide-out panel or overlay

    Suggested layout approach:
    ```tsx
    <div className="grid grid-cols-[1fr_280px] h-screen gap-4 p-4 bg-background">
      <main className="relative overflow-hidden bg-surface rounded-lg">
        {/* Node map always visible */}
        <div className="absolute inset-0 flex items-center justify-center">
          <NodeMap />
        </div>

        {/* Cycle UI overlays */}
        <CycleView />

        {/* Narrative panel (existing) */}
        <NarrativePanel />
      </main>

      <aside className="flex flex-col gap-4">
        <CharacterInfo />
        {/* Show clocks in sidebar */}
        <ClockList clocks={state.clocks} />
        {/* Location info */}
        ...
      </aside>
    </div>
    ```

    The CycleView handles its own positioning based on phase:
    - WAKE: centered overlay
    - ALLOCATE: DicePool fixed at bottom, ActionList as a panel
    - SUMMARY: full overlay

    This task focuses on integration, not redesigning the entire layout. Keep existing components working.
  </action>
  <verify>
    1. TypeScript compiles: `npm run build`
    2. Manual test: Load app, see WAKE phase, click Start Day, see dice pool and actions
    3. Manual test: Select die, click action, die moves to action card
    4. Manual test: Click assigned die, returns to pool
    5. Manual test: Confirm allocations, see summary, continue to next day
  </verify>
  <done>GameView displays cycle UI, full allocation flow works</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete cycle system with dice allocation, actions, and summary</what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:5173
    2. See "Day 1 begins" message with Start Day button
    3. Click Start Day - dice pool appears at bottom with 3-5 dice
    4. Click a die - it becomes selected (amber ring)
    5. Click an action - die moves to that action's card
    6. Click the die on the action - it returns to pool
    7. Assign at least one die, click "Confirm Allocations"
    8. See summary screen showing actions taken
    9. Click Continue - Day 2 begins
    10. Verify clocks are visible in sidebar
    11. Test keyboard: Tab to dice pool, arrow keys to navigate, Enter to select
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the cycle flow</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Full cycle flow: WAKE -> START_CYCLE -> ALLOCATE -> CONFIRM -> RESOLVE -> SUMMARY -> END_CYCLE -> WAKE
3. Dice can be selected, assigned to actions, and unassigned
4. Summary shows what happened during the cycle
5. Cycle number increments correctly
6. Clocks are visible and auto-advance at end of cycle
7. Keyboard navigation works for dice selection
</verification>

<success_criteria>
- Player experiences complete daily cycle from wake to rest
- Player sees dice values before deciding allocation
- Player can allocate dice to available actions
- Clocks visually advance when conditions met
- Day ends when dice exhausted or player rests
- Requirements CYCLE-01, CYCLE-02, CYCLE-03, CYCLE-04, UI-03 are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-cycle-system/02-04-SUMMARY.md`
</output>
