---
phase: 02.1-e2e-testing
plan: 02
type: execute
wave: 2
depends_on: ["02.1-01"]
files_modified:
  - e2e/features/cycle.feature
  - e2e/steps/cycle.steps.ts
  - e2e/cycle-flow.spec.ts
  - src/components/DicePool/DieComponent.tsx
  - src/components/Actions/ActionCard.tsx
  - src/components/CycleSummary/CycleSummary.tsx
autonomous: true

must_haves:
  truths:
    - "E2E tests validate the complete Day 1 cycle flow"
    - "Tests can select dice, assign to actions, and confirm"
    - "Tests verify phase transitions (WAKE -> ALLOCATE -> SUMMARY -> REST)"
    - "Feature files describe behavior in human-readable Gherkin syntax"
  artifacts:
    - path: "e2e/features/cycle.feature"
      provides: "BDD specification for cycle system"
      contains: "Scenario"
    - path: "e2e/cycle-flow.spec.ts"
      provides: "Full cycle flow integration test"
      contains: "test.describe"
    - path: "e2e/steps/cycle.steps.ts"
      provides: "Reusable step definitions"
      exports: ["startDay", "selectDie", "assignDieToAction", "confirmAllocations"]
  key_links:
    - from: "e2e/cycle-flow.spec.ts"
      to: "src/components/CycleView/CycleView.tsx"
      via: "data-testid selectors"
      pattern: "getByTestId"
    - from: "e2e/steps/cycle.steps.ts"
      to: "e2e/cycle-flow.spec.ts"
      via: "step function imports"
      pattern: "import.*from.*steps"
---

<objective>
Create BDD feature files and E2E tests validating the Phase 2 cycle system gameplay flow.

Purpose: Automated browser tests ensure cycle mechanics work as players expect
Output: Passing E2E tests for wake, allocate, confirm, summary, and next day flow
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/02.1-e2e-testing/02.1-01-SUMMARY.md

# What we're testing
@src/components/CycleView/CycleView.tsx
@src/types/game.ts
@src/hooks/useGameState.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add data-testid to remaining components</name>
  <files>src/components/DicePool/DieComponent.tsx, src/components/Actions/ActionCard.tsx, src/components/CycleSummary/CycleSummary.tsx</files>
  <action>
Add data-testid attributes to components that E2E tests need to interact with:

DieComponent.tsx:
- data-testid="die" on the die button
- data-testid="die-{id}" using the die's unique ID (for targeting specific dice)
- data-die-type="{type}" attribute for d4/d6/d8/d10
- data-die-value="{value}" attribute for the rolled value
- data-selected="true|false" based on isSelected prop

ActionCard.tsx:
- data-testid="action-card" on the card container
- data-testid="action-{id}" using action's unique ID
- data-testid="assign-die-button" on the assign button (the clickable area when die is selected)
- data-testid="assigned-die-{dieId}" on each assigned die shown in the card

CycleSummary.tsx:
- data-testid="cycle-summary-overlay" on the overlay container
- data-testid="cycle-summary-title" on the title
- data-testid="action-result" on each action result item
- data-testid="continue-button" on the Continue button
  </action>
  <verify>
```bash
grep -r "data-testid" src/components/DicePool/DieComponent.tsx
grep -r "data-testid" src/components/Actions/ActionCard.tsx
grep -r "data-testid" src/components/CycleSummary/CycleSummary.tsx
```
All should show testid attributes.
  </verify>
  <done>All interactive components have data-testid for E2E targeting</done>
</task>

<task type="auto">
  <name>Task 2: Create BDD feature file and step definitions</name>
  <files>e2e/features/cycle.feature, e2e/steps/cycle.steps.ts</files>
  <action>
Create e2e/features/cycle.feature with Gherkin scenarios:

```gherkin
Feature: Daily Cycle System
  As a Dog visiting a troubled town
  I want to allocate my dice to actions each day
  So that I can investigate and resolve the town's problems

  Background:
    Given I am on Day 1 at Bridal Falls

  Scenario: Starting a new day
    When I click "Start Day"
    Then I should see my dice pool
    And I should see the available actions

  Scenario: Allocating dice to an action
    Given I have started the day
    When I select a die from my pool
    And I click on the "Investigate the Chapel" action
    Then the die should be assigned to that action
    And the die should no longer appear in my pool

  Scenario: Confirming allocations
    Given I have assigned dice to actions
    When I click "Confirm Allocations"
    Then I should see the cycle summary
    And the summary should show what I accomplished

  Scenario: Completing the cycle
    Given I am viewing the cycle summary
    When I click "Continue"
    Then I should see "Night Falls"
    When I click "Next Day"
    Then I should be on Day 2
```

Create e2e/steps/cycle.steps.ts with reusable step functions (NOT cucumber-style, just helper functions):

```typescript
import { Page, expect } from '@playwright/test';

export async function navigateToGame(page: Page) {
  await page.goto('/');
}

export async function startDay(page: Page) {
  await page.getByTestId('start-day-button').click();
}

export async function selectFirstAvailableDie(page: Page) {
  const die = page.getByTestId('die').first();
  await die.click();
  return die;
}

export async function assignDieToAction(page: Page, actionName: string) {
  // Find action card containing the action name and click it
  const actionCard = page.locator('[data-testid^="action-"]', { hasText: actionName });
  await actionCard.click();
}

export async function confirmAllocations(page: Page) {
  await page.getByTestId('confirm-allocations-button').click();
}

export async function continuePastSummary(page: Page) {
  await page.getByTestId('continue-button').click();
}

export async function goToNextDay(page: Page) {
  await page.getByTestId('next-day-button').click();
}

export async function expectDayNumber(page: Page, day: number) {
  await expect(page.getByTestId('day-number')).toContainText(`Day ${day}`);
}

export async function expectDicePoolVisible(page: Page) {
  await expect(page.getByTestId('dice-pool')).toBeVisible();
}

export async function expectActionPanelVisible(page: Page) {
  await expect(page.getByTestId('action-panel')).toBeVisible();
}

export async function expectCycleSummaryVisible(page: Page) {
  await expect(page.getByTestId('cycle-summary-overlay')).toBeVisible();
}
```
  </action>
  <verify>
```bash
cat e2e/features/cycle.feature | head -20
cat e2e/steps/cycle.steps.ts | head -30
```
Both files exist with Gherkin scenarios and step helpers.
  </verify>
  <done>BDD feature file documents cycle behavior, step definitions provide reusable test helpers</done>
</task>

<task type="auto">
  <name>Task 3: Create full cycle flow E2E test</name>
  <files>e2e/cycle-flow.spec.ts</files>
  <action>
Create e2e/cycle-flow.spec.ts that tests the complete cycle flow:

```typescript
import { test, expect } from './fixtures/base';
import {
  navigateToGame,
  startDay,
  selectFirstAvailableDie,
  assignDieToAction,
  confirmAllocations,
  continuePastSummary,
  goToNextDay,
  expectDayNumber,
  expectDicePoolVisible,
  expectActionPanelVisible,
  expectCycleSummaryVisible,
} from './steps/cycle.steps';

test.describe('Cycle System', () => {

  test.beforeEach(async ({ page }) => {
    await navigateToGame(page);
  });

  test('starts on Day 1 with wake overlay', async ({ page }) => {
    await expect(page.getByTestId('cycle-wake-overlay')).toBeVisible();
    await expectDayNumber(page, 1);
  });

  test('clicking Start Day shows dice pool and actions', async ({ page }) => {
    await startDay(page);
    await expectDicePoolVisible(page);
    await expectActionPanelVisible(page);
  });

  test('can select a die and assign to action', async ({ page }) => {
    await startDay(page);

    // Count dice before
    const diceCountBefore = await page.getByTestId('die').count();
    expect(diceCountBefore).toBeGreaterThan(0);

    // Select first die
    await selectFirstAvailableDie(page);

    // Assign to an action
    await assignDieToAction(page, 'Investigate the Chapel');

    // Dice pool should have one fewer die
    const diceCountAfter = await page.getByTestId('die').count();
    expect(diceCountAfter).toBe(diceCountBefore - 1);
  });

  test('confirm button disabled without assigned dice', async ({ page }) => {
    await startDay(page);

    const confirmButton = page.getByTestId('confirm-allocations-button');
    await expect(confirmButton).toBeDisabled();
  });

  test('confirm button enabled after assigning dice', async ({ page }) => {
    await startDay(page);
    await selectFirstAvailableDie(page);
    await assignDieToAction(page, 'Pray for Guidance');

    const confirmButton = page.getByTestId('confirm-allocations-button');
    await expect(confirmButton).toBeEnabled();
  });

  test('confirming allocations shows cycle summary', async ({ page }) => {
    await startDay(page);
    await selectFirstAvailableDie(page);
    await assignDieToAction(page, 'Pray for Guidance');
    await confirmAllocations(page);

    await expectCycleSummaryVisible(page);
  });

  test('full cycle: Day 1 -> allocate -> summary -> Day 2', async ({ page }) => {
    // Day 1 wake
    await expectDayNumber(page, 1);
    await startDay(page);

    // Allocate dice
    await selectFirstAvailableDie(page);
    await assignDieToAction(page, 'Talk to the Sheriff');
    await confirmAllocations(page);

    // Summary
    await expectCycleSummaryVisible(page);
    await continuePastSummary(page);

    // Rest phase -> Next Day
    await expect(page.getByTestId('cycle-rest-overlay')).toBeVisible();
    await goToNextDay(page);

    // Day 2
    await expectDayNumber(page, 2);
  });

  test('rest early skips directly to summary', async ({ page }) => {
    await startDay(page);
    await page.getByTestId('rest-early-button').click();

    await expectCycleSummaryVisible(page);
  });

});
```

Remove the example.spec.ts file since we now have real tests.
  </action>
  <verify>
```bash
npm run test:e2e
```
All cycle flow tests should pass.
  </verify>
  <done>Full E2E test suite passes, validating complete cycle flow from Day 1 through Day 2</done>
</task>

</tasks>

<verification>
Run full test suite and check coverage:

```bash
# All tests pass
npm run test:e2e

# Verify feature file exists
test -f e2e/features/cycle.feature && echo "Feature file exists"

# Count test cases
grep -c "test(" e2e/cycle-flow.spec.ts
```

Expected: All tests pass, feature file exists, 8+ test cases.
</verification>

<success_criteria>
1. All data-testid attributes added to DieComponent, ActionCard, CycleSummary
2. e2e/features/cycle.feature documents cycle behavior in Gherkin
3. e2e/steps/cycle.steps.ts provides reusable step functions
4. e2e/cycle-flow.spec.ts contains full cycle flow tests
5. npm run test:e2e passes all tests
6. Tests cover: wake, allocate, assign dice, confirm, summary, rest, next day
</success_criteria>

<output>
After completion, create `.planning/phases/02.1-e2e-testing/02.1-02-SUMMARY.md`
</output>
