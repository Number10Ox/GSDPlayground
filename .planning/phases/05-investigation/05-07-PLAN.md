---
phase: 05-investigation
plan: 07
type: execute
wave: 4
depends_on: ["05-06"]
files_modified:
  - e2e/features/investigation.feature
  - e2e/steps/investigation.steps.ts
  - e2e/investigation.spec.ts
  - e2e/fixtures/dialogue-recordings.json
  - src/pages/GameView.tsx
autonomous: true

must_haves:
  truths:
    - "E2E tests verify dialogue flow without calling real LLM"
    - "Tests cover topic selection, approach selection, and response display"
    - "Tests verify mental map updates after discoveries"
    - "Tests verify fatigue clock prevents excess conversations"
    - "Tests verify sin escalation advances on cycle end"
  artifacts:
    - path: "e2e/features/investigation.feature"
      provides: "BDD Gherkin scenarios for investigation system"
      min_lines: 50
    - path: "e2e/steps/investigation.steps.ts"
      provides: "Step helper functions for investigation E2E tests"
      exports: ["startConversation", "selectTopic", "selectApproach", "waitForResponse", "closeDiscovery", "openMentalMap", "verifyFatigue", "advanceCycle"]
    - path: "e2e/investigation.spec.ts"
      provides: "Playwright test specs implementing investigation scenarios"
      min_lines: 80
    - path: "e2e/fixtures/dialogue-recordings.json"
      provides: "Deterministic mock dialogue responses for E2E tests"
  key_links:
    - from: "e2e/investigation.spec.ts"
      to: "e2e/steps/investigation.steps.ts"
      via: "Step helpers for readable test code"
      pattern: "import.*investigation.steps"
    - from: "e2e/investigation.spec.ts"
      to: "e2e/fixtures/dialogue-recordings.json"
      via: "Route interception replays recorded responses"
      pattern: "page\\.route.*api/dialogue"
---

<objective>
Create E2E tests for the investigation system using mocked LLM responses.

Purpose: Per project convention (Phase 2.1 established pattern), each phase concludes with comprehensive E2E tests. Investigation tests must be deterministic despite the LLM-backed dialogue system, using VCR-style mocked responses. Tests verify the UI flow and game mechanics, not AI quality.

Output: BDD feature file, step helpers, Playwright specs, and mock dialogue fixtures enabling deterministic E2E testing of the full investigation loop.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-06-SUMMARY.md
@e2e/features
@e2e/steps/cycle.steps.ts
@e2e/steps/conflict.steps.ts
@e2e/steps/character.steps.ts
@e2e/character.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mock dialogue fixtures and BDD feature file</name>
  <files>e2e/fixtures/dialogue-recordings.json, e2e/features/investigation.feature, e2e/steps/investigation.steps.ts</files>
  <action>
Create `e2e/fixtures/dialogue-recordings.json`:
- Deterministic responses keyed by { npcId, topic, approach } combinations
- Cover the test town NPCs and their available topics:
  - sister-martha + "greeting" + "heart" -> "[Player]: Sister Martha, how are you feeling?\n[NPC]: Brother, the Lord tests us with affliction. I am... managing."
  - sister-martha + "the-town" + "acuity" -> "[Player]: I notice tension in the town, Sister.\n[NPC]: You've eyes to see, Brother. The Steward's word weighs heavy on us all.\n[DISCOVERY: fact-steward-decree|sin-injustice|The Steward has been making harsh decrees]"
  - brother-thomas + "the-town" + "heart" -> "[Player]: How fares your family, Brother Thomas?\n[NPC]: We endure, Brother. But Sister Martha... she needs medicine the Steward won't provide.\n[DISCOVERY: fact-martha-illness|sin-injustice|Martha is being denied care]"
  - steward-ezekiel + "the-town" + "will" -> "[Player]: Steward, I come with the authority of the Faith.\n[NPC]: Brother, you're welcome here. Our town walks the path of righteousness, as I guide them.\n[DISCOVERY: fact-steward-pride|sin-pride|The Steward believes only he knows God's will]"
  - sheriff-jacob + "greeting" + "body" -> "[Player]: Sheriff. I need to understand what's happening here.\n[NPC]: You Dogs ride in thinking you own the place. Talk to the Steward. He keeps the peace."
  - Include 10-15 total recordings covering key discovery paths
- Each recording is a complete text string (not streamed for simplicity in mocks)

Create `e2e/features/investigation.feature`:
```gherkin
Feature: Investigation System
  As a Dog arriving in a town
  I want to talk to NPCs and discover the sin progression
  So that I can address the root of the town's problems

  Background:
    Given the player has created a character
    And the investigation has started with the test town

  Scenario: Player starts a conversation with an NPC
    When the player clicks on Sister Martha
    Then the dialogue view should open
    And topic chips should be visible
    And the fatigue clock should show 0/6

  Scenario: Player selects topic and approach
    Given the player is in conversation with Sister Martha
    When the player selects the "the-town" topic
    Then approach chips should be visible
    When the player selects the "acuity" approach
    Then the dialogue text should appear
    And the fatigue clock should show 1/6

  Scenario: Player discovers a sin connection
    Given the player is in conversation with Sister Martha
    When the player completes a conversation about "the-town" with "acuity"
    Then the discovery summary should appear
    And the discovery should mention "Steward"

  Scenario: Mental map updates after discovery
    Given the player has discovered "injustice" sin
    When the player opens the mental map
    Then the "injustice" sin node should be visible
    And the sin node should not show "???"

  Scenario: Fatigue prevents extra conversations
    Given the player has used all 6 fatigue segments
    When the player clicks on an NPC
    Then the dialogue view should not open
    And a fatigue warning should appear

  Scenario: Sin escalation advances on cycle end
    Given the investigation has started
    When the player ends the cycle
    Then the sin progression should advance
    And a new sin node should appear in the chain

  Scenario: Conflict triggers from aggressive approach
    Given the player is in conversation with Sheriff Jacob
    When the player selects a "body" approach on a confrontational topic
    Then a conflict should trigger
    And the conflict view should appear
```

Create `e2e/steps/investigation.steps.ts`:
Step helper functions (following existing pattern from cycle.steps.ts/conflict.steps.ts):
- `startConversation(page, npcId)`: clicks NPC button, waits for dialogue view
- `selectTopic(page, topicId)`: clicks topic chip, waits for approach chips
- `selectApproach(page, approach)`: clicks approach chip, waits for response
- `waitForResponse(page)`: waits for dialogue-text to have content
- `closeDiscovery(page)`: clicks continue in discovery summary
- `endConversation(page)`: clicks leave conversation button
- `openMentalMap(page)`: clicks mental map button, waits for map render
- `closeMentalMap(page)`: clicks close on mental map overlay
- `verifyFatigue(page, current, max)`: checks fatigue clock data attributes
- `advanceCycle(page)`: triggers cycle end via existing cycle step helpers
- `createCharacterForTest(page)`: creates character with deterministic stats (reuse from character.steps.ts if possible)
- `startInvestigation(page)`: clicks dev-mode "Start Investigation" button
- `verifyDiscovery(page, text)`: checks discovery summary contains text
- `verifySinNodeVisible(page, level)`: checks mental map sin node
- `triggerConflict(page)`: selects body/will approach on resistant NPC
  </action>
  <verify>Run `npx tsc --noEmit` on step file. Verify feature file has 7 scenarios covering INV-01 through INV-04 requirements. Verify fixture file has 10+ dialogue recordings.</verify>
  <done>Mock fixtures provide deterministic dialogue, feature file covers all investigation scenarios, step helpers abstract common test operations.</done>
</task>

<task type="auto">
  <name>Task 2: Playwright test specs with route interception</name>
  <files>e2e/investigation.spec.ts, src/pages/GameView.tsx</files>
  <action>
Create `e2e/investigation.spec.ts`:
- Import test, expect from '@playwright/test'
- Import step helpers from './steps/investigation.steps'
- Import dialogue recordings fixture

Setup: beforeEach hook:
1. Set up route interception: `page.route('**/api/dialogue', ...)` that reads request body, looks up response in recordings fixture by {npcId, topic, approach} key, returns recorded response
2. Navigate to app, wait for load
3. Create character (using existing character creation flow or dev-mode shortcut)
4. Start investigation (click dev-mode button or ensure auto-start)

Test specs implementing each BDD scenario:

```typescript
test.describe('Investigation System', () => {
  test('player can start conversation with NPC', async ({ page }) => {
    await startConversation(page, 'sister-martha');
    await expect(page.getByTestId('dialogue-view')).toBeVisible();
    await expect(page.getByTestId('topic-chip-greeting')).toBeVisible();
    await verifyFatigue(page, 0, 6);
  });

  test('player selects topic then approach', async ({ page }) => {
    await startConversation(page, 'sister-martha');
    await selectTopic(page, 'the-town');
    await expect(page.getByTestId('approach-chip-acuity')).toBeVisible();
    await selectApproach(page, 'acuity');
    await waitForResponse(page);
    await expect(page.getByTestId('dialogue-text')).not.toBeEmpty();
    await verifyFatigue(page, 1, 6);
  });

  test('discovery appears after revealing conversation', async ({ page }) => {
    await startConversation(page, 'sister-martha');
    await selectTopic(page, 'the-town');
    await selectApproach(page, 'acuity');
    await waitForResponse(page);
    await expect(page.getByTestId('discovery-summary')).toBeVisible();
    await verifyDiscovery(page, 'Steward');
  });

  test('mental map updates with discovered sins', async ({ page }) => {
    // Discover a sin first
    await startConversation(page, 'sister-martha');
    await selectTopic(page, 'the-town');
    await selectApproach(page, 'acuity');
    await waitForResponse(page);
    await closeDiscovery(page);
    await endConversation(page);

    // Check mental map
    await openMentalMap(page);
    await verifySinNodeVisible(page, 'injustice');
  });

  test('fatigue prevents conversations when exhausted', async ({ page }) => {
    // Exhaust fatigue (6 conversations)
    for (let i = 0; i < 6; i++) {
      await startConversation(page, 'sister-martha');
      await selectTopic(page, 'greeting');
      await selectApproach(page, 'heart');
      await waitForResponse(page);
      if (page.getByTestId('discovery-summary').isVisible()) {
        await closeDiscovery(page);
      }
      await endConversation(page);
    }

    // Try one more - should be blocked
    await page.getByTestId('npc-button-sister-martha').click();
    await expect(page.getByTestId('dialogue-view')).not.toBeVisible();
    await verifyFatigue(page, 6, 6);
  });

  test('sin escalation on cycle end', async ({ page }) => {
    // End the cycle
    await advanceCycle(page);
    // Verify sin advanced (check mental map or state)
    await openMentalMap(page);
    // New sin node should exist beyond initial chain
  });

  test('aggressive approach can trigger conflict', async ({ page }) => {
    await startConversation(page, 'sheriff-jacob');
    await selectTopic(page, 'the-town');
    await selectApproach(page, 'body');
    // In test mode, conflict should trigger deterministically
    await expect(page.getByTestId('conflict-trigger')).toBeVisible();
  });
});
```

Update `src/pages/GameView.tsx` if needed:
- Ensure dev-mode "Start Investigation" button has data-testid="start-investigation"
- Ensure fatigue warning message has data-testid="fatigue-warning"
- Ensure all interactive elements needed by E2E have proper data-testid attributes
  </action>
  <verify>Run `npm run test:e2e` and verify tests execute (some may need debugging for timing). At minimum `npx tsc --noEmit` must pass. Verify route interception correctly returns mock responses.</verify>
  <done>7 E2E tests covering conversation flow, discovery, mental map, fatigue, sin escalation, and conflict triggering. All using mocked LLM responses for deterministic execution.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run test:e2e` executes investigation tests (target: all passing)
- Route interception prevents any real API calls during tests
- Tests are deterministic (no random LLM responses)
- Feature file scenarios map to requirements INV-01 through INV-04
- Step helpers are reusable for future test additions
</verification>

<success_criteria>
- 7 Playwright tests covering investigation requirements
- All tests pass deterministically via mocked dialogue responses
- No real LLM API calls during testing (verified by route interception)
- BDD feature file readable as specification
- Step helpers follow established project pattern (matching cycle.steps.ts, conflict.steps.ts)
- Total E2E suite: 30 tests (23 existing + 7 investigation)
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-07-SUMMARY.md`
</output>
