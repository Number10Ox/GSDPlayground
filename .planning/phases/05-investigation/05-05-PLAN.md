---
phase: 05-investigation
plan: 05
type: execute
wave: 3
depends_on: ["05-03"]
files_modified:
  - src/components/Dialogue/ConflictTrigger.tsx
  - src/components/FatigueClock/FatigueClock.tsx
  - src/components/Resolution/ResolutionSummary.tsx
  - src/reducers/investigationReducer.ts
autonomous: true

must_haves:
  truths:
    - "Fatigue clock fills as player has conversations each cycle"
    - "Cycle ends when fatigue clock is full (player forced to rest)"
    - "Body/Will approaches can trigger conflict with resistant NPCs"
    - "Town is resolved when root sin (Pride) is addressed"
    - "Resolution summary shows what happened to each NPC"
  artifacts:
    - path: "src/components/FatigueClock/FatigueClock.tsx"
      provides: "SVG circular progress showing fatigue segments"
      exports: ["FatigueClock"]
    - path: "src/components/Dialogue/ConflictTrigger.tsx"
      provides: "Approach-triggered conflict escalation from dialogue"
      exports: ["ConflictTrigger"]
    - path: "src/components/Resolution/ResolutionSummary.tsx"
      provides: "End-of-town summary showing NPC outcomes"
      exports: ["ResolutionSummary"]
  key_links:
    - from: "src/components/FatigueClock/FatigueClock.tsx"
      to: "src/hooks/useInvestigation.tsx"
      via: "Reads fatigueClock state for display"
      pattern: "useInvestigation.*fatigueClock"
    - from: "src/components/Dialogue/ConflictTrigger.tsx"
      to: "src/types/npc.ts"
      via: "Checks NPC conflictThresholds for approach resistance"
      pattern: "conflictThresholds.*resistChance"
    - from: "src/components/Resolution/ResolutionSummary.tsx"
      to: "src/hooks/useInvestigation.tsx"
      via: "Reads sinProgression resolved status and NPC outcomes"
      pattern: "sinProgression.*townResolved"
---

<objective>
Build the fatigue clock, conflict triggering from dialogue, and town resolution summary.

Purpose: These three mechanics complete the investigation loop: fatigue limits how much the player can learn per cycle (forcing strategic choices), aggressive approaches risk combat (connecting dialogue to the existing conflict system), and resolution provides closure when the player addresses the root sin.

Output: Fatigue clock component, conflict escalation from Body/Will approaches, and resolution summary screen.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-RESEARCH.md
@.planning/phases/05-investigation/05-01-SUMMARY.md
@.planning/phases/05-investigation/05-03-SUMMARY.md
@src/types/investigation.ts
@src/types/dialogue.ts
@src/types/npc.ts
@src/hooks/useInvestigation.tsx
@src/reducers/conflictReducer.ts
@src/components/Clocks/ClockList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fatigue clock component and conflict trigger</name>
  <files>src/components/FatigueClock/FatigueClock.tsx, src/components/Dialogue/ConflictTrigger.tsx</files>
  <action>
Create `src/components/FatigueClock/FatigueClock.tsx`:
- Props: current: number, max: number
- SVG-based circular progress clock (similar to existing Clock component pattern):
  - viewBox="0 0 120 120", circle at center (60,60), radius 50
  - Background circle: stroke="#333", strokeWidth=8, fill="none"
  - Progress circle: strokeDasharray/strokeDashoffset pattern, rotated -90deg to start at top
  - Color: blue (#3498db) when current < max, red (#e74c3c) when current >= max (exhausted)
  - Segment markers: thin white lines at each segment boundary (divide 360 by max)
  - Center text: "{current}/{max}" in white, bold
  - Smooth transition on strokeDashoffset (0.3s ease)
- When current >= max: add subtle pulse animation (opacity 0.7-1.0 at 1s interval) to indicate exhaustion
- data-testid="fatigue-clock"
- data-fatigue-current={current} and data-fatigue-max={max} for E2E

Create `src/components/Dialogue/ConflictTrigger.tsx`:
- Props: npcId: string, approach: ApproachType, onConflictStart: (npcId: string, stakes: string) => void
- Logic:
  1. Only Body and Will approaches can trigger conflicts (Acuity/Heart never trigger)
  2. Check NPC's conflictThresholds for the given approach
  3. Roll against resistChance (Math.random() < threshold.resistChance)
  4. If triggered: show brief warning text ("They won't stand for this...") with 1s delay, then call onConflictStart
  5. If not triggered: do nothing (dialogue continues normally)
- In dev mode (import.meta.env.DEV): always trigger if a special test NPC flag is set (for deterministic E2E tests)
- Component renders: a brief animated text that appears between approach selection and streaming response when conflict is about to trigger
- Framer motion: text fades in, holds 1s, then triggers conflict transition
- data-testid="conflict-trigger"
- The onConflictStart callback should integrate with existing conflict system (dispatch START_GAME_CONFLICT to game state, initialize ConflictState)
  </action>
  <verify>Run `npx tsc --noEmit`. Verify FatigueClock renders SVG with correct segment math. Verify ConflictTrigger only fires for Body/Will approaches.</verify>
  <done>Fatigue clock shows circular progress with segment markers, turns red at max. Conflict trigger checks NPC thresholds and escalates Body/Will approaches probabilistically.</done>
</task>

<task type="auto">
  <name>Task 2: Resolution summary and sin escalation</name>
  <files>src/components/Resolution/ResolutionSummary.tsx, src/reducers/investigationReducer.ts</files>
  <action>
Update `src/reducers/investigationReducer.ts` to add sin escalation logic:
- Add new action type: ADVANCE_SIN_PROGRESSION
  - Called at end of each cycle (time pressure mechanic)
  - Finds the highest-severity unresolved sin, advances to next level if not at 'hate-and-murder'
  - Creates a new SinNode at the next level (with generated id, empty linkedNpcs initially)
  - If sin reaches 'hate-and-murder': triggers a flag (sinEscalatedToMurder: boolean on state) indicating tragedy
- Add CONFRONT_SIN action type:
  - Player confronts an NPC about a specific sin (during dialogue with confrontational approach)
  - Marks sin as 'confronted' (intermediate status before resolved)
  - Resolution logic: if the confronted sin is 'pride' (root), dispatch MARK_TOWN_RESOLVED
  - Even imperfect confrontation counts (DitV: the Dog IS the authority)
- Add to InvestigationState: sinEscalatedToMurder: boolean (default false)

Create `src/components/Resolution/ResolutionSummary.tsx`:
- Props: none (reads from useInvestigation and useNPCMemory)
- Full-screen overlay (z-50) with dark backdrop, centered content
- Header: "The Dog Rides On" in serif font, large
- Shows resolution outcome based on state:
  - If townResolved && !sinEscalatedToMurder: "You addressed the root of the rot." (positive-ish)
  - If townResolved && sinEscalatedToMurder: "Justice came, but not before blood was spilled." (bittersweet)
  - If sinEscalatedToMurder && !townResolved: "The town fell to its own darkness." (tragedy)
- NPC outcomes section: for each NPC, show:
  - Name and role
  - Final relationship level (from useNPCMemory)
  - Brief outcome text based on: their linked sins resolved/unresolved, conflict history, relationship level
  - Color coding: positive outcome = amber, neutral = gray, negative = red
- Sin chain visualization: compact horizontal list showing which sins were resolved vs reached
- "Ride On" button at bottom (placeholder for town transition in Phase 6)
- Framer motion: staggered fade-in for each NPC outcome
- data-testid="resolution-summary"
  </action>
  <verify>Run `npx tsc --noEmit`. Verify ADVANCE_SIN_PROGRESSION creates next sin node correctly. Verify CONFRONT_SIN with pride level triggers MARK_TOWN_RESOLVED. Verify ResolutionSummary handles all 3 outcome scenarios.</verify>
  <done>Sin escalation advances each cycle, confronting root pride resolves town, resolution summary shows NPC outcomes with appropriate tone based on how things went.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- FatigueClock renders 6 segments by default, turns red at max
- ConflictTrigger only activates for Body/Will approaches
- ADVANCE_SIN_PROGRESSION adds new sin node at next level
- CONFRONT_SIN on 'pride' triggers town resolution
- ResolutionSummary handles all three outcome paths (clean, bittersweet, tragedy)
</verification>

<success_criteria>
- Fatigue clock visually communicates remaining conversations this cycle
- Body/Will approaches risk conflict (NPC-specific thresholds)
- Sin escalates each cycle without resolution (time pressure)
- Confronting the root sin (Pride) resolves the town
- Resolution summary provides narrative closure with NPC outcomes
- Three distinct endings based on player actions and timing
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-05-SUMMARY.md`
</output>
