---
phase: 05-investigation
plan: 04
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/MentalMap/MentalMap.tsx
  - src/components/MentalMap/SinNode.tsx
  - src/components/MentalMap/NPCNode.tsx
  - src/components/MentalMap/ConnectionEdge.tsx
  - src/hooks/useMentalMap.tsx
autonomous: true

must_haves:
  truths:
    - "Player can see discovered sins as nodes on a visual graph"
    - "NPCs connected to sins appear as nodes linked by edges"
    - "Undiscovered sins appear as obscured/locked nodes"
    - "Resolved sins visually distinct from unresolved"
    - "New discoveries animate into the map"
  artifacts:
    - path: "src/components/MentalMap/MentalMap.tsx"
      provides: "React Flow wrapper for investigation knowledge graph"
      exports: ["MentalMap"]
    - path: "src/components/MentalMap/SinNode.tsx"
      provides: "Custom node for sin progression levels"
      exports: ["SinNodeComponent"]
    - path: "src/components/MentalMap/NPCNode.tsx"
      provides: "Custom node for NPCs linked to sins"
      exports: ["NPCNodeComponent"]
    - path: "src/components/MentalMap/ConnectionEdge.tsx"
      provides: "Custom animated edge between nodes"
      exports: ["ConnectionEdgeComponent"]
    - path: "src/hooks/useMentalMap.tsx"
      provides: "Hook converting investigation state to React Flow nodes/edges"
      exports: ["useMentalMap"]
  key_links:
    - from: "src/hooks/useMentalMap.tsx"
      to: "src/hooks/useInvestigation.tsx"
      via: "Reads discoveries and sinProgression to build graph"
      pattern: "useInvestigation"
    - from: "src/components/MentalMap/MentalMap.tsx"
      to: "src/hooks/useMentalMap.tsx"
      via: "Gets nodes and edges from hook"
      pattern: "useMentalMap"
    - from: "src/components/MentalMap/SinNode.tsx"
      to: "src/types/investigation.ts"
      via: "SinNode data for rendering"
      pattern: "SinNode.*discovered.*resolved"
---

<objective>
Build the mental map visualization using React Flow to display sin progression and NPC connections.

Purpose: The mental map is how players piece together the town's moral rot. It visually represents the DitV sin chain (Pride through Murder) and shows which NPCs are connected to which sins. As the player discovers information through dialogue, nodes reveal themselves and connections form - making the investigation feel like detective work.

Output: Interactive node-edge graph showing sin progression chain with NPC connections, reactive to investigation state changes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-RESEARCH.md
@.planning/phases/05-investigation/05-01-SUMMARY.md
@src/types/investigation.ts
@src/hooks/useInvestigation.tsx
@src/types/npc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install React Flow and create mental map hook</name>
  <files>src/hooks/useMentalMap.tsx, package.json</files>
  <action>
Install React Flow:
```bash
npm install @xyflow/react
```

Create `src/hooks/useMentalMap.tsx`:
- Import { Node, Edge } from '@xyflow/react'
- Import useInvestigation for state access
- Import useNPCMemory for NPC names

The hook converts investigation state into React Flow graph data:

`useMentalMap()` returns { nodes: Node[], edges: Edge[], onNodeClick: (nodeId: string) => void }

Node generation:
- Sin nodes: positioned vertically in a column (x=300, y=i*120). Each sin from sinProgression becomes a node:
  - type: 'sinNode'
  - data: { label: sin.name, level: sin.level, discovered: sin.discovered, resolved: sin.resolved }
  - Undiscovered sins: show as "???" placeholder
  - Use manual positioning (manual layout per research recommendation for MVP)
- NPC nodes: positioned to the right of sin nodes they're linked to (x=550, y matching linked sin). Each NPC linked in sinNode.linkedNpcs becomes a node:
  - type: 'npcNode'
  - data: { name: npc.name, role: npc.role, discovered: boolean }
  - Only render if at least one linked sin is discovered

Edge generation:
- Sin chain edges: connect each sin to the next in progression (vertical chain). Animated edge if both nodes discovered.
- NPC-to-sin edges: connect NPC nodes to their linked sin nodes. Only show if both sin is discovered AND NPC has been encountered.
- Edge type: 'connectionEdge' for custom styling

onNodeClick: no-op for now (future: could show details panel)

Memoize nodes and edges with useMemo keyed on discoveries.length and sinProgression state.
  </action>
  <verify>Run `npx tsc --noEmit`. Verify @xyflow/react in package.json dependencies. Verify hook returns typed Node[] and Edge[].</verify>
  <done>useMentalMap hook converts investigation state to React Flow graph with sin chain + NPC nodes, memoized for performance.</done>
</task>

<task type="auto">
  <name>Task 2: Mental map components with custom nodes</name>
  <files>src/components/MentalMap/MentalMap.tsx, src/components/MentalMap/SinNode.tsx, src/components/MentalMap/NPCNode.tsx, src/components/MentalMap/ConnectionEdge.tsx</files>
  <action>
Create `src/components/MentalMap/SinNode.tsx`:
- Custom React Flow node component
- Props (via data): label: string, level: SinLevel, discovered: boolean, resolved: boolean
- Discovered state: shows sin name in bold, colored by severity gradient:
  - pride/injustice: amber text
  - sin/demonic-attacks: orange text
  - false-doctrine/sorcery: red text
  - hate-and-murder: dark red text with glow
- Undiscovered state: shows "???" with dashed border, muted gray
- Resolved state: crossed-out text or checkmark overlay, green border
- Shape: rounded rectangle with subtle border, 160px width
- Handles: top and bottom for chain edges, right for NPC connections
- data-testid="sin-node-{level}"

Create `src/components/MentalMap/NPCNode.tsx`:
- Custom React Flow node component
- Props (via data): name: string, role: string, discovered: boolean
- Discovered: shows NPC name in gray-200, role in gray-400 below
- Undiscovered: shows "Someone..." in italic gray-500
- Shape: rounded pill/capsule, smaller than sin nodes (120px width)
- Handle: left side only (connects to sin node)
- data-testid="npc-node-{npcId}"

Create `src/components/MentalMap/ConnectionEdge.tsx`:
- Custom React Flow edge component
- Animated dashed line for undiscovered connections
- Solid line with subtle glow for discovered connections
- Sin chain edges: thicker (2px), use severity color gradient
- NPC edges: thinner (1px), gray

Create `src/components/MentalMap/MentalMap.tsx`:
- Import ReactFlow, useNodesState, useEdgesState from '@xyflow/react'
- Import '@xyflow/react/dist/style.css'
- Import useMentalMap hook
- Register custom node types: { sinNode: SinNodeComponent, npcNode: NPCNodeComponent }
- Register custom edge types: { connectionEdge: ConnectionEdgeComponent }
- Render ReactFlow with:
  - fitView prop for auto-zoom to content
  - panOnDrag, zoomOnScroll enabled
  - Dark background matching app theme (bg-surface)
  - No minimap (too small for this use case)
  - proOptions={{ hideAttribution: true }} to hide React Flow watermark
- Wrapper div: fixed height (400px) or flex-1 depending on parent
- data-testid="mental-map"
- Sync nodes/edges from useMentalMap when investigation state changes (useEffect updating node/edge state)

Note: Do NOT wire MentalMap into GameView yet (that happens in plan 05-06 integration).
  </action>
  <verify>Run `npx tsc --noEmit`. Verify all custom node/edge components export correctly. Verify MentalMap registers custom types. Check data-testid attributes present.</verify>
  <done>MentalMap renders sin chain vertically with NPC nodes branching right, discovered/undiscovered/resolved visual states distinct, React Flow handles zoom/pan.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- @xyflow/react in package.json dependencies
- SinNode renders differently for discovered/undiscovered/resolved states
- NPCNode only appears when linked sin is discovered
- Edges animate between discovered nodes
- MentalMap uses dark theme matching existing app surface color
</verification>

<success_criteria>
- Sin progression displayed as vertical chain (7 potential nodes)
- NPCs appear as connected nodes when their linked sin is discovered
- Undiscovered content shows "???" placeholders (no spoilers)
- Resolved sins visually distinct (green border/checkmark)
- Graph updates reactively when discoveries change
- Manual layout produces readable graph for 5-10 sin + 5-10 NPC nodes
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-04-SUMMARY.md`
</output>
