---
phase: 05-investigation
plan: 03
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/reducers/dialogueReducer.ts
  - src/hooks/useDialogue.tsx
  - src/components/Dialogue/DialogueView.tsx
  - src/components/Dialogue/TopicChips.tsx
  - src/components/Dialogue/ApproachChips.tsx
  - src/components/Dialogue/TypewriterText.tsx
  - src/components/Dialogue/InnerVoice.tsx
  - src/components/Dialogue/DiscoverySummary.tsx
autonomous: true

must_haves:
  truths:
    - "Player can select a topic chip to set conversation direction"
    - "Player can select an approach chip after choosing topic"
    - "NPC response streams in with typewriter effect"
    - "Inner voice occasionally interjecting based on highest stat"
    - "Discovery summary shows what was learned after NPC responds"
  artifacts:
    - path: "src/reducers/dialogueReducer.ts"
      provides: "Dialogue FSM with 5 phases and phase guards"
      exports: ["dialogueReducer", "initialDialogueState"]
    - path: "src/hooks/useDialogue.tsx"
      provides: "DialogueProvider, useDialogue hook, sendMessage function"
      exports: ["DialogueProvider", "useDialogue"]
    - path: "src/components/Dialogue/DialogueView.tsx"
      provides: "Main dialogue container orchestrating all sub-components"
      exports: ["DialogueView"]
    - path: "src/components/Dialogue/TopicChips.tsx"
      provides: "Topic selection chips UI"
      exports: ["TopicChips"]
    - path: "src/components/Dialogue/ApproachChips.tsx"
      provides: "Approach selection chips with stat icons"
      exports: ["ApproachChips"]
    - path: "src/components/Dialogue/TypewriterText.tsx"
      provides: "Streaming text display with typewriter animation"
      exports: ["TypewriterText"]
    - path: "src/components/Dialogue/InnerVoice.tsx"
      provides: "Stat-based inner voice interjection overlay"
      exports: ["InnerVoice"]
    - path: "src/components/Dialogue/DiscoverySummary.tsx"
      provides: "End-of-conversation discovery reveal"
      exports: ["DiscoverySummary"]
  key_links:
    - from: "src/hooks/useDialogue.tsx"
      to: "api/dialogue.ts"
      via: "fetch POST to /api/dialogue with streaming reader"
      pattern: "fetch.*api/dialogue"
    - from: "src/hooks/useDialogue.tsx"
      to: "src/reducers/dialogueReducer.ts"
      via: "useReducer wrapping dialogue state machine"
      pattern: "useReducer.*dialogueReducer"
    - from: "src/components/Dialogue/DialogueView.tsx"
      to: "src/hooks/useDialogue.tsx"
      via: "useDialogue hook for state and dispatch"
      pattern: "useDialogue"
    - from: "src/components/Dialogue/InnerVoice.tsx"
      to: "src/utils/innerVoiceTemplates.ts"
      via: "getInnerVoiceInterjection for template selection"
      pattern: "getInnerVoiceInterjection"
---

<objective>
Build the dialogue reducer, hook, and complete conversation UI components.

Purpose: This is the core player experience of Phase 5 - the actual conversation interface where players talk to NPCs, choose topics and approaches, watch responses stream in, hear inner voice interjections, and see what they've discovered. It connects the backend (plan 02) to the player.

Output: A complete dialogue view with sequential topic->approach selection, streaming typewriter display, stat-based inner voice, and discovery summary.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-RESEARCH.md
@.planning/phases/05-investigation/05-01-SUMMARY.md
@.planning/phases/05-investigation/05-02-SUMMARY.md
@src/types/dialogue.ts
@src/types/investigation.ts
@src/types/character.ts
@src/hooks/useCharacter.tsx
@src/utils/innerVoiceTemplates.ts
@src/utils/mockDialogue.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Dialogue reducer and hook with streaming</name>
  <files>src/reducers/dialogueReducer.ts, src/hooks/useDialogue.tsx</files>
  <action>
Create `src/reducers/dialogueReducer.ts`:
- Import DialogueState, DialogueAction, DialoguePhase from types/dialogue
- Define `initialDialogueState`: phase='IDLE', currentNPC=null, selectedTopic=null, selectedApproach=null, conversationHistory=[], streamingText='', newDiscoveries=[], availableTopics=[]
- Implement dialogueReducer with phase guards (silent fail pattern):
  - START_CONVERSATION: only from IDLE, sets phase='SELECTING_TOPIC', sets currentNPC and availableTopics
  - SELECT_TOPIC: only from SELECTING_TOPIC, sets phase='SELECTING_APPROACH', sets selectedTopic
  - SELECT_APPROACH: only from SELECTING_APPROACH, sets phase='STREAMING_RESPONSE', sets selectedApproach, clears streamingText
  - APPEND_RESPONSE: only from STREAMING_RESPONSE, appends chunk to streamingText
  - FINISH_RESPONSE: only from STREAMING_RESPONSE, transitions to SHOWING_DISCOVERY (if discoveries.length > 0) or back to SELECTING_TOPIC (for next exchange), appends to conversationHistory
  - CLOSE_DISCOVERY: from SHOWING_DISCOVERY, transitions to SELECTING_TOPIC (allows continued conversation) or IDLE if 3+ exchanges done
  - END_CONVERSATION: from any phase, resets to initialDialogueState

Create `src/hooks/useDialogue.tsx`:
- DialogueContext providing { state, dispatch, sendMessage, endConversation }
- DialogueProvider component using useReducer(dialogueReducer, initialDialogueState)
- `sendMessage(topic: Topic, approach: ApproachType)` async function:
  1. Dispatches SELECT_TOPIC then SELECT_APPROACH to advance FSM
  2. Fetches POST /api/dialogue with { npcId, npcName, npcRole, npcPersonality, npcFacts, topic: topic.label, approach, trustLevel, statValue }
  3. Uses ReadableStream reader to process chunks: for each chunk, dispatch APPEND_RESPONSE
  4. On stream complete: parse response for discovery markers (format: "[DISCOVERY: factId|sinId|content]" embedded in response), dispatch FINISH_RESPONSE with extracted discoveries
  5. Falls back to mock handler in dev mode (import.meta.env.DEV) if fetch fails
  6. Dispatches ADVANCE_FATIGUE to investigation context after each exchange
- `endConversation()` dispatches END_CONVERSATION
- useDialogue() hook with null context error
- Import useInvestigation for fatigue tracking, useCharacter for stat values, useNPCMemory for trust levels
  </action>
  <verify>Run `npx tsc --noEmit`. Verify dialogueReducer transitions through all 5 phases correctly by tracing the state machine mentally. Confirm sendMessage references correct API path.</verify>
  <done>Dialogue FSM handles all transitions with guards, streaming reader processes chunks, discovery extraction from response markers works, fatigue advances per conversation.</done>
</task>

<task type="auto">
  <name>Task 2: Dialogue UI components</name>
  <files>src/components/Dialogue/DialogueView.tsx, src/components/Dialogue/TopicChips.tsx, src/components/Dialogue/ApproachChips.tsx, src/components/Dialogue/TypewriterText.tsx, src/components/Dialogue/InnerVoice.tsx, src/components/Dialogue/DiscoverySummary.tsx</files>
  <action>
Create `src/components/Dialogue/TopicChips.tsx`:
- Receives topics: Topic[], onSelect: (topic: Topic) => void
- Renders horizontal chip row, each chip shows topic.label
- Unavailable topics rendered with opacity-50 and disabled
- Active/selected chip highlighted with amber border (matching project's amber accent)
- data-testid="topic-chip-{topic.id}" on each chip
- Tailwind: rounded-full px-4 py-2 bg-surface-light text-sm, hover states

Create `src/components/Dialogue/ApproachChips.tsx`:
- Receives onSelect: (approach: ApproachType) => void, stats: Character['stats']
- Four chips: Acuity (Lightbulb icon), Heart (Heart icon), Body (Hand icon), Will (Cross icon) - matching Phase 4 Lucide icons
- Each chip shows stat name + dice count (e.g., "Heart (4d6)") as subtle indicator of effectiveness
- Subtle color tint based on stat dice count: 2-3=dim, 4-5=normal, 6=bright (effectiveness indicator without explicit numbers)
- data-testid="approach-chip-{approach}" on each
- Tailwind: flex gap-3, rounded-lg with stat-specific subtle border colors

Create `src/components/Dialogue/TypewriterText.tsx`:
- Receives text: string, isStreaming: boolean
- Prose-style narrative display (not chat bubbles)
- During streaming: text renders as-is with blinking cursor (underscore character with opacity animation)
- After streaming complete (isStreaming=false): cursor disappears
- Use framer-motion for cursor blink animation only (NOT per-character animation - too expensive for streaming)
- Format: distinguish player speech and NPC speech within the prose (player in gray-300, NPC in gray-100, slightly different weight)
- data-testid="dialogue-text"

Create `src/components/Dialogue/InnerVoice.tsx`:
- Receives stat: StatName, situation: string, visible: boolean
- Calls getInnerVoiceInterjection on mount (or when situation changes)
- If interjection returned: shows italic text in stat-specific color (acuity=blue, heart=pink, body=amber, will=purple)
- Framer motion: slides in from bottom-left, fades out after 4 seconds
- Label: "[STAT_NAME]" prefix in small caps
- data-testid="inner-voice"

Create `src/components/Dialogue/DiscoverySummary.tsx`:
- Receives discoveries: Discovery[], onClose: () => void
- Shows brief moment: "You learned:" followed by bullet list of discovery.content
- If discovery has sinId: shows connection icon + "Connected to: [sin name]"
- Framer motion: fade-in overlay with slight scale
- "Continue" button to dismiss
- data-testid="discovery-summary"

Create `src/components/Dialogue/DialogueView.tsx`:
- Main orchestrator component (dedicated dialogue view, separate from narrative panel)
- Uses useDialogue() hook for state and actions
- Layout: full-screen overlay (z-40) with dark backdrop, centered content panel
- Top: NPC silhouette icon (simple circle with initial, matching existing NPC avatar pattern in GameView) + NPC name + role
- Middle: TypewriterText showing current/past conversation turns (scrollable)
- InnerVoice positioned bottom-left, triggered after NPC response completes
- Bottom: sequential chips - TopicChips when phase=SELECTING_TOPIC, ApproachChips when phase=SELECTING_APPROACH
- During STREAMING_RESPONSE: chips hidden, TypewriterText streaming
- During SHOWING_DISCOVERY: DiscoverySummary overlay on top
- "Leave Conversation" button (top-right) calls endConversation
- Fatigue indicator: small text showing "{current}/{max} fatigue" (from useInvestigation)
- data-testid="dialogue-view"
  </action>
  <verify>Run `npx tsc --noEmit`. Verify all components have data-testid attributes. Verify DialogueView renders correct sub-component for each DialoguePhase.</verify>
  <done>All 6 dialogue components render, phase-appropriate UI shows (topics -> approaches -> streaming -> discovery), inner voice triggers probabilistically, conversation history scrollable.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- DialogueView renders TopicChips in SELECTING_TOPIC phase
- DialogueView renders ApproachChips in SELECTING_APPROACH phase
- DialogueView renders TypewriterText during STREAMING_RESPONSE
- DiscoverySummary appears during SHOWING_DISCOVERY phase
- All interactive elements have data-testid attributes
- InnerVoice uses template system (no API calls)
</verification>

<success_criteria>
- Complete dialogue FSM: topic selection -> approach selection -> streaming response -> discovery reveal -> next exchange or end
- Streaming text displayed with typewriter cursor effect
- Inner voice interjections appear ~30% of the time after NPC responds
- Discovery summary shows connections to sin progression
- Fatigue displayed and incremented per conversation
- 2-3 exchanges per conversation (CLOSE_DISCOVERY checks count)
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-03-SUMMARY.md`
</output>
