---
phase: 05-investigation
plan: 06
type: execute
wave: 3
depends_on: ["05-02", "05-03", "05-04", "05-05"]
files_modified:
  - src/App.tsx
  - src/pages/GameView.tsx
  - src/hooks/useNPCMemory.tsx
  - src/data/testTown.ts
autonomous: true

must_haves:
  truths:
    - "Clicking an NPC in the sidebar opens the dialogue view"
    - "Mental map accessible via sidebar button"
    - "Fatigue clock visible in sidebar during investigation"
    - "Sin escalation advances when cycle ends"
    - "Town resolution triggers summary screen"
    - "Test town provides playable content for development and testing"
  artifacts:
    - path: "src/App.tsx"
      provides: "InvestigationProvider and DialogueProvider in provider hierarchy"
      exports: ["App"]
    - path: "src/pages/GameView.tsx"
      provides: "Integration of dialogue, mental map, fatigue clock, and resolution into game"
      exports: ["GameView"]
    - path: "src/data/testTown.ts"
      provides: "Hard-coded test town with NPCs, sin chain, and knowledge facts"
      exports: ["TEST_TOWN_DATA", "TEST_NPCS", "TEST_SIN_CHAIN"]
  key_links:
    - from: "src/pages/GameView.tsx"
      to: "src/components/Dialogue/DialogueView.tsx"
      via: "Renders DialogueView when player clicks NPC"
      pattern: "DialogueView"
    - from: "src/pages/GameView.tsx"
      to: "src/components/MentalMap/MentalMap.tsx"
      via: "Renders MentalMap in overlay when toggled"
      pattern: "MentalMap"
    - from: "src/pages/GameView.tsx"
      to: "src/components/FatigueClock/FatigueClock.tsx"
      via: "Renders FatigueClock in sidebar"
      pattern: "FatigueClock"
    - from: "src/pages/GameView.tsx"
      to: "src/components/Resolution/ResolutionSummary.tsx"
      via: "Renders ResolutionSummary when townResolved"
      pattern: "ResolutionSummary.*townResolved"
    - from: "src/App.tsx"
      to: "src/hooks/useInvestigation.tsx"
      via: "InvestigationProvider in provider tree"
      pattern: "InvestigationProvider"
---

<objective>
Wire all investigation components into the game: providers in App.tsx, dialogue/map/clock/resolution in GameView, and create a test town for development.

Purpose: This integration plan connects the independently-built subsystems (dialogue, mental map, fatigue, resolution) into the live game. It also creates a hardcoded test town with NPCs, sin chain, and knowledge facts so the system is playable during development and testable in E2E.

Output: Fully playable investigation loop - click NPC to talk, discover sins, view mental map, manage fatigue per cycle, trigger conflicts, and resolve the town.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-03-SUMMARY.md
@.planning/phases/05-investigation/05-04-SUMMARY.md
@.planning/phases/05-investigation/05-05-SUMMARY.md
@src/App.tsx
@src/pages/GameView.tsx
@src/hooks/useNPCMemory.tsx
@src/types/npc.ts
@src/types/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test town data and NPC knowledge setup</name>
  <files>src/data/testTown.ts, src/hooks/useNPCMemory.tsx</files>
  <action>
Create `src/data/testTown.ts` with a complete hardcoded test town:

Town: "Bridal Falls" (matching existing location name in GameView)
Sin chain (linear, 4 levels active for test):
1. Pride - Steward Ezekiel believes he alone knows God's will (root)
2. Injustice - Sister Martha denied care by Steward's decree
3. Sin - Brother Thomas stealing medicine for Martha
4. Demonic Attacks - Strange sickness spreading (consequence of disrupted order)

NPCs (5, at various locations):
1. Steward Ezekiel (location: 'chapel') - Role: "Town Steward", proud, authoritative
   - Knowledge: knows his own pride (high trust), knows about Martha's illness (low trust), deflects about doctrine
   - ConflictThresholds: Body(0.8), Will(0.4) - resists physical intimidation, somewhat yields to spiritual authority
2. Sister Martha (location: 'general-store') - Role: "Midwife", suffering, grateful for help
   - Knowledge: knows Thomas steals (medium trust), knows Steward denied her (low trust), knows sickness details (any trust)
   - ConflictThresholds: Body(0.2), Will(0.3) - rarely resists
3. Brother Thomas (location: 'homestead') - Role: "Farmer", desperate, protective
   - Knowledge: knows he steals (medium trust), knows Martha's condition (any), knows Steward's decree (low trust)
   - ConflictThresholds: Body(0.6), Will(0.5) - will fight to protect Martha
4. Sister Ruth (location: 'well') - Role: "Teacher", observant, conflicted
   - Knowledge: sees everything (medium trust), knows about sickness pattern (low trust), suspects Steward
   - ConflictThresholds: Body(0.1), Will(0.2) - very unlikely to resist
5. Sheriff Jacob (location: 'jailhouse') - Role: "Sheriff", loyal to Steward, suspicious
   - Knowledge: knows Thomas's movements (any), knows of player's authority as Dog (any), hides Steward's orders (high trust)
   - ConflictThresholds: Body(0.7), Will(0.6) - tough to crack

Each NPC has:
- Full NPCKnowledge with 4-6 KnowledgeFacts at varying trust levels
- Personality string for prompt construction
- speechPattern override (optional, most use default DitV voice)

Available topics per NPC:
- Always available: "greeting", "the-town"
- Discovery-unlocked: "steward-decree" (requires discovering Martha's illness), "medicine-theft" (requires discovering Thomas's secret), "the-sickness" (requires discovering demonic-attacks sin)
- Location-specific: each NPC has 1 topic only available at their location

Export: TEST_TOWN_DATA (full town config), TEST_NPCS (NPC array), TEST_SIN_CHAIN (SinNode array), TEST_LOCATIONS (Location array matching existing SVG coordinates)

Update `src/hooks/useNPCMemory.tsx`:
- Add the test town NPCs to the initial NPC list (extend existing NPC initialization if any, or replace placeholder NPCs)
- NPC type extensions (knowledge, conflictThresholds) were already added in Plan 05-01
- Update NPC entries in useNPCMemory to use TEST_NPCS from testTown.ts for initial state
  </action>
  <verify>Run `npx tsc --noEmit`. Verify TEST_TOWN_DATA exports cleanly. Verify each NPC has 4-6 knowledge facts at different trust levels. Verify sin chain has 4 nodes with linkedNpcs pointing to correct NPC IDs.</verify>
  <done>Test town provides 5 NPCs with knowledge facts, 4-level sin chain, conflict thresholds, and location assignments. NPCs loaded into NPC memory on startup.</done>
</task>

<task type="auto">
  <name>Task 2: Wire providers and integrate into GameView</name>
  <files>src/App.tsx, src/pages/GameView.tsx</files>
  <action>
Update `src/App.tsx`:
- Import InvestigationProvider from '@/hooks/useInvestigation'
- Import DialogueProvider from '@/hooks/useDialogue'
- Add providers inside NPCMemoryProvider (investigation needs NPC memory):
  ```
  CharacterProvider > GameProvider > NPCMemoryProvider > InvestigationProvider > DialogueProvider > GameView
  ```
- DialogueProvider innermost because it's scoped to active conversations only

Update `src/pages/GameView.tsx` with investigation integration:

1. Import new components: DialogueView, MentalMap, FatigueClock, ResolutionSummary, ConflictTrigger
2. Import hooks: useInvestigation, useDialogue
3. Import TEST_SIN_CHAIN from data/testTown

4. State additions:
   - showMentalMap: boolean (toggle for map overlay)
   - showDialogue: boolean (active when talking to NPC)
   - dialogueNpcId: string | null (which NPC we're talking to)

5. On mount (useEffect): dispatch START_INVESTIGATION with TEST_SIN_CHAIN to initialize sin progression

6. NPC click handler update:
   - Instead of just setSelectedNpcId, also check fatigue:
   - If fatigueClock.current < fatigueClock.max: open dialogue (setShowDialogue(true), setDialogueNpcId(npc.id), dispatch START_CONVERSATION)
   - If fatigueClock.current >= max: show "Too tired to talk" feedback (brief toast-like message)

7. Cycle end handler:
   - On END_CYCLE action: dispatch RESET_FATIGUE and ADVANCE_SIN_PROGRESSION to investigation

8. Sidebar additions:
   - FatigueClock component below "Day N" status (shows investigation resource)
   - "View Mental Map" button below clocks (opens map overlay)
   - data-testid="open-mental-map" on button

9. Overlay additions:
   - DialogueView: render when showDialogue=true, pass npcId, onClose sets showDialogue=false
   - MentalMap: render when showMentalMap=true, with close button, full-screen overlay (z-40)
   - ResolutionSummary: render when investigation.townResolved=true (z-50, above all else)

10. ConflictTrigger integration:
    - When dialogue triggers conflict (via ConflictTrigger callback):
    - Close dialogue, dispatch START_GAME_CONFLICT, initialize ConflictState with appropriate dice
    - After conflict resolves: if approach was Body/Will on NPC with linked sin, dispatch CONFRONT_SIN

11. Dev mode additions:
    - "Start Investigation" button (dispatches START_INVESTIGATION if not already started)
    - "Advance Sin" button (dispatches ADVANCE_SIN_PROGRESSION for testing escalation)
    - data-testid on each dev button
  </action>
  <verify>Run `npm run dev` and verify app loads without errors. Verify NPC clicks open dialogue. Verify mental map button shows graph. Verify fatigue clock visible in sidebar. Run `npx tsc --noEmit`.</verify>
  <done>Full investigation loop playable: NPCs clickable for dialogue, mental map viewable, fatigue limits conversations per cycle, sin escalates on cycle end, conflict trigger from aggressive approaches, resolution summary on town completion.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npm run dev` launches without errors
- App.tsx has correct provider nesting order
- Clicking NPC opens DialogueView (when not fatigued)
- Mental Map button opens graph overlay
- Fatigue clock visible and increments with conversations
- END_CYCLE resets fatigue and advances sin
- townResolved shows ResolutionSummary
</verification>

<success_criteria>
- Test town provides enough content for full investigation playthrough (5 NPCs, 4 sins, 20+ knowledge facts)
- Player can discover all 4 sins through NPC conversations
- Fatigue prevents unlimited conversations per cycle
- Aggressive approaches risk conflict with appropriate NPCs
- Sin escalation creates time pressure each cycle
- Confronting Steward's pride resolves the town
- Resolution summary displays based on outcome
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-06-SUMMARY.md`
</output>
