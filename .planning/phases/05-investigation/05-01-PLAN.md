---
phase: 05-investigation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/investigation.ts
  - src/types/dialogue.ts
  - src/types/npc.ts
  - src/reducers/investigationReducer.ts
  - src/hooks/useInvestigation.tsx
autonomous: true

must_haves:
  truths:
    - "Investigation types model the full sin progression chain"
    - "NPC knowledge facts are gated by trust level and approach"
    - "Fatigue clock state tracks conversation cost per cycle"
    - "Discovery records connect conversation output to mental map"
  artifacts:
    - path: "src/types/investigation.ts"
      provides: "SinNode, Discovery, FatigueClock, InvestigationState types"
      exports: ["SinNode", "SinLevel", "Discovery", "FatigueClock", "InvestigationState", "InvestigationAction"]
    - path: "src/types/dialogue.ts"
      provides: "KnowledgeFact, DialoguePhase, DialogueState, NPC knowledge types"
      exports: ["KnowledgeFact", "DialoguePhase", "DialogueState", "DialogueAction", "ConversationTurn", "ApproachType", "Topic"]
    - path: "src/reducers/investigationReducer.ts"
      provides: "Investigation state machine with discovery tracking"
      exports: ["investigationReducer", "initialInvestigationState"]
    - path: "src/hooks/useInvestigation.tsx"
      provides: "InvestigationProvider and useInvestigation hook"
      exports: ["InvestigationProvider", "useInvestigation"]
  key_links:
    - from: "src/types/dialogue.ts"
      to: "src/types/investigation.ts"
      via: "Discovery type shared between dialogue output and investigation tracking"
      pattern: "import.*Discovery.*from.*investigation"
    - from: "src/reducers/investigationReducer.ts"
      to: "src/types/investigation.ts"
      via: "Reducer uses InvestigationState and InvestigationAction"
      pattern: "InvestigationState.*InvestigationAction"
    - from: "src/hooks/useInvestigation.tsx"
      to: "src/reducers/investigationReducer.ts"
      via: "Provider wraps reducer"
      pattern: "useReducer.*investigationReducer"
---

<objective>
Create the type foundation and state management for the investigation system.

Purpose: All investigation features (dialogue, mental map, fatigue, resolution) depend on shared types and a central reducer. This plan establishes the data model for sin progression (DitV's Pride through Murder chain), NPC knowledge pools with trust gating, discovery tracking, and the fatigue clock economy.

Output: TypeScript types, investigation reducer, and context provider ready for dialogue UI and mental map plans to consume.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-investigation/05-CONTEXT.md
@.planning/phases/05-investigation/05-RESEARCH.md
@src/types/game.ts
@src/types/npc.ts
@src/types/character.ts
@src/hooks/useGameState.tsx
@src/hooks/useNPCMemory.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Investigation and dialogue type definitions</name>
  <files>src/types/investigation.ts, src/types/dialogue.ts, src/types/npc.ts</files>
  <action>
Create `src/types/investigation.ts` with:
- `SinLevel` union type: 'pride' | 'injustice' | 'sin' | 'demonic-attacks' | 'false-doctrine' | 'sorcery' | 'hate-and-murder' (DitV linear chain)
- `SinNode` interface: { id: string, level: SinLevel, name: string, description: string, discovered: boolean, resolved: boolean, linkedNpcs: string[] }
- `Discovery` interface: { id: string, factId: string, sinId: string | null, npcId: string, content: string, timestamp: number, newConnections: string[] }
- `FatigueClock` interface: { current: number, max: number } (max defaults to 6 segments, 1 per conversation)
- `InvestigationState` interface: { discoveries: Discovery[], sinProgression: SinNode[], fatigueClock: FatigueClock, townResolved: boolean }
- `InvestigationAction` union type: START_INVESTIGATION (init sin chain), RECORD_DISCOVERY, ADVANCE_FATIGUE, RESET_FATIGUE (on cycle end), MARK_SIN_RESOLVED, MARK_TOWN_RESOLVED
- `ResolutionStatus` type: 'unresolved' | 'confronted' | 'resolved'

Create `src/types/dialogue.ts` with:
- `ApproachType` union: 'acuity' | 'heart' | 'body' | 'will' (stat-linked)
- `Topic` interface: { id: string, label: string, available: boolean, requiresDiscovery?: string, locationOnly?: string }
- `KnowledgeFact` interface: { id: string, content: string, tags: string[], minTrustLevel: number, requiredApproach?: ApproachType, sinId?: string }
- `ConversationTurn` interface: { topic: string, approach: ApproachType, playerDialogue: string, npcResponse: string, innerVoice?: { stat: StatName, text: string } }
- `DialoguePhase` union: 'IDLE' | 'SELECTING_TOPIC' | 'SELECTING_APPROACH' | 'STREAMING_RESPONSE' | 'SHOWING_DISCOVERY'
- `DialogueState` interface: { phase: DialoguePhase, currentNPC: string | null, selectedTopic: Topic | null, selectedApproach: ApproachType | null, conversationHistory: ConversationTurn[], streamingText: string, newDiscoveries: Discovery[], availableTopics: Topic[] }
- `DialogueAction` union type: START_CONVERSATION, SELECT_TOPIC, SELECT_APPROACH, APPEND_RESPONSE, FINISH_RESPONSE (includes discoveries), CLOSE_DISCOVERY, END_CONVERSATION

Update `src/types/npc.ts` to add:
- `NPCKnowledge` interface: { npcId: string, facts: KnowledgeFact[], personality: string, speechPattern: string }
- `ConflictThreshold` interface: { approach: ApproachType, resistChance: number } (NPC-specific conflict trigger thresholds)
- Add optional fields to NPC interface: knowledge?: NPCKnowledge, conflictThresholds?: ConflictThreshold[]

Import StatName from character.ts in dialogue.ts. Import KnowledgeFact from dialogue.ts where needed.
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Verify exports are accessible from other files.</verify>
  <done>All investigation/dialogue types compile, NPC type extended with knowledge fields, Discovery type shared between dialogue and investigation modules.</done>
</task>

<task type="auto">
  <name>Task 2: Investigation reducer and context provider</name>
  <files>src/reducers/investigationReducer.ts, src/hooks/useInvestigation.tsx</files>
  <action>
Create `src/reducers/investigationReducer.ts`:
- Import InvestigationState, InvestigationAction, SinNode, SinLevel from types
- Define `SIN_CHAIN_ORDER: SinLevel[]` constant with the 7 levels in order
- Define `initialInvestigationState`: empty discoveries, empty sinProgression (populated on START_INVESTIGATION), fatigueClock { current: 0, max: 6 }, townResolved: false
- Implement reducer with phase guards (silent fail pattern, consistent with existing reducers):
  - START_INVESTIGATION: accepts sinNodes array, sets sinProgression
  - RECORD_DISCOVERY: appends to discoveries, marks SinNode.discovered if sinId matches
  - ADVANCE_FATIGUE: increments fatigueClock.current (capped at max), returns unchanged if already at max
  - RESET_FATIGUE: sets fatigueClock.current to 0
  - MARK_SIN_RESOLVED: sets resolved=true on matching sin node
  - MARK_TOWN_RESOLVED: sets townResolved=true (triggered when root sin Pride is resolved)

Create `src/hooks/useInvestigation.tsx`:
- Follow exact pattern from useNPCMemory.tsx and useCharacter.tsx
- Create InvestigationContext with { state: InvestigationState, dispatch: Dispatch<InvestigationAction> }
- InvestigationProvider wraps children with context value
- useInvestigation() hook with context null check and descriptive error
- Export both InvestigationProvider and useInvestigation

Do NOT wire InvestigationProvider into App.tsx yet (that happens in plan 05-05 integration).
  </action>
  <verify>Run `npx tsc --noEmit` - no type errors. Grep for exported symbols: investigationReducer, initialInvestigationState, InvestigationProvider, useInvestigation.</verify>
  <done>Investigation reducer handles all action types with silent fail guards, context provider follows existing codebase pattern, all exports accessible.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- All type exports importable from their respective modules
- Investigation reducer returns state unchanged for invalid phase transitions
- InvestigationProvider and useInvestigation follow exact pattern of useCharacter/useNPCMemory
</verification>

<success_criteria>
- SinLevel models the complete DitV sin progression chain (7 levels)
- KnowledgeFact supports trust-level + approach gating
- DialogueState models the full conversation FSM (5 phases)
- InvestigationReducer handles 6 action types with silent fail guards
- FatigueClock defaults to 6 segments (1 per conversation)
- No runtime dependencies yet (pure types + state logic)
</success_criteria>

<output>
After completion, create `.planning/phases/05-investigation/05-01-SUMMARY.md`
</output>
