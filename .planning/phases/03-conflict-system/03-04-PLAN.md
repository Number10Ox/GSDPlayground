---
phase: 03-conflict-system
plan: 04
type: execute
wave: 3
depends_on: ["03-02", "03-03"]
files_modified:
  - src/types/npc.ts
  - src/hooks/useNPCMemory.tsx
  - src/components/NPCMemory/ConflictMarker.tsx
  - src/components/NPCMemory/RelationshipPanel.tsx
  - src/components/NPCMemory/index.ts
  - src/types/game.ts
  - src/hooks/useGameState.tsx
autonomous: true

must_haves:
  truths:
    - "NPCs at same location witness conflicts"
    - "Conflict events recorded with escalation level and outcome"
    - "NPC markers indicate violence history at a glance"
    - "Relationship panel shows detailed conflict history"
  artifacts:
    - path: "src/types/npc.ts"
      provides: "NPCMemory, ConflictEvent types"
      exports: ["NPCMemory", "ConflictEvent", "NPC"]
    - path: "src/hooks/useNPCMemory.tsx"
      provides: "Context and hook for NPC memory management"
      exports: ["NPCMemoryProvider", "useNPCMemory"]
    - path: "src/components/NPCMemory/ConflictMarker.tsx"
      provides: "Icon overlay for violence history"
      exports: ["ConflictMarker"]
    - path: "src/components/NPCMemory/RelationshipPanel.tsx"
      provides: "Detailed NPC history view"
      exports: ["RelationshipPanel"]
  key_links:
    - from: "src/hooks/useNPCMemory.tsx"
      to: "src/types/npc.ts"
      via: "imports NPCMemory types"
      pattern: "import.*from.*types/npc"
    - from: "src/components/Conflict/ConflictView.tsx"
      to: "src/hooks/useNPCMemory.tsx"
      via: "records conflict on resolution"
      pattern: "recordConflict"
---

<objective>
Build NPC witness/memory system with conflict history tracking and visual markers.

Purpose: Make violence have persistent consequences by tracking NPC memories of conflicts.
Output: NPC types, memory management context, conflict markers, and relationship panel.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-conflict-system/03-CONTEXT.md
@.planning/phases/03-conflict-system/03-RESEARCH.md
@.planning/phases/03-conflict-system/03-02-SUMMARY.md
@.planning/phases/03-conflict-system/03-03-SUMMARY.md

# Existing patterns
@src/hooks/useGameState.tsx
@src/types/game.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: NPC types and memory context</name>
  <files>src/types/npc.ts, src/hooks/useNPCMemory.tsx</files>
  <action>
**src/types/npc.ts:**

Create NPC and memory type definitions:

1. **NPC** interface:
   - id: string
   - name: string
   - locationId: LocationId (from game.ts)
   - description: string
   - role: string (e.g., "Sheriff", "Storekeeper")

2. **ConflictEvent** interface:
   - id: string
   - timestamp: number
   - type: 'WITNESSED_VIOLENCE' | 'TARGETED_BY_VIOLENCE' | 'HELPED_BY_PLAYER'
   - escalationLevel: EscalationLevel (from conflict.ts)
   - location: LocationId
   - otherParticipants: string[] (NPC IDs involved)
   - outcome: 'PLAYER_WON' | 'PLAYER_LOST' | 'PLAYER_GAVE'
   - description: string (what happened)

3. **NPCMemory** interface:
   - npcId: string
   - events: ConflictEvent[]
   - relationshipLevel: number (-100 to 100, starts at 0)

4. **NPCMemoryAction** type for reducer:
   - RECORD_CONFLICT: { conflictData, witnesses }
   - UPDATE_RELATIONSHIP: { npcId, delta }
   - CLEAR_MEMORY (for testing/reset)

**src/hooks/useNPCMemory.tsx:**

Create context and hook for NPC memory management:

1. **NPCMemoryContext** with state and dispatch

2. **initialNPCState**:
   - npcs: NPC[] (sample NPCs for testing)
   - memories: NPCMemory[] (empty initially)

3. **npcMemoryReducer** handling:
   - **RECORD_CONFLICT**: For each witness, add ConflictEvent to their memory. Adjust relationshipLevel based on violence:
     - JUST_TALKING: no change
     - PHYSICAL: -5
     - FIGHTING: -15
     - GUNPLAY: -30
     - If NPC was target: double the penalty

   - **UPDATE_RELATIONSHIP**: Add delta to npcId's relationshipLevel (clamp -100 to 100)

4. **NPCMemoryProvider** component wrapping children with context

5. **useNPCMemory()** hook returning:
   - npcs, memories, dispatch
   - Helper functions:
     - getNPCById(id): NPC | undefined
     - getMemoryForNPC(npcId): NPCMemory | undefined
     - hasWitnessedViolence(npcId): boolean
     - getHighestEscalationWitnessed(npcId): EscalationLevel | null
     - getWitnessesAtLocation(locationId): string[]

6. Sample NPCs matching existing locations:
   - "sheriff-jacob" at "sheriffs-office"
   - "ezekiel" at "general-store"
   - "sister-abigail" at "church"
   - "brother-hiram" at "cemetery"
  </action>
  <verify>`npx tsc --noEmit` passes. useNPCMemory hook returns expected helper function results.</verify>
  <done>NPC types defined, memory context tracks conflict events and adjusts relationship levels.</done>
</task>

<task type="auto">
  <name>Task 2: ConflictMarker and RelationshipPanel components</name>
  <files>src/components/NPCMemory/ConflictMarker.tsx, src/components/NPCMemory/RelationshipPanel.tsx, src/components/NPCMemory/index.ts</files>
  <action>
**ConflictMarker.tsx:**

Create icon overlay for NPC violence history:

1. Props: `{ npcId: string, size?: 'sm' | 'md' }`

2. Use useNPCMemory() to get NPC's history

3. Marker types based on history:
   - No conflict history: no marker (return null)
   - Witnessed violence (not gunplay): Crossed fists icon (amber)
   - Witnessed gunplay: Crossed guns icon (red)
   - Was targeted: Broken trust icon (dark red)

4. Render as small absolute-positioned icon (overlay on NPC representation)

5. Tooltip on hover showing brief description

6. data-testid="conflict-marker-{npcId}"

**RelationshipPanel.tsx:**

Create detailed NPC history panel:

1. Props: `{ npcId: string, onClose: () => void }`

2. Layout as slide-out panel (like NarrativePanel):
   - NPC name and role at top
   - Relationship meter: visual bar from -100 to +100
   - Relationship label: "Hostile" / "Distrustful" / "Neutral" / "Friendly" / "Trusted"

3. Conflict history section:
   - List all ConflictEvents for this NPC
   - Each event shows:
     - Timestamp (relative: "2 days ago")
     - What happened (description)
     - Escalation level badge
     - Outcome

4. If no history: "You have no notable history with [NPC name]."

5. Framer Motion slide-in animation

6. data-testid="relationship-panel"

**index.ts:**
Barrel export all components.
  </action>
  <verify>`npx tsc --noEmit` passes. Components render correctly with mock NPC data.</verify>
  <done>ConflictMarker shows at-a-glance violence history icon. RelationshipPanel shows detailed conflict history and relationship level.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate memory system with ConflictView and game state</name>
  <files>src/components/Conflict/ConflictView.tsx, src/hooks/useGameState.tsx, src/types/game.ts, src/App.tsx</files>
  <action>
**Update ConflictView.tsx:**

1. Import and use useNPCMemory hook

2. On conflict resolution (when showing ConflictResolution):
   - Call getWitnessesAtLocation(currentLocation) to find witnesses
   - Include conflict opponent + witnesses in witness list
   - Pass witnesses to ConflictResolution component

3. When ConflictResolution dismisses:
   - Dispatch RECORD_CONFLICT to npcMemoryReducer with:
     - escalationLevel: max(playerEscalation, npcEscalation)
     - outcome
     - location
     - witnesses
     - description generated from stakes and outcome

**Update src/types/game.ts:**

Add to GameState:
```typescript
activeConflictNpcId: string | null;
activeConflictStakes: string | null;
```

Update START_CONFLICT action to include npcId and stakes.

**Update src/hooks/useGameState.tsx:**

1. Handle START_CONFLICT: Set activeConflictNpcId and activeConflictStakes

2. Handle END_CONFLICT: Clear activeConflictNpcId and activeConflictStakes

**Update src/App.tsx:**

1. Wrap app with NPCMemoryProvider (inside GameProvider)

2. This allows all components to access NPC memory

**Add NPC markers to existing UI:**

1. In NodeMap or location display, show ConflictMarker for NPCs at each location

2. Click on NPC (or marker) opens RelationshipPanel

This may require minor updates to LocationNode.tsx to show NPCs and their markers.
  </action>
  <verify>
1. Start conflict, complete with escalation
2. Verify witness NPC memories updated
3. Verify ConflictMarker appears on NPCs who witnessed
4. Open RelationshipPanel and see conflict history
  </verify>
  <done>Conflict resolution records events to NPC memory. Markers appear on NPCs with violence history. Panel shows detailed history.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All files compile
2. Start conflict at location with multiple NPCs
3. Escalate to GUNPLAY and complete
4. Verify all NPCs at location have conflict recorded in memory
5. Verify relationship levels decreased
6. Verify ConflictMarker shows on affected NPCs
7. Open RelationshipPanel and verify history entry
</verification>

<success_criteria>
- NPCs at same location automatically become witnesses
- Conflict events recorded with full metadata
- Relationship levels decrease based on violence severity
- ConflictMarker provides at-a-glance history indicator
- RelationshipPanel shows detailed conflict history
</success_criteria>

<output>
After completion, create `.planning/phases/03-conflict-system/03-04-SUMMARY.md`
</output>
