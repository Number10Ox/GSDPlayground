---
phase: 03-conflict-system
plan: 05
type: execute
wave: 4
depends_on: ["03-04"]
files_modified:
  - e2e/features/conflict.feature
  - e2e/steps/conflict.steps.ts
  - e2e/conflict.spec.ts
  - src/components/Conflict/ConflictView.tsx
autonomous: true

must_haves:
  truths:
    - "E2E tests validate complete conflict flow"
    - "Tests cover escalation, raise/see, and fallout"
    - "Tests verify NPC memory updates"
    - "All tests pass in CI-ready headless mode"
  artifacts:
    - path: "e2e/features/conflict.feature"
      provides: "BDD Gherkin scenarios for conflict system"
      contains: "Feature: Conflict System"
    - path: "e2e/steps/conflict.steps.ts"
      provides: "Step helper functions for conflict E2E"
      exports: ["startConflict", "raiseWithDice", "seeWithDice", "escalateTo"]
    - path: "e2e/conflict.spec.ts"
      provides: "Playwright test specs for conflict"
      contains: "describe.*Conflict"
  key_links:
    - from: "e2e/conflict.spec.ts"
      to: "e2e/steps/conflict.steps.ts"
      via: "imports step helpers"
      pattern: "import.*from.*conflict.steps"
    - from: "e2e/conflict.spec.ts"
      to: "e2e/features/conflict.feature"
      via: "references Gherkin scenarios"
      pattern: "Scenario"
---

<objective>
Create E2E tests for the conflict system using Playwright and BDD-style specifications.

Purpose: Validate conflict mechanics work correctly in browser with automated testing.
Output: BDD feature file, step helpers, and passing E2E test suite.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/03-conflict-system/03-CONTEXT.md
@.planning/phases/03-conflict-system/03-04-SUMMARY.md

# Existing E2E patterns
@e2e/features/cycle.feature
@e2e/steps/cycle.steps.ts
@e2e/cycle.spec.ts
@playwright.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: BDD feature file for conflict scenarios</name>
  <files>e2e/features/conflict.feature</files>
  <action>
Create Gherkin feature file covering conflict system scenarios:

```gherkin
Feature: Conflict System
  As a Dog in the Vineyard
  I want to engage in escalating conflicts
  So that I can resolve disputes with meaningful consequences

  Background:
    Given I am in the game
    And I start a conflict with "Sheriff Jacob" over "who controls the law in this town"

  Scenario: Basic raise and see exchange
    When I raise with 2 dice
    Then the NPC should see my raise
    When the NPC raises
    Then I should be able to see their raise
    And the bidding history should show all exchanges

  Scenario: Player gives up
    When I raise with 2 dice
    And the NPC sees my raise
    And the NPC raises
    When I choose to give
    Then the conflict should resolve
    And I should lose the stakes
    And fallout should be revealed

  Scenario: Escalation to physical
    Given the conflict is at "Just Talking"
    When I choose to escalate to "Physical"
    Then I should see an escalation confirmation
    And the confirmation should show an internal monologue
    When I confirm the escalation
    Then my escalation level should be "Physical"
    And I should receive new dice

  Scenario: Escalation to gunplay with extra warning
    Given the conflict is at "Fighting"
    When I choose to escalate to "Gunplay"
    Then the confirmation should emphasize lethality
    And the confirm button should be delayed
    When I confirm the escalation
    Then my escalation level should be "Gunplay"
    And I should receive 4 new d10 dice

  Scenario: Fallout severity based on escalation
    Given the conflict escalated to "Fighting"
    And I took the blow during the conflict
    When the conflict resolves
    Then fallout dice should be revealed dramatically
    And the severity should be calculated from the two highest dice

  Scenario: NPC witnesses remember violence
    Given "Brother Ezekiel" is at the same location
    And the conflict escalated to "Fighting"
    When the conflict resolves
    Then "Brother Ezekiel" should have witnessed the conflict
    And "Brother Ezekiel" should have a conflict marker
    And the relationship panel should show the conflict event

  Scenario: Taking the blow accumulates fallout
    When I raise with 2 dice
    And the NPC sees with 2 dice
    And the NPC raises with total 8
    When I see with 3 dice to take the blow
    Then fallout dice should be accumulated
    And the bidding history should show "Took the Blow"
```
  </action>
  <verify>Feature file is valid Gherkin syntax (no syntax errors).</verify>
  <done>BDD scenarios cover basic conflict flow, escalation, fallout, and NPC memory.</done>
</task>

<task type="auto">
  <name>Task 2: Step helper functions for conflict tests</name>
  <files>e2e/steps/conflict.steps.ts</files>
  <action>
Create step helper functions following cycle.steps.ts patterns:

```typescript
import { Page, expect } from '@playwright/test';

// Setup helpers
export async function startConflict(page: Page, npcName: string, stakes: string) {
  // Click test conflict button or trigger conflict via action
  await page.click('[data-testid="start-test-conflict"]');
  await expect(page.locator('[data-testid="conflict-view"]')).toBeVisible();
  await expect(page.locator('[data-testid="conflict-stakes"]')).toContainText(stakes);
}

// Raise/See helpers
export async function raiseWithDice(page: Page, count: number = 2) {
  // Select 'count' dice from player pool
  const dice = page.locator('[data-testid^="raise-die-"]');
  for (let i = 0; i < count; i++) {
    await dice.nth(i).click();
  }
  await page.click('[data-testid="raise-submit-button"]');
}

export async function seeWithDice(page: Page, count: number) {
  // Select dice to meet raise total
  const dice = page.locator('[data-testid^="raise-die-"]');
  for (let i = 0; i < count; i++) {
    await dice.nth(i).click();
  }
  await page.click('[data-testid="see-submit-button"]');
}

export async function giveUp(page: Page) {
  await page.click('[data-testid="give-button"]');
  // Confirm give dialog if present
  const confirmBtn = page.locator('[data-testid="give-confirm"]');
  if (await confirmBtn.isVisible()) {
    await confirmBtn.click();
  }
}

// Escalation helpers
export async function escalateTo(page: Page, level: string) {
  await page.click(`[data-testid="escalate-${level.toLowerCase()}"]`);
  await expect(page.locator('[data-testid="escalation-confirm-modal"]')).toBeVisible();
}

export async function confirmEscalation(page: Page) {
  // Wait for gunplay delay if applicable
  await page.click('[data-testid="escalation-confirm-button"]');
}

export async function cancelEscalation(page: Page) {
  await page.click('[data-testid="escalation-cancel-button"]');
}

// Verification helpers
export async function verifyEscalationLevel(page: Page, actor: 'player' | 'npc', level: string) {
  const testId = actor === 'player' ? 'player-escalation' : 'npc-escalation';
  await expect(page.locator(`[data-testid="${testId}-${level.toLowerCase()}"]`)).toBeVisible();
}

export async function verifyBiddingHistoryEntry(page: Page, text: string) {
  await expect(page.locator('[data-testid="bidding-history"]')).toContainText(text);
}

export async function verifyConflictResolved(page: Page) {
  await expect(page.locator('[data-testid="conflict-resolution"]')).toBeVisible();
}

export async function verifyFalloutSeverity(page: Page, severity: string) {
  await expect(page.locator(`[data-testid="fallout-severity-${severity.toLowerCase()}"]`)).toBeVisible();
}

// NPC memory helpers
export async function verifyConflictMarker(page: Page, npcId: string) {
  await expect(page.locator(`[data-testid="conflict-marker-${npcId}"]`)).toBeVisible();
}

export async function openRelationshipPanel(page: Page, npcId: string) {
  await page.click(`[data-testid="npc-${npcId}"]`);
  await expect(page.locator('[data-testid="relationship-panel"]')).toBeVisible();
}

// Wait helpers
export async function waitForNPCTurn(page: Page) {
  // Wait for NPC thinking indicator to disappear
  await page.waitForSelector('[data-testid="npc-thinking"]', { state: 'hidden', timeout: 5000 });
}

export async function dismissResolution(page: Page) {
  await page.click('[data-testid="resolution-continue-button"]');
}
```
  </action>
  <verify>`npx tsc --noEmit` passes for step file.</verify>
  <done>Step helpers cover all conflict actions: raise, see, give, escalate, and verification.</done>
</task>

<task type="auto">
  <name>Task 3: Playwright test specs and data-testid updates</name>
  <files>e2e/conflict.spec.ts, src/components/Conflict/ConflictView.tsx</files>
  <action>
**e2e/conflict.spec.ts:**

Create test specs implementing BDD scenarios:

```typescript
import { test, expect } from '@playwright/test';
import {
  startConflict,
  raiseWithDice,
  seeWithDice,
  giveUp,
  escalateTo,
  confirmEscalation,
  verifyEscalationLevel,
  verifyBiddingHistoryEntry,
  verifyConflictResolved,
  verifyFalloutSeverity,
  verifyConflictMarker,
  openRelationshipPanel,
  waitForNPCTurn,
  dismissResolution
} from './steps/conflict.steps';

test.describe('Conflict System', () => {
  test.beforeEach(async ({ page }) => {
    await page.goto('/');
    // Start day to get into game
    await page.click('[data-testid="start-day-button"]');
  });

  test('Scenario: Basic raise and see exchange', async ({ page }) => {
    await startConflict(page, 'Sheriff Jacob', 'who controls the law');

    await raiseWithDice(page, 2);
    await waitForNPCTurn(page);
    await verifyBiddingHistoryEntry(page, 'Raise');

    // NPC should have raised back
    await seeWithDice(page, 2);
    await verifyBiddingHistoryEntry(page, 'Block');
  });

  test('Scenario: Player gives up', async ({ page }) => {
    await startConflict(page, 'Sheriff Jacob', 'who controls the law');

    await raiseWithDice(page, 2);
    await waitForNPCTurn(page);

    await giveUp(page);
    await verifyConflictResolved(page);
  });

  test('Scenario: Escalation to physical', async ({ page }) => {
    await startConflict(page, 'Sheriff Jacob', 'who controls the law');

    await verifyEscalationLevel(page, 'player', 'JUST_TALKING');

    await escalateTo(page, 'PHYSICAL');
    await expect(page.locator('[data-testid="escalation-confirm-modal"]')).toBeVisible();

    await confirmEscalation(page);
    await verifyEscalationLevel(page, 'player', 'PHYSICAL');

    // Should have received new dice
    const diceCount = await page.locator('[data-testid^="raise-die-"]').count();
    expect(diceCount).toBeGreaterThan(5); // Base pool + escalation dice
  });

  test('Scenario: Escalation to gunplay has delay', async ({ page }) => {
    await startConflict(page, 'Sheriff Jacob', 'who controls the law');

    // Escalate through levels
    await escalateTo(page, 'PHYSICAL');
    await confirmEscalation(page);
    await escalateTo(page, 'FIGHTING');
    await confirmEscalation(page);
    await escalateTo(page, 'GUNPLAY');

    // Confirm button should be disabled initially
    const confirmBtn = page.locator('[data-testid="escalation-confirm-button"]');
    await expect(confirmBtn).toBeDisabled();

    // Wait for delay
    await page.waitForTimeout(1600);
    await expect(confirmBtn).toBeEnabled();
  });

  test('Scenario: NPC witnesses remember violence', async ({ page }) => {
    // Navigate to location with multiple NPCs
    await page.click('[data-testid="location-general-store"]');

    await startConflict(page, 'Ezekiel', 'the store');

    // Escalate to create memorable violence
    await escalateTo(page, 'PHYSICAL');
    await confirmEscalation(page);

    // Play through conflict
    await raiseWithDice(page, 2);
    await waitForNPCTurn(page);
    await giveUp(page);

    await dismissResolution(page);

    // Ezekiel should have conflict marker
    await verifyConflictMarker(page, 'ezekiel');
  });

  test('Scenario: Taking the blow accumulates fallout', async ({ page }) => {
    await startConflict(page, 'Sheriff Jacob', 'who controls the law');

    await raiseWithDice(page, 2);
    await waitForNPCTurn(page);

    // See with 3+ dice = take the blow
    await seeWithDice(page, 3);
    await verifyBiddingHistoryEntry(page, 'Took the Blow');

    // Complete conflict
    await raiseWithDice(page, 2);
    await waitForNPCTurn(page);
    await giveUp(page);

    // Fallout reveal should show accumulated dice
    await expect(page.locator('[data-testid="fallout-reveal"]')).toBeVisible();
  });
});
```

**Update ConflictView.tsx and related components:**

Ensure all interactive elements have data-testid attributes:
- `data-testid="conflict-view"`
- `data-testid="conflict-stakes"`
- `data-testid="raise-die-{id}"`
- `data-testid="raise-submit-button"`
- `data-testid="see-submit-button"`
- `data-testid="give-button"`
- `data-testid="give-confirm"`
- `data-testid="escalate-{level}"`
- `data-testid="escalation-confirm-modal"`
- `data-testid="escalation-confirm-button"`
- `data-testid="escalation-cancel-button"`
- `data-testid="player-escalation-{level}"`
- `data-testid="npc-escalation-{level}"`
- `data-testid="bidding-history"`
- `data-testid="npc-thinking"`
- `data-testid="conflict-resolution"`
- `data-testid="resolution-continue-button"`
- `data-testid="fallout-reveal"`
- `data-testid="fallout-severity-{severity}"`
- `data-testid="start-test-conflict"` (dev mode only)
  </action>
  <verify>`npm run test:e2e` passes all conflict tests.</verify>
  <done>E2E tests pass for all conflict scenarios: basic flow, escalation, fallout, and NPC memory.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` - All files compile
2. `npm run test:e2e -- --grep "Conflict"` - All conflict tests pass
3. Run in headed mode to visually verify animations
4. Check CI config works with new tests
</verification>

<success_criteria>
- All 7 BDD scenarios have passing E2E tests
- Tests run in headless mode for CI
- Tests complete within reasonable timeout (< 30s each)
- No flaky tests (run multiple times to verify)
</success_criteria>

<output>
After completion, create `.planning/phases/03-conflict-system/03-05-SUMMARY.md`
</output>
