---
phase: 06.2-e2e-test-overhaul
plan: 03
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified:
  - e2e/journey.spec.ts
  - e2e/steps/journey.steps.ts
autonomous: true

must_haves:
  truths:
    - "Player can complete a town via judgment and enter conviction reflection phase"
    - "Player can reinforce or doubt convictions during reflection"
    - "Player sees JourneyProgress screen with 'The Road Ahead' heading after reflection"
    - "Player can continue to next town from JourneyProgress"
  artifacts:
    - path: "e2e/journey.spec.ts"
      provides: "E2E coverage for journey flow across towns"
      contains: "Conviction"
    - path: "e2e/steps/journey.steps.ts"
      provides: "Reusable helpers for journey flow testing"
      exports: ["completeJudgment", "reinforceConviction", "advanceToNextTown"]
  key_links:
    - from: "e2e/journey.spec.ts"
      to: "src/components/Conviction/ConvictionReflection.tsx"
      via: "button text matching"
      pattern: "Reinforce|Doubt|Transform"
    - from: "e2e/journey.spec.ts"
      to: "src/components/Journey/JourneyProgress.tsx"
      via: "heading and button text"
      pattern: "The Road Ahead|Continue to Next Town"
    - from: "e2e/steps/journey.steps.ts"
      to: "src/components/Judgment/JudgmentPanel.tsx"
      via: "judgment choice buttons"
      pattern: "Pronounce Judgment|Confirm Judgment"
---

<objective>
Add E2E coverage for the journey flow: town completion via judgment, conviction reflection, and multi-town progression.

Purpose: Phase 6.1 introduced the journey system where players complete towns, reflect on tested convictions, and ride on to the next town. This is the core game loop and needs E2E coverage. The edge case fixed in f2e30c7 (ConvictionReflection reading from completedTowns instead of pendingTests) is covered by testing the reflection flow.

Output: New spec file and step helpers for the journey flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@src/components/Conviction/ConvictionReflection.tsx
@src/components/Journey/JourneyProgress.tsx
@src/components/Judgment/JudgmentPanel.tsx
@src/types/journey.ts
@src/hooks/useJourney.tsx
@src/pages/GameView.tsx
@e2e/steps/character.steps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create journey step helpers</name>
  <files>e2e/steps/journey.steps.ts</files>
  <action>
Create `e2e/steps/journey.steps.ts` with reusable helpers for the journey flow. These helpers will be used by the journey spec.

The journey flow works via JourneyRouter: TOWN_ACTIVE -> JUDGMENT -> TOWN_REFLECTION -> RIDING_ON -> (next town or JOURNEY_COMPLETE).

To trigger judgment, the player needs to trigger a conviction test during town play, then open the judgment panel. The judgment panel is opened via a dev-mode button or via the GameView when all sins are confronted.

For testability, the GameView should have a dev-mode button to trigger judgment directly. Check if `data-testid="open-judgment-panel"` exists in GameView.tsx. If not, note that we need a dev-mode trigger.

Helpers to create:

1. `triggerConvictionTest(page)` - Trigger a conviction test via dev-mode action or game mechanic. Check for `data-testid="trigger-test-conviction"` button. If it doesn't exist, we'll need to trigger one through gameplay (e.g., a conflict where the player's conviction is challenged).

2. `openJudgmentPanel(page)` - Click the judgment panel button. Look for `data-testid="open-judgment-panel"` or equivalent dev-mode trigger.

3. `completeJudgment(page, choice?)` - In the JudgmentPanel:
   - Wait for "Pronounce Judgment" heading to be visible
   - Click a judgment choice button (first one by default, or by choice label)
   - Click "Confirm Judgment" button
   - Wait for "Judgment Pronounced" text
   - Click "Continue" to dismiss

4. `waitForReflection(page)` - Wait for ConvictionReflection to appear (text "Conviction 1 of" visible)

5. `reinforceConviction(page)` - Click "Reinforce" button during reflection

6. `doubtConviction(page)` - Click "Doubt" button during reflection

7. `transformConviction(page, newText)` - Click "Transform", type new text, click "Transform" confirm

8. `skipUntested(page)` - If "Your convictions went untested" appears, click "Ride On"

9. `waitForJourneyProgress(page)` - Wait for "The Road Ahead" heading

10. `advanceToNextTown(page)` - Click "Continue to Next Town" button, wait for town selection

NOTE: If GameView.tsx doesn't have a dev-mode judgment trigger, add one: a button with `data-testid="dev-trigger-judgment"` that dispatches a COMPLETE_TOWN action with a minimal TownRecord. Only render in dev mode (import.meta.env.DEV). This is consistent with existing patterns (add-test-trait, start-test-conflict).
  </action>
  <verify>
File exists at `e2e/steps/journey.steps.ts` with all helper functions exported. TypeScript compiles without errors: `npx tsc --noEmit --project e2e/tsconfig.json` (or verify with playwright test --list).
  </verify>
  <done>Journey step helpers exist with all functions for judgment, reflection, and town progression.</done>
</task>

<task type="auto">
  <name>Task 2: Journey flow E2E spec</name>
  <files>
    e2e/journey.spec.ts
    src/pages/GameView.tsx
  </files>
  <action>
Create `e2e/journey.spec.ts` testing the journey flow. If GameView.tsx needs a dev-mode judgment trigger button, add it (see Task 1 NOTE).

The journey flow requires:
1. Character created (with convictions)
2. Town active gameplay (at least one conviction test triggered)
3. Judgment pronounced (completes town)
4. ConvictionReflection phase (if convictions were tested)
5. JourneyProgress screen (shows "The Road Ahead")
6. Continue to next town (returns to town selection)

For triggering conviction tests: The convictionTesting system triggers tests when certain game actions occur (conflicts with conviction-aligned NPCs, etc.). For E2E, we need either:
- A dev-mode button to force-test a conviction, OR
- To trigger a conflict that naturally tests a conviction

Check GameView.tsx for existing dev-mode buttons. Add `dev-trigger-test-conviction` and `dev-trigger-judgment` buttons if they don't exist. These should:
- `dev-trigger-test-conviction`: dispatch `ADD_CONVICTION_TEST` with a test for the first conviction
- `dev-trigger-judgment`: dispatch journey phase to JUDGMENT, then render JudgmentPanel with first discovered sin

Tests to include:

1. **"town completion triggers conviction reflection"**
   - Setup character (has 3 convictions from creation)
   - Trigger a conviction test (dev button or gameplay)
   - Open judgment panel and complete judgment
   - Verify ConvictionReflection appears ("Conviction 1 of" text)

2. **"reinforce conviction during reflection"**
   - Setup character, trigger test, complete judgment
   - In reflection: click "Reinforce"
   - Verify transition to next phase (either next conviction or JourneyProgress)

3. **"doubt conviction weakens it"**
   - Setup character, trigger test, complete judgment
   - In reflection: click "Doubt"
   - Verify transition to JourneyProgress (single conviction tested)

4. **"untested convictions skip reflection"**
   - Setup character, complete judgment WITHOUT triggering conviction tests
   - Verify "Your convictions went untested" text appears
   - Click "Ride On"
   - Verify JourneyProgress screen appears

5. **"JourneyProgress shows road ahead and continues to next town"**
   - Complete flow to JourneyProgress (after reflection)
   - Verify "The Road Ahead" heading visible
   - Verify "Town 1 of 7" text (or similar)
   - Click "Continue to Next Town"
   - Verify town selection screen appears (data-testid="town-selection")

Import from journey.steps.ts and character.steps.ts. Mock dialogue API if needed. Use Bridal Falls for deterministic setup.
  </action>
  <verify>
`npx playwright test e2e/journey.spec.ts --reporter=list` - all 5 tests pass.
  </verify>
  <done>Journey flow has E2E coverage: town completion, conviction reflection (reinforce/doubt), untested skip, and multi-town progression. Edge case from f2e30c7 (completedTowns read) is implicitly covered.</done>
</task>

</tasks>

<verification>
- `npx playwright test e2e/journey.spec.ts --reporter=list` - all 5 journey tests pass
- Existing tests still pass: `npx playwright test --reporter=list`
- Journey helpers are importable and typed correctly
- Dev-mode triggers only render when `import.meta.env.DEV` is true
</verification>

<success_criteria>
Journey flow E2E covers town completion, conviction reflection (reinforce/doubt/untested), JourneyProgress screen, and continuation to next town. The f2e30c7 edge case (reading from completedTowns) is covered by the reflection tests working correctly.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-03-SUMMARY.md`
</output>
