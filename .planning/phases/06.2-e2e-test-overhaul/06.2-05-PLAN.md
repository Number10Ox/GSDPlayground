---
phase: 06.2-e2e-test-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["06.2-02", "06.2-03", "06.2-04"]
files_modified:
  - e2e/regression.spec.ts
autonomous: true

must_haves:
  truths:
    - "Descent clock threshold events fire at correct thresholds"
    - "Dialogue streaming errors are handled gracefully (no crash)"
    - "All E2E tests pass in a single full suite run"
  artifacts:
    - path: "e2e/regression.spec.ts"
      provides: "Regression tests for f2e30c7 edge cases"
      contains: "regression"
  key_links:
    - from: "e2e/regression.spec.ts"
      to: "src/pages/GameView.tsx"
      via: "descent clock and error handling"
      pattern: "descent|error"
---

<objective>
Add regression tests for edge cases fixed in commit f2e30c7 and verify the full test suite passes as a final validation.

Purpose: Commit f2e30c7 fixed 8 edge cases across conviction testing, dialogue streaming errors, and journey phase transitions. This plan adds targeted regression tests to prevent these from recurring, and validates the entire suite (now 50+ tests) passes together.

Output: Regression spec file covering key edge cases from f2e30c7.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@e2e/descent-clock.spec.ts
@e2e/steps/free-roam.steps.ts
@e2e/steps/character.steps.ts
@src/pages/GameView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regression tests for f2e30c7 edge cases</name>
  <files>e2e/regression.spec.ts</files>
  <action>
Create `e2e/regression.spec.ts` with targeted tests for edge cases fixed in commit f2e30c7.

The key fixes in f2e30c7 were:
1. ConvictionReflection reading from `completedTowns` not `pendingTests` (covered by journey.spec.ts Plan 03)
2. Dialogue streaming error handling (stream fails gracefully)
3. Journey phase transition guards (invalid phase transitions ignored)
4. Descent clock advancement beyond max (capped at 8)
5. Empty conviction list handling in reflection

Tests to include:

1. **"descent clock does not advance beyond maximum"**
   - Setup character, navigate between locations performing timed actions
   - Advance descent to 7/8 (or as high as possible with available actions)
   - Verify descent never shows a value > 8
   - Use repeatable actions (pray-chapel) to push past 8
   - After 8+ actions, verify display still shows 8/8

2. **"dialogue handles streaming error gracefully"**
   - Mock `/api/dialogue` to return HTTP 500 error
   - Setup character, navigate to NPC, start conversation
   - Select topic and dialogue option
   - Verify NO crash (page doesn't show error overlay or blank screen)
   - Verify dialogue view remains visible (not dismissed)
   - Verify user can still end conversation (dialogue-leave button works)

3. **"empty dialogue response doesn't crash"**
   - Mock `/api/dialogue` to return empty body (200 OK, empty string)
   - Setup character, start conversation, select topic
   - Verify dialogue view doesn't crash
   - Verify user can continue or leave

4. **"multiple rapid topic selections don't cause race condition"**
   - Mock `/api/dialogue` with a 1-second delay before responding
   - Setup character, start conversation
   - Click topic chip, then immediately click it again (or another topic)
   - Verify no duplicate responses or crashes
   - Verify final state is coherent (single response displayed)

5. **"town selection works after journey reset"**
   - This tests that returning to town selection (from journey progress) properly resets state
   - Setup character, play to judgment (if dev trigger available from Plan 03)
   - If journey dev triggers are available: trigger judgment -> complete -> reflection -> advance
   - Verify town-selection screen reappears
   - Verify can select a town and start new game

Import helpers from character.steps, free-roam.steps, investigation.steps as needed.

Note: Some of these tests overlap with descent-clock.spec.ts (which tests advancement) but focus specifically on boundary conditions (max value, error states).
  </action>
  <verify>
`npx playwright test e2e/regression.spec.ts --reporter=list` - all 5 tests pass.
Then run the FULL suite: `npx playwright test --reporter=list` - ALL tests pass (target: 50+ tests).
  </verify>
  <done>Regression tests cover key f2e30c7 edge cases: descent clock overflow, dialogue error handling, empty responses, race conditions, and journey reset. Full suite of 50+ tests passes.</done>
</task>

<task type="auto">
  <name>Task 2: Full suite validation and test count verification</name>
  <files></files>
  <action>
Run the complete E2E test suite and verify all tests pass together. This is a validation task - no files to modify.

Steps:
1. Run `npx playwright test --reporter=list` to see all tests
2. Verify total test count is >= 50 (34 existing + 5 character-creation + 4 dialogue-rework + 5 journey + 4 trust + 5 regression = ~57)
3. Verify no flaky tests (run twice if first run has failures)
4. If any test fails, investigate and fix the issue

Phase 6.2 success criteria check:
- [x] All existing E2E tests pass (Plan 01)
- [x] Character creation wizard has E2E coverage (Plan 02)
- [x] Descent clock mechanics have E2E coverage (existing descent-clock.spec.ts + regression tests)
- [x] Dialogue rework has E2E coverage (Plan 02)
- [x] Journey flow has E2E coverage (Plan 03)
- [x] Trust mechanics have E2E coverage (Plan 04)
- [x] Edge cases from f2e30c7 are covered by regression tests (Plan 05)

If any criteria is not met, add the missing test to regression.spec.ts.
  </action>
  <verify>
`npx playwright test --reporter=list` shows 50+ tests, all passing. Run output shows 0 failures.
  </verify>
  <done>Full E2E suite passes. All Phase 6.2 success criteria are met. Total test count is 50+ covering all Phase 6.1 systems.</done>
</task>

</tasks>

<verification>
- `npx playwright test --reporter=list` shows 50+ tests, all passing
- All 7 Phase 6.2 success criteria are met
- No flaky tests (consistent pass on repeated runs)
</verification>

<success_criteria>
Full suite of 50+ E2E tests passes consistently. All Phase 6.1 systems (character creation, descent clock, dialogue rework, journey, trust, edge cases) have coverage. Phase 6.2 is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-05-SUMMARY.md`
</output>
