---
phase: 06.2-e2e-test-overhaul
plan: 05
type: execute
wave: 3
depends_on: ["06.2-02", "06.2-03", "06.2-04"]
files_modified:
  - e2e/regression.spec.ts
autonomous: true

must_haves:
  truths:
    - "Existing descent-clock.spec.ts tests pass (5 tests covering advancement, thresholds, locked actions, repeatable actions)"
    - "Descent clock does not advance beyond maximum (8/8 cap)"
    - "Dialogue streaming errors are handled gracefully (no crash)"
    - "Conversation ends after 3 exchanges (trust farming prevention)"
    - "Conviction transform sets lifecycle to 'held' (must be re-tested)"
    - "Duty category convictions trigger testing on hate-and-murder discovery"
    - "Empty/whitespace conviction text is rejected (trim guard)"
    - "All E2E tests pass in a single full suite run"
  artifacts:
    - path: "e2e/regression.spec.ts"
      provides: "Regression tests for 8 f2e30c7 edge cases (9 tests covering cases #2-5, #7-8)"
      contains: "regression"
    - path: "e2e/descent-clock.spec.ts"
      provides: "Core descent clock mechanics coverage (5 existing tests)"
      contains: "Descent Clock"
  key_links:
    - from: "e2e/regression.spec.ts"
      to: "src/pages/GameView.tsx"
      via: "descent clock overflow and error handling"
      pattern: "descent|error"
    - from: "e2e/regression.spec.ts"
      to: "src/reducers/dialogueReducer.ts"
      via: "exchange cap enforcement"
      pattern: "exchange|conversation"
    - from: "e2e/regression.spec.ts"
      to: "src/reducers/journeyReducer.ts"
      via: "conviction transform lifecycle and whitespace guard"
      pattern: "transform|trim|lifecycle"
    - from: "e2e/regression.spec.ts"
      to: "src/utils/convictionTesting.ts"
      via: "duty category discovery testing"
      pattern: "duty|hate-and-murder"
---

<objective>
Add regression tests for edge cases fixed in commit f2e30c7 and verify the full test suite passes as a final validation.

Purpose: Commit f2e30c7 fixed 8 edge cases across conviction testing, dialogue streaming errors, and journey phase transitions. This plan adds targeted regression tests to prevent these from recurring, and validates the entire suite (now 50+ tests) passes together. The existing descent-clock.spec.ts (5 tests) already satisfies Phase 6.2 success criterion #3 (descent clock mechanics coverage).

Output: Regression spec file covering key edge cases from f2e30c7.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@e2e/descent-clock.spec.ts
@e2e/steps/free-roam.steps.ts
@e2e/steps/character.steps.ts
@src/reducers/dialogueReducer.ts
@src/reducers/journeyReducer.ts
@src/utils/convictionTesting.ts
@src/components/Conviction/ConvictionReflection.tsx
@src/pages/GameView.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Regression tests for f2e30c7 edge cases</name>
  <files>e2e/regression.spec.ts</files>
  <action>
Create `e2e/regression.spec.ts` with targeted tests for edge cases fixed in commit f2e30c7.

The 8 edge cases from f2e30c7 and their coverage status:
- #1 (pendingTests → completedTowns): Covered by Plan 03 journey tests
- #5 (STREAM_ERROR): Covered by streaming error test below
- #6 (SET_PHASE during render → useEffect): Implementation detail, no E2E needed
- #7 (double-click guard): Covered by rapid topic selection test below
- #2, #3, #4, #8: NEW tests below

Tests to include (9 total):

1. **"descent clock does not advance beyond maximum"**
   - Setup character, navigate to church (has repeatable pray-chapel action)
   - Use repeatable action (pray-chapel) 9+ times to push past max of 8
   - After each action, verify descent never shows a value > 8
   - Final check: descent display shows 8/8

2. **"dialogue handles streaming error gracefully"**
   - Mock `/api/dialogue` to return HTTP 500 error
   - Setup character, navigate to NPC, start conversation
   - Select topic and dialogue option
   - Verify NO crash (page doesn't show error overlay or blank screen)
   - Verify dialogue view remains visible (not dismissed)
   - Verify user can still end conversation (dialogue-leave button works)

3. **"empty dialogue response doesn't crash"**
   - Mock `/api/dialogue` to return empty body (200 OK, empty string)
   - Setup character, start conversation, select topic
   - Verify dialogue view doesn't crash
   - Verify user can continue or leave

4. **"multiple rapid topic selections don't cause race condition"**
   - Mock `/api/dialogue` with a 1-second delay before responding
   - Setup character, start conversation
   - Click topic chip, then immediately click it again (or another topic)
   - Verify no duplicate responses or crashes
   - Verify final state is coherent (single response displayed)

5. **"town selection works after journey reset"**
   - Tests that returning to town selection (from journey progress) properly resets state
   - Setup character, play to judgment (if dev trigger available from Plan 03)
   - If journey dev triggers are available: trigger judgment -> complete -> reflection -> advance
   - Verify town-selection screen reappears
   - Verify can select a town and start new game

6. **"conviction transform sets lifecycle to held not resolved"**
   - This tests edge case #2: transform was previously resolving immediately
   - Setup character with a conviction, advance to reflection phase (use dev triggers from Plan 03 if available)
   - In ConvictionReflection, enter transform text and submit
   - Verify the conviction is NOT marked resolved (still appears in active convictions list)
   - Verify the conviction text is updated to the new value
   - If reflection UI shows lifecycle status, verify it shows 'held' not 'resolved'

7. **"duty category conviction triggers testing on hate-and-murder discovery"**
   - This tests edge case #3: duty convictions should be tested when hate-and-murder sin is discovered
   - Setup character with a duty-category conviction
   - Navigate to NPC, start dialogue
   - Mock `/api/dialogue` to return response with [DISCOVERY: fact-id|hate-and-murder-sin|Murder discovered] marker
   - Select topic and option to trigger the discovery
   - Verify conviction testing is triggered (conviction test UI appears or conviction status changes)

8. **"conversation ends after 3 exchanges"**
   - This tests edge case #4: conversations are capped at 3 exchanges to prevent trust farming
   - Setup character, navigate to NPC, start conversation
   - Mock `/api/dialogue` to return valid responses (no discoveries)
   - Complete 3 full exchanges (select topic -> select option -> receive response, x3)
   - After 3rd exchange completes, verify conversation automatically ends
   - Verify player is returned to location view (not still in dialogue)

9. **"whitespace-only conviction text is rejected"**
   - This tests edge case #8: empty/whitespace conviction text should be rejected by trim guard
   - Setup character, advance to reflection phase with a testable conviction
   - In ConvictionReflection transform mode, attempt to submit with only spaces/whitespace
   - Verify the "Transform" button remains disabled (disabled when trimmed length < 3)
   - Enter valid text (3+ chars after trim), verify button becomes enabled

Import helpers from character.steps, free-roam.steps, investigation.steps as needed.

Note: Tests 6, 7, 8, 9 may require dev triggers for journey progression and conviction testing. If dev triggers from Plan 03 are not sufficient, add minimal dev-mode helpers (guarded by import.meta.env.DEV) to expose reflection/testing state.
  </action>
  <verify>
`npx playwright test e2e/regression.spec.ts --reporter=list` - all 9 tests pass.
Then run the FULL suite: `npx playwright test --reporter=list` - ALL tests pass (target: 50+ tests).
  </verify>
  <done>Regression tests cover f2e30c7 edge cases: descent clock overflow (#boundary), streaming errors (#5), empty responses, race conditions (#7), journey reset, conviction transform lifecycle (#2), duty category testing (#3), exchange cap (#4), and whitespace validation (#8). Full suite of 50+ tests passes.</done>
</task>

<task type="auto">
  <name>Task 2: Full suite validation and test count verification</name>
  <files></files>
  <action>
Run the complete E2E test suite and verify all tests pass together. This is a validation task - no files to modify.

Steps:
1. Run `npx playwright test --reporter=list` to see all tests
2. Verify total test count is >= 50 (34 existing + 5 character-creation + 4 dialogue-rework + 5 journey + 4 trust + 9 regression = ~61)
3. Verify no flaky tests (run twice if first run has failures)
4. If any test fails, investigate and fix the issue

Phase 6.2 success criteria check:
- [x] All existing E2E tests pass (Plan 01)
- [x] Character creation wizard has E2E coverage (Plan 02)
- [x] Descent clock mechanics have E2E coverage (existing descent-clock.spec.ts: 5 tests covering advancement, thresholds, one-shot, locked, repeatable)
- [x] Dialogue rework has E2E coverage (Plan 02)
- [x] Journey flow has E2E coverage (Plan 03)
- [x] Trust mechanics have E2E coverage (Plan 04)
- [x] Edge cases from f2e30c7 are covered by regression tests (Plan 05: 9 tests covering cases #2, #3, #4, #5, #7, #8 plus boundary/error tests)

Descent clock criterion #3 is satisfied by the existing descent-clock.spec.ts which already tests:
- Timed action advances descent by 1
- One-shot actions disappear after use
- Locked actions cannot be clicked
- Threshold events trigger at correct descent values
- Repeatable actions can be used multiple times
Plus the regression test adds overflow boundary protection (cannot exceed 8/8).

If any criteria is not met, add the missing test to regression.spec.ts.
  </action>
  <verify>
`npx playwright test --reporter=list` shows 50+ tests, all passing. Run output shows 0 failures.
  </verify>
  <done>Full E2E suite passes. All Phase 6.2 success criteria are met. Total test count is 50+ covering all Phase 6.1 systems. Descent clock criterion explicitly verified via existing descent-clock.spec.ts (5 tests) plus regression overflow test.</done>
</task>

</tasks>

<verification>
- `npx playwright test --reporter=list` shows 50+ tests, all passing
- All 7 Phase 6.2 success criteria are met (including descent clock via existing spec)
- No flaky tests (consistent pass on repeated runs)
- f2e30c7 edge cases #2, #3, #4, #5, #7, #8 all have regression coverage
</verification>

<success_criteria>
Full suite of 50+ E2E tests passes consistently. All Phase 6.1 systems (character creation, descent clock, dialogue rework, journey, trust, edge cases) have coverage. Descent clock criterion satisfied by existing descent-clock.spec.ts (5 tests) plus regression overflow boundary test. All 8 f2e30c7 edge cases accounted for (6 with explicit E2E tests, 1 covered by Plan 03, 1 implementation-only fix needing no E2E). Phase 6.2 is complete.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-05-SUMMARY.md`
</output>
