---
phase: 06.2-e2e-test-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified:
  - e2e/character-creation.spec.ts
  - e2e/dialogue-rework.spec.ts
autonomous: true

must_haves:
  truths:
    - "Player can complete the full 6-step character creation wizard and see their character in the sidebar"
    - "Player can select conviction seeds during creation and they persist"
    - "Player sees dialogue option cards with tone/stat indicators after selecting a topic"
    - "Player can press the matter when an NPC deflects and enter conflict via approach selection"
  artifacts:
    - path: "e2e/character-creation.spec.ts"
      provides: "E2E coverage for 6-step wizard including convictions"
      contains: "conviction"
    - path: "e2e/dialogue-rework.spec.ts"
      provides: "E2E coverage for player voice options and Press the Matter"
      contains: "dialogue-option"
  key_links:
    - from: "e2e/character-creation.spec.ts"
      to: "src/components/Conviction/ConvictionPicker.tsx"
      via: "data-testid selectors"
      pattern: "conviction-seed|conviction-confirm"
    - from: "e2e/dialogue-rework.spec.ts"
      to: "src/components/Dialogue/DialogueOptionCard.tsx"
      via: "data-testid selectors"
      pattern: "dialogue-option-"
---

<objective>
Add E2E coverage for the character creation wizard (6-step flow with convictions) and the dialogue rework (player voice options, "Press the Matter" conflict entry).

Purpose: Phase 6.1 added a conviction picker step to character creation and replaced approach chips with player voice dialogue options. These core user flows need E2E test coverage to prevent regressions.

Output: Two new spec files with comprehensive test scenarios.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@src/components/Character/CharacterCreation.tsx
@src/components/Conviction/ConvictionPicker.tsx
@src/components/Dialogue/DialogueView.tsx
@src/components/Dialogue/DialogueOptionCard.tsx
@src/data/convictionSeeds.ts
@e2e/steps/character.steps.ts
@e2e/steps/investigation.steps.ts
@e2e/fixtures/dialogue-recordings.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Character creation wizard E2E with convictions</name>
  <files>e2e/character-creation.spec.ts</files>
  <action>
Create a new spec file `e2e/character-creation.spec.ts` with focused tests on the full 6-step wizard, especially the conviction step. Import helpers from character.steps.ts.

Tests to include:

1. **"full 6-step wizard creates character with convictions"**
   - Navigate to app, select Bridal Falls
   - Step 1: Enter name "Brother Ezekiel", click Continue
   - Step 2: Select `well-rounded` background
   - Step 3: Allocate stats (3/3/2/2), click Continue
   - Step 4: Select 2 belongings, click Continue
   - Step 5: Select first initiation approach, click Continue (creation-to-convictions)
   - Step 6: Select 3 conviction seeds, verify "0 remaining" text appears, click "These Are My Beliefs"
   - Verify: creation modal dismissed, character name appears in sidebar, skip arrival

2. **"conviction picker enforces exactly 3 selections"**
   - Progress to step 6 (convictions)
   - Click 1 conviction seed -> verify "2 remaining" text
   - Click 2nd conviction seed -> verify "1 remaining" text
   - Verify `conviction-confirm` button is disabled (2 < 3)
   - Click 3rd conviction seed -> verify "0 remaining" text
   - Verify `conviction-confirm` button is enabled
   - Click 4th conviction seed -> verify it does NOT get selected (still 3 selected, 4th is disabled)

3. **"conviction picker allows deselection"**
   - Progress to step 6
   - Select 3 convictions
   - Click first selected conviction again -> verify it deselects (back to "1 remaining")
   - Verify confirm button is disabled

4. **"back button from convictions returns to initiation"**
   - Progress to step 6
   - Click "Back" button in ConvictionPicker
   - Verify initiation scene is visible again (approach buttons visible)

5. **"character creation with complicated-history background"**
   - Tests a different background path (8 stat points, allocation 2/2/2/2)
   - Verify the reduced stat points work (can't allocate as much)
   - Complete through convictions
   - Verify character in sidebar

Use the existing pattern: `test.describe('Character Creation Wizard', () => { ... })`. Select Bridal Falls in beforeEach. Use helpers where possible, inline steps for conviction-specific assertions.
  </action>
  <verify>
`npx playwright test e2e/character-creation.spec.ts --reporter=list` - all 5 tests pass.
  </verify>
  <done>Character creation wizard has comprehensive E2E coverage including the conviction step, enforcement of 3 selections, deselection, navigation, and multiple backgrounds.</done>
</task>

<task type="auto">
  <name>Task 2: Dialogue rework E2E with player voice options</name>
  <files>e2e/dialogue-rework.spec.ts</files>
  <action>
Create a new spec file `e2e/dialogue-rework.spec.ts` focused on the Phase 6.1 dialogue changes: player voice options and improved "Press the Matter" flow.

The dialogue API must be mocked via route interception. The mock should return responses that include player voice option triggers. The dialogue flow now works:
1. Select topic -> API generates player voice options (DialogueOptionCards appear)
2. Player clicks an option -> API streams NPC response
3. If NPC deflects, "Press the Matter" appears

For player voice options to appear, the mock API response needs to include `[OPTIONS]` markers or the dialogue reducer needs to transition to SELECTING_OPTION phase. Check how the existing investigation.spec.ts mocks work and adapt.

Actually, looking at the DialogueView and useDialogue code, player voice options are generated client-side from the topic context. The mock should return the NPC response text. The SELECTING_OPTION phase shows DialogueOptionCards before the API call.

Tests to include:

1. **"player sees voice options after selecting a topic"**
   - Mock `/api/dialogue` route with a generic response
   - Setup character, navigate to NPC location (general-store for sister-martha)
   - Start conversation, verify topic chips visible
   - Click a topic chip
   - Verify dialogue option cards appear (`[data-testid^="dialogue-option-"]`)
   - Verify at least 2 options are shown
   - Verify each option has tone text visible (e.g., "compassionate", "authoritative")

2. **"selecting a dialogue option triggers NPC response"**
   - Mock `/api/dialogue` with response text
   - Setup character, navigate to NPC, start conversation
   - Select topic, wait for options
   - Click first dialogue option
   - Wait for streaming response (dialogue-continue button appears)
   - Verify response text appears in dialogue view

3. **"Press the Matter appears after NPC deflection"**
   - Mock `/api/dialogue` to return `[DEFLECTED]` response
   - Setup character, navigate to sheriff's office (sheriff-jacob)
   - Start conversation, select trust-gated topic
   - Select a dialogue option (if options appear)
   - Wait for response
   - Verify `press-the-matter` button appears

4. **"Press the Matter leads to approach selection then conflict"**
   - Mock `/api/dialogue` to return deflection
   - Complete steps above to get "Press the Matter" visible
   - Click "Press the Matter"
   - Verify `approach-selection-overlay` appears
   - Click `select-approach-body`
   - Verify `conflict-view` appears

Use pattern from investigation.spec.ts for route interception. Import `setupCharacterForTest` and `skipArrivalOverlay` from character.steps, and `startConversation` from investigation.steps.
  </action>
  <verify>
`npx playwright test e2e/dialogue-rework.spec.ts --reporter=list` - all 4 tests pass.
  </verify>
  <done>Dialogue rework has E2E coverage for player voice options (tone indicators, option selection) and "Press the Matter" conflict entry flow.</done>
</task>

</tasks>

<verification>
- `npx playwright test e2e/character-creation.spec.ts e2e/dialogue-rework.spec.ts --reporter=list` - all 9 new tests pass
- Existing 34 tests still pass: `npx playwright test --reporter=list`
- Total test count is now 43
</verification>

<success_criteria>
Character creation wizard E2E covers the 6-step flow including conviction picker enforcement. Dialogue rework E2E covers player voice options and "Press the Matter" conflict entry. All tests pass.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-02-SUMMARY.md`
</output>
