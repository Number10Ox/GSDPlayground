---
phase: 06.2-e2e-test-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - e2e/steps/character.steps.ts
  - e2e/steps/free-roam.steps.ts
  - e2e/steps/investigation.steps.ts
  - e2e/steps/conflict.steps.ts
autonomous: true

must_haves:
  truths:
    - "All 34 existing E2E tests pass without modification to spec files"
    - "Character creation helpers complete the full 6-step wizard including convictions"
    - "Conflict start helper handles approach selection overlay"
  artifacts:
    - path: "e2e/steps/character.steps.ts"
      provides: "Fixed setupCharacterForTest with conviction step"
      contains: "conviction-seed"
    - path: "e2e/steps/free-roam.steps.ts"
      provides: "Fixed createCharacter with conviction step"
      contains: "conviction-seed"
    - path: "e2e/steps/investigation.steps.ts"
      provides: "Fixed createCharacterForTest with conviction step"
      contains: "conviction-seed"
    - path: "e2e/steps/conflict.steps.ts"
      provides: "Fixed startConflict with approach selection"
      contains: "approach-selection-overlay"
  key_links:
    - from: "e2e/steps/character.steps.ts"
      to: "src/components/Conviction/ConvictionPicker.tsx"
      via: "data-testid selectors"
      pattern: "conviction-seed|conviction-confirm"
    - from: "e2e/steps/conflict.steps.ts"
      to: "src/components/Conflict/ConflictView.tsx"
      via: "approach selection overlay"
      pattern: "approach-selection-overlay|select-approach"
---

<objective>
Fix all existing E2E test step helpers to work with Phase 6.1 architectural changes.

Purpose: Phase 6.1 changed character creation from 5 steps to 6 (added convictions), replaced direct conflict entry with approach selection overlay, and removed several components. The existing step helpers skip the conviction step and don't handle the approach overlay, causing all tests that create characters or start conflicts to fail.

Output: Updated step helper files that make all 34 existing tests pass without modifying spec files.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@e2e/steps/character.steps.ts
@e2e/steps/free-roam.steps.ts
@e2e/steps/investigation.steps.ts
@e2e/steps/conflict.steps.ts
@src/components/Character/CharacterCreation.tsx
@src/components/Conviction/ConvictionPicker.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix character creation step helpers to include conviction step</name>
  <files>
    e2e/steps/character.steps.ts
    e2e/steps/free-roam.steps.ts
    e2e/steps/investigation.steps.ts
  </files>
  <action>
Phase 6.1 changed character creation: after initiation (step 5), there is now a "Continue" button (`data-testid="creation-to-convictions"`) that advances to step 6 (ConvictionPicker). The old `creation-confirm` button no longer exists at step 5.

The ConvictionPicker requires selecting exactly 3 conviction seeds, then clicking "These Are My Beliefs" (`data-testid="conviction-confirm"`). The conviction seeds have testids like `conviction-seed-mercy-faithful`, `conviction-seed-justice-punished`, `conviction-seed-faith-doctrine`.

Update ALL three character creation helpers:

1. **e2e/steps/character.steps.ts** - `selectInitiationApproach()`: After clicking the approach button, do NOT call confirmCreation. Instead add a new step: click `creation-to-convictions` to advance to convictions step.
   - Add new helper `selectConvictions(page)`: clicks 3 conviction seeds (`conviction-seed-mercy-faithful`, `conviction-seed-justice-punished`, `conviction-seed-faith-doctrine`), then clicks `conviction-confirm`.
   - Update `setupCharacterForTest()`: call `selectInitiationApproach()` then `selectConvictions()` (remove `confirmCreation()` call since ConvictionPicker's onConfirm handles creation).
   - Update `confirmCreation()`: This is now handled by the conviction confirm button. Change it to wait for `creation-name-input` to disappear (same as before, but the trigger is now `conviction-confirm` click).
   - The full sequence in setupCharacterForTest should be: openCharacterCreation -> enterCharacterName -> selectBackground -> allocateStatDice (x4) -> allocateNext click -> selectBelongings -> selectInitiationApproach -> selectConvictions -> skipArrivalOverlay

2. **e2e/steps/free-roam.steps.ts** - `createCharacter()`: After step 5 (initiation approach click), add: click `creation-to-convictions`, then select 3 conviction seeds and click `conviction-confirm`. Remove the `creation-confirm` click that currently follows initiation.

3. **e2e/steps/investigation.steps.ts** - `createCharacterForTest()`: Same fix as free-roam.steps.ts. After initiation approach click, click `creation-to-convictions`, select 3 convictions, click `conviction-confirm`. Remove the old `creation-confirm` click.

IMPORTANT: The conviction seeds have IDs from convictionSeeds.ts. Use these exact IDs for deterministic selection:
- `mercy-faithful` ("The faithful deserve mercy")
- `justice-punished` ("Sin must be punished openly")
- `faith-doctrine` ("Doctrine stands above personal feeling")

Wait for each conviction seed button to be visible before clicking (the ConvictionPicker renders after the step transition animation).
  </action>
  <verify>
Run `npx playwright test e2e/free-roam.spec.ts --reporter=list` - all 4 tests should pass (they exercise createCharacter + skipArrival).
  </verify>
  <done>All character creation helpers include the conviction selection step. The old `creation-confirm` path is replaced with `creation-to-convictions` -> conviction selection -> `conviction-confirm`.</done>
</task>

<task type="auto">
  <name>Task 2: Fix conflict start helper and verify all existing tests pass</name>
  <files>
    e2e/steps/conflict.steps.ts
  </files>
  <action>
The `startConflict()` function in conflict.steps.ts clicks `start-test-conflict` and immediately expects `conflict-view` to be visible. Phase 6.1 now shows an approach selection overlay first.

Update `startConflict()`:
1. Click `start-test-conflict`
2. Wait for `approach-selection-overlay` to be visible (timeout: 3000)
3. Click `select-approach-body` (default to body approach for tests)
4. THEN expect `conflict-view` to be visible (timeout: 5000)
5. Continue with the existing `conflict-stakes` assertion

Note: The `triggerConflictForTest()` in character.steps.ts already handles this correctly. Make conflict.steps.ts `startConflict()` match that pattern.

Also check: The `advanceCycle()` helper in investigation.steps.ts references deleted components (DicePool, die, action-card, confirm-allocations-button, continue-button, next-day-button). This function is NOT called by any current spec file (it was for the old daily cycle system). Leave it in place but add a comment noting it is deprecated/unused since Phase 6.1 removed the daily cycle.
  </action>
  <verify>
Run `npx playwright test --reporter=list` for the full suite. All 34 tests should pass. Specifically verify:
- `npx playwright test e2e/conflict.spec.ts` - 7 tests pass
- `npx playwright test e2e/character.spec.ts` - 7 tests pass
- `npx playwright test e2e/investigation.spec.ts` - 5 tests pass
- `npx playwright test e2e/town-generation.spec.ts` - 6 tests pass
  </verify>
  <done>All 34 existing E2E tests pass against the current codebase. The startConflict helper handles the approach selection overlay. No spec files were modified.</done>
</task>

</tasks>

<verification>
- `npx playwright test --reporter=list` shows 34 tests, all passing
- No spec files (*.spec.ts) were modified - only step helper files
- Character creation helpers include conviction step (grep for "conviction-seed" in step files)
- Conflict start helper handles approach overlay (grep for "approach-selection-overlay" in conflict.steps.ts)
</verification>

<success_criteria>
All 34 existing E2E tests pass with the updated step helpers. The test infrastructure is stable for subsequent plans to add new coverage.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-01-SUMMARY.md`
</output>
