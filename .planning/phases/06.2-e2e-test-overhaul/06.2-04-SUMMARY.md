# Phase 6.2 Plan 04: Trust Mechanics E2E Summary

Trust data-testid attributes added and 4 E2E tests covering trust visibility, conflict reduction, trust breaking, and broken cap persistence.

## Execution Details

- **Duration:** ~6 min
- **Completed:** 2026-01-24
- **Tasks:** 2/2
- **Tests added:** 4

## Commits

| Hash | Message |
|------|---------|
| 9b056c6 | feat(06.2-04): add trust data-testid attributes and dev buttons |
| 1384baf | test(06.2-04): add trust mechanics E2E spec |

## What Was Built

### Task 1: Trust data-testid attributes and dev buttons

**Files modified:**
- `src/components/NPCMemory/RelationshipPanel.tsx` - Added `data-testid="trust-level-{npcId}"` with `data-trust-value` attribute, and `data-testid="trust-broken-{npcId}"` indicator
- `src/pages/GameView.tsx` - Added trust level display in NPC sidebar list, trust-broken indicator, and two dev-mode buttons (`dev-trigger-trust-break`, `dev-adjust-trust`)

**Key details:**
- Trust value exposed via `data-trust-value` attribute on trust-level elements
- Broken trust indicator visible in both sidebar NPC list and RelationshipPanel
- Dev-mode trust break button seeds trust at 50 first (above BREAK_THRESHOLD) then dispatches BREAK_TRUST
- Dev-mode adjust trust button dispatches UPDATE_RELATIONSHIP with delta +10

### Task 2: Trust mechanics E2E spec

**File created:** `e2e/trust.spec.ts`

**Tests:**
1. `trust level is visible for NPC after interaction` - Navigates to NPC location, verifies trust-level testid visible with numeric data-trust-value
2. `conflict reduces NPC trust` - Seeds trust to 20, starts physical-escalated conflict with "takes the blow", verifies trust decreased post-resolution
3. `trust breaking caps at 10` - Uses dev button to break trust, verifies broken indicator, verifies trust value at -20 (BROKEN_TRUST_PENALTY), verifies adjustment stays <= 10
4. `trust cannot exceed broken cap once broken` - Breaks trust then applies 5 positive adjustments, verifies final trust exactly equals BROKEN_TRUST_CAP (10)

## Decisions Made

| Decision | Rationale |
|----------|-----------|
| Trust level shown in NPC sidebar list (not just RelationshipPanel) | Makes trust observable without opening the panel overlay - simpler for E2E tests |
| Dev break-trust button seeds at 50 before breaking | BREAK_TRUST only breaks trust above BREAK_THRESHOLD (15) - need to establish trust first |
| Conflict trust test uses escalation + "takes the blow" | Trust penalty determined by fallout type, not player escalation level - JUST_TALKING has 0 penalty |
| Test uses dev-adjust-trust to seed trust before conflict | Conflict at JUST_TALKING has no penalty; need known starting value above 0 to verify decrease |

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Trust penalty not applied at JUST_TALKING escalation**
- **Found during:** Task 2
- **Issue:** The RECORD_CONFLICT action derives escalation level from fallout type, not player escalation. With no "takes the blow" exchanges, falloutType is SOCIAL which maps to JUST_TALKING (0 penalty).
- **Fix:** Modified test to seed trust above 0 via dev button, escalate to PHYSICAL, and ensure at least one "takes the blow" exchange occurs before giving up.
- **Files modified:** e2e/trust.spec.ts
- **Commit:** 1384baf

## Test Results

```
Running 4 tests using 4 workers

  ok  trust level is visible for NPC after interaction (4.0s)
  ok  conflict reduces NPC trust (13.1s)
  ok  trust breaking caps at 10 (4.2s)
  ok  trust cannot exceed broken cap once broken (4.1s)

4 passed (15.4s)
```

Full suite: 51/52 passed (1 pre-existing flaky test: "Taking the blow shows in bidding history" - timeout on escalation button, unrelated to trust changes).

## Key Files

| File | Role |
|------|------|
| e2e/trust.spec.ts | E2E tests for trust mechanics (4 tests) |
| src/components/NPCMemory/RelationshipPanel.tsx | Trust level + broken indicators with data-testid |
| src/pages/GameView.tsx | NPC sidebar trust display + dev-mode trust buttons |

## Next Phase Readiness

- Trust E2E coverage complete: visibility, conflict reduction, breaking, cap persistence
- Total E2E suite now: 52 tests (4 free-roam + 7 conflict + 7 character + 5 investigation + 5 journey + 6 town-gen + 5 descent-clock + 4 dialogue-rework + 5 char-creation + 4 trust)
- Plan 05 (final plan) can proceed independently
