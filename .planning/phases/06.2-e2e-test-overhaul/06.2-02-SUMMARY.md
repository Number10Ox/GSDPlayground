---
phase: 06.2-e2e-test-overhaul
plan: 02
subsystem: e2e-testing
tags: [playwright, character-creation, dialogue, convictions, player-voice]
dependency-graph:
  requires: ["06.2-01"]
  provides: ["character-creation-e2e", "dialogue-rework-e2e"]
  affects: ["06.2-05"]
tech-stack:
  added: []
  patterns: ["route-interception-for-dialogue-options", "conviction-picker-disabled-state-testing"]
key-files:
  created:
    - e2e/character-creation.spec.ts
    - e2e/dialogue-rework.spec.ts
  modified: []
decisions:
  - id: "06.2-02-01"
    description: "Test disabled state assertion instead of force-click for 4th conviction"
    rationale: "Playwright click waits for enabled state; asserting disabled directly is correct"
  - id: "06.2-02-02"
    description: "Intercept /api/dialogue-options (not just /api/dialogue) for player voice tests"
    rationale: "generateOptions() calls separate endpoint; without interception it falls back to legacy path skipping SELECTING_OPTION phase"
metrics:
  duration: "5 min"
  completed: "2026-01-24"
---

# Phase 6.2 Plan 02: Character Creation & Dialogue Rework E2E Summary

E2E coverage for the 6-step character creation wizard with conviction picker, and the Phase 6.1 dialogue rework with player voice options and "Press the Matter" conflict entry.

## What Was Done

### Task 1: Character Creation Wizard E2E (5 tests)

Created `e2e/character-creation.spec.ts` with comprehensive coverage:

1. **Full 6-step wizard** - Name, background, stats (3/3/2/2), belongings, initiation, convictions (3 seeds) -> character in sidebar
2. **Conviction enforcement** - Exactly 3 required; 4th seed becomes disabled; confirm button disabled until 3 selected
3. **Deselection** - Clicking selected conviction removes it; confirm re-disables
4. **Back navigation** - Convictions step -> Back -> initiation approach buttons visible
5. **Complicated-history background** - Tests alternate path with 8 stat points (2/2/2/2 allocation)

### Task 2: Dialogue Rework E2E (4 tests)

Created `e2e/dialogue-rework.spec.ts` with player voice and conflict entry coverage:

1. **Voice options appear** - Topic click -> /api/dialogue-options -> DialogueOptionCards with tone text ("compassionate", "inquisitive")
2. **Option triggers response** - Click dialogue option -> /api/dialogue streams NPC response -> dialogue-continue visible
3. **Press the Matter after deflection** - [DEFLECTED] marker -> acknowledge response -> press-the-matter button visible
4. **Full conflict entry** - Press the Matter -> approach-selection-overlay -> select-approach-body -> conflict-view visible

## Key Technical Details

- **Route interception pattern**: Both `/api/dialogue-options` (returns JSON with options array) and `/api/dialogue` (returns streaming text) intercepted
- **SELECTING_OPTION phase**: Only reachable when `/api/dialogue-options` succeeds; without interception, dev-mode falls back to legacy `sendMessage` path
- **Conviction disabled state**: When 3 seeds selected, remaining seeds have `disabled` attribute; tested via `toBeDisabled()` assertion
- **Test IDs used**: `conviction-seed-{id}`, `conviction-confirm`, `creation-to-convictions`, `dialogue-option-{id}`, `press-the-matter`, `approach-selection-overlay`, `select-approach-body`, `conflict-view`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed conviction picker enforcement test approach**
- **Found during:** Task 1, initial test run
- **Issue:** Test tried to `.click()` on disabled 4th conviction seed; Playwright waits for element to become enabled, causing timeout
- **Fix:** Changed to assert `toBeDisabled()` state directly, which is the correct verification pattern
- **Files modified:** `e2e/character-creation.spec.ts`
- **Commit:** 18e5cf4

## Test Results

- 9 new tests: all passing
- Total suite: 52 tests (51 pass, 1 pre-existing flaky test in trust.spec.ts unrelated to changes)
- The flaky test (`conflict reduces NPC trust`) depends on random conflict outcomes and was already intermittent before this plan

## Commits

| Hash | Message |
|------|---------|
| 18e5cf4 | feat(06.2-02): character creation wizard E2E with convictions |
| 5a29bf3 | feat(06.2-02): dialogue rework E2E with player voice options |
