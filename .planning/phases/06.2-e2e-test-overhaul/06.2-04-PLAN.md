---
phase: 06.2-e2e-test-overhaul
plan: 04
type: execute
wave: 2
depends_on: ["06.2-01"]
files_modified:
  - e2e/trust.spec.ts
  - src/hooks/useNPCMemory.tsx
  - src/components/NPCMemory/RelationshipPanel.tsx
autonomous: true

must_haves:
  truths:
    - "Trust level is visible in the UI during NPC interactions"
    - "Trust changes after conflict affect NPC behavior"
    - "Trust breaking permanently caps trust at 10"
    - "Trust ripple affects connected NPCs"
  artifacts:
    - path: "e2e/trust.spec.ts"
      provides: "E2E coverage for trust mechanics"
      contains: "trust"
    - path: "src/hooks/useNPCMemory.tsx"
      provides: "Trust state with testable data attributes"
      contains: "data-testid"
    - path: "src/components/NPCMemory/RelationshipPanel.tsx"
      provides: "Trust display with data-testid"
      contains: "trust-level"
  key_links:
    - from: "e2e/trust.spec.ts"
      to: "src/hooks/useNPCMemory.tsx"
      via: "trust state changes"
      pattern: "BREAK_TRUST|ADJUST_TRUST"
    - from: "e2e/trust.spec.ts"
      to: "src/components/NPCMemory/RelationshipPanel.tsx"
      via: "data-testid selectors"
      pattern: "trust-level|trust-broken"
---

<objective>
Add E2E coverage for trust mechanics: trust changes, trust ripple effects, and trust breaking.

Purpose: Phase 6.1 introduced trust ripple (affecting connected NPCs) and trust breaking (permanent cap at 10). These edge cases were fixed in f2e30c7. Since no data-testid attributes exist for trust, we need to add them to make trust state observable in tests.

Output: Trust spec file with coverage for trust changes, ripple, and breaking. Minor component updates with data-testid attributes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/intel/summary.md
@src/hooks/useNPCMemory.tsx
@src/components/NPCMemory/RelationshipPanel.tsx
@src/components/NPCMemory/ConflictMarker.tsx
@src/types/npc.ts
@src/pages/GameView.tsx
@e2e/steps/character.steps.ts
@e2e/steps/conflict.steps.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add trust data-testid attributes to components</name>
  <files>
    src/components/NPCMemory/RelationshipPanel.tsx
    src/pages/GameView.tsx
  </files>
  <action>
The trust system has no data-testid attributes, making it untestable via E2E. Add minimal testid attributes:

1. **RelationshipPanel.tsx** - Add data attributes to expose trust state:
   - On the trust level display element: `data-testid="trust-level-{npcId}"` and `data-trust-value="{trustValue}"`
   - On the trust broken indicator (if showing): `data-testid="trust-broken-{npcId}"`
   - Read the existing component to understand its structure, then add these attributes to the appropriate elements that show trust information.

2. **GameView.tsx** - Add a dev-mode button to trigger trust-affecting actions:
   - `data-testid="dev-trigger-trust-break"` - Dispatches `BREAK_TRUST` for the first NPC in the current location's NPC list. Only renders when `import.meta.env.DEV` is true.
   - `data-testid="dev-adjust-trust"` - Dispatches a positive trust adjustment (+10) for the first NPC at current location. Only in dev mode.
   - These follow the existing pattern of `start-test-conflict` and `add-test-trait` dev buttons.

IMPORTANT: Keep changes minimal. Only add data-testid attributes and dev buttons. Do not refactor existing components.

Check how RelationshipPanel currently renders trust. It may show a number, a bar, or descriptive text. Add the testid to whatever element displays the trust value. If trust is shown as part of the NPC button/list, add it there.
  </action>
  <verify>
`npx tsc --noEmit` passes (TypeScript compilation). The dev buttons render only in dev mode. Existing tests still pass: `npx playwright test e2e/free-roam.spec.ts --reporter=list`.
  </verify>
  <done>Trust state is observable via data-testid attributes. Dev-mode buttons enable controlled trust manipulation for E2E tests.</done>
</task>

<task type="auto">
  <name>Task 2: Trust mechanics E2E spec</name>
  <files>e2e/trust.spec.ts</files>
  <action>
Create `e2e/trust.spec.ts` testing trust mechanics with the dev-mode triggers.

The trust system works:
- NPCs start with default trust (50 from NPCMemoryState initial)
- Conflicts with NPCs reduce trust (relationship penalties from Phase 3)
- Trust ripple: when trust breaks for one NPC, connected NPCs also lose trust
- Trust breaking: when betrayed while trust is below BREAK_THRESHOLD, trust caps permanently at BROKEN_TRUST_CAP (10)
- Trust broken NPCs have `trustBroken: true` in their memory

Tests to include:

1. **"trust level is visible for NPC after interaction"**
   - Setup character, navigate to NPC location
   - Start conversation with NPC (this initializes their memory)
   - End conversation
   - Verify trust level attribute is visible for that NPC
   - Check `data-trust-value` shows initial trust (50)

2. **"conflict reduces NPC trust"**
   - Setup character
   - Start a test conflict (uses approach selection + conflict)
   - Complete conflict (raise, give up -> resolution -> dismiss)
   - Verify trust level for the conflict NPC has decreased
   - Check `data-trust-value` is less than 50

3. **"trust breaking caps at 10"**
   - Setup character
   - Use dev button `dev-trigger-trust-break` to break trust for first NPC
   - Verify `trust-broken-{npcId}` indicator is visible
   - Verify `data-trust-value` is 10 (BROKEN_TRUST_CAP)
   - Use dev button `dev-adjust-trust` to try increasing trust
   - Verify trust stays at 10 (capped by broken state)

4. **"trust cannot exceed broken cap once broken"**
   - Setup character
   - Break trust via dev button
   - Attempt positive trust change via dev button
   - Verify trust value is still 10

Note: Trust ripple tests are complex because they require multiple NPCs with known connections. If the dev buttons operate on the current location's first NPC, test with Bridal Falls' known NPC layout. The ripple test may be limited to verifying the broken indicator appears (since we can't easily verify connected NPCs changed without knowing the specific connection graph).

Import `setupCharacterForTest` and `skipArrivalOverlay` from character.steps. Import `startConflict`, `raiseWithDice`, `giveUp`, `waitForNPCTurn`, `dismissResolution` from conflict.steps.

In beforeEach: goto app, select bridal-falls, setup character.
  </action>
  <verify>
`npx playwright test e2e/trust.spec.ts --reporter=list` - all 4 tests pass.
  </verify>
  <done>Trust mechanics have E2E coverage: trust visibility, conflict-based reduction, trust breaking cap, and broken cap persistence.</done>
</task>

</tasks>

<verification>
- `npx playwright test e2e/trust.spec.ts --reporter=list` - all 4 trust tests pass
- Existing tests still pass: `npx playwright test --reporter=list`
- Trust data-testid attributes are minimal and non-intrusive
- Dev-mode buttons only render in development builds
</verification>

<success_criteria>
Trust mechanics have E2E coverage proving: trust is observable, conflicts reduce trust, trust breaking caps at 10, and broken cap persists. Data-testid additions are minimal.
</success_criteria>

<output>
After completion, create `.planning/phases/06.2-e2e-test-overhaul/06.2-04-SUMMARY.md`
</output>
