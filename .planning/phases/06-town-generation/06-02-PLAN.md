---
phase: 06-town-generation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/templates/npcArchetypes.ts
  - src/templates/relationshipPatterns.ts
  - src/generators/npcGenerator.ts
autonomous: true

must_haves:
  truths:
    - "NPCs are generated with roles linked to specific sin levels"
    - "Every generated NPC has knowledge facts gated by trust levels"
    - "NPCs form a connected graph via shared sin assignments (no isolates)"
    - "Each NPC has conflict thresholds and personality/speech patterns"
    - "Generated NPCs match the existing NPC type interface exactly"
  artifacts:
    - path: "src/templates/npcArchetypes.ts"
      provides: "8+ NPC role archetypes with personality/speech/resist templates"
      exports: ["NPC_ARCHETYPES", "NPCArchetype"]
    - path: "src/templates/relationshipPatterns.ts"
      provides: "Relationship type definitions and sin-level-based patterns"
      exports: ["RELATIONSHIP_PATTERNS", "RelationshipType", "NPCRelationship"]
    - path: "src/generators/npcGenerator.ts"
      provides: "NPC generation with knowledge facts and sin linkages"
      exports: ["generateNPCs", "NPCGenerationResult"]
  key_links:
    - from: "src/generators/npcGenerator.ts"
      to: "src/templates/npcArchetypes.ts"
      via: "selects archetypes based on sin npcRoleSlots"
      pattern: "NPC_ARCHETYPES"
    - from: "src/generators/npcGenerator.ts"
      to: "src/templates/relationshipPatterns.ts"
      via: "applies relationship patterns between NPCs"
      pattern: "RELATIONSHIP_PATTERNS"
    - from: "src/generators/npcGenerator.ts"
      to: "src/types/npc.ts"
      via: "returns NPC[] matching existing interface"
      pattern: "NPC\\[\\]|NPCKnowledge|ConflictThreshold"
---

<objective>
Create NPC archetypes, relationship patterns, and the NPC generator that produces interconnected NPCs with knowledge facts linked to sin nodes.

Purpose: NPCs are the primary interaction layer. Each NPC must have stakes in the town's sins, knowledge to reveal, and relationships to other NPCs. This generator takes a sin chain and produces a cast of characters with dramatic tension.

Output: A working `generateNPCs(sinChain, seed)` that produces 5-7 NPCs with full knowledge pools, conflict thresholds, relationships, and sin linkages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-town-generation/06-RESEARCH.md
@src/types/npc.ts
@src/types/dialogue.ts
@src/data/towns/bridalFalls.ts
@.planning/phases/06-town-generation/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: NPC archetypes and relationship patterns</name>
  <files>src/templates/npcArchetypes.ts, src/templates/relationshipPatterns.ts</files>
  <action>
Create `src/templates/npcArchetypes.ts`:
- Export `NPCArchetype` interface:
  ```
  { role: string; nameTemplates: { prefix: string; names: string[] }; personalityTemplates: string[]; speechPatternTemplates: string[]; defaultLocationType: string; resistProfile: { body: number; will: number; heart: number; acuity: number }; factTemplates: FactTemplate[] }
  ```
- Export `FactTemplate` interface: `{ contentPattern: string; tags: string[]; minTrustLevel: number; requiredApproach?: ApproachType; forSinLevel?: SinLevel }`
- Export `NPC_ARCHETYPES: NPCArchetype[]` with 8+ archetypes:
  - Steward (authority, high will resist, pride-linked)
  - Sheriff (enforcer, high body resist, pride/injustice-linked)
  - Midwife/Healer (victim, low resist all, injustice/sin-linked)
  - Farmer (desperate, medium body, sin-linked)
  - Teacher (observer, low resist, sees everything)
  - Preacher (doctrine, high will, false-doctrine/pride-linked)
  - Merchant (practical, medium acuity, sin/injustice-linked)
  - Elder (respected, medium all, any level)
- Each archetype gets 3+ personality templates, 2+ speech patterns, 4+ fact templates spanning different trust levels (0, 20, 40, 60, 80)
- Fact templates use `{town}`, `{sinner}`, `{victim}`, `{authority}` slots
- Every archetype has at least one fact at trust level 0 (starter fact)

Create `src/templates/relationshipPatterns.ts`:
- Export `RelationshipType`: 'family' | 'ally' | 'enemy' | 'romantic' | 'secret-keeper' | 'victim-of' | 'protector-of'
- Export `NPCRelationship` interface: `{ from: string; to: string; type: RelationshipType; secret: boolean; sinId?: string }`
- Export `RELATIONSHIP_PATTERNS: Record<SinLevel, RelationshipPattern[]>` where `RelationshipPattern` is `{ roles: [string, string]; type: RelationshipType; secret: boolean }`
- Patterns define which role pairs get which relationship type for each sin level:
  - Pride: authority+enforcer=ally, authority+victim=enemy
  - Injustice: victim+protector=protector-of, authority+victim=victim-of
  - Sin: sinner+victim=protector-of, sinner+authority=enemy
  - Demonic: healer+victim=ally, observer+authority=secret-keeper
  - False Doctrine: preacher+authority=ally, preacher+farmer=enemy
  - Sorcery: practitioner+victim=enemy, practitioner+observer=secret-keeper
  - Murder: killer+victim=enemy, killer+protector=enemy
  </action>
  <verify>
`npx tsc --noEmit` passes. `NPC_ARCHETYPES.length >= 8`. Every archetype has `factTemplates.length >= 4` with at least one `minTrustLevel === 0`.
  </verify>
  <done>8+ NPC archetypes with rich personality, speech, resist, and fact templates. Relationship patterns defined for all 7 sin levels.</done>
</task>

<task type="auto">
  <name>Task 2: NPC generator with sin-based connectivity</name>
  <files>src/generators/npcGenerator.ts</files>
  <action>
Create `src/generators/npcGenerator.ts`:
- Import types from npc.ts, dialogue.ts, investigation.ts
- Import `NPC_ARCHETYPES`, `NPCArchetype`, `FactTemplate` from templates
- Import `RELATIONSHIP_PATTERNS`, `NPCRelationship` from templates
- Import `createRNG` from seededRandom
- Import `fillTemplate` from sinChainGenerator

Export `NPCGenerationResult`: `{ npcs: NPC[]; relationships: NPCRelationship[]; updatedSinChain: SinNode[] }`

Note: The `relationships` array is internal to the generation result and used for debugging/logging. TownData does NOT have a relationships field. Connectivity is validated implicitly via shared sin assignments (every NPC shares at least one sinId with at least one other NPC via their linkedNpcs arrays).

Export `generateNPCs(sinChain: SinNode[], seed: string): NPCGenerationResult`:
1. Create RNG from seed
2. For each sin node, identify needed NPC roles from the sin template's `npcRoleSlots` (passed via sinChain or looked up)
3. Select archetypes for each role. Prefer unique archetypes (soft constraint - reuse only if needed for >5 sins)
4. Generate 5-7 NPCs total:
   - Each NPC gets: unique ID (`npc-{role}-{hash}`), name (from archetype nameTemplates using RNG), locationId (from archetype defaultLocationType), description, role
   - Generate NPCKnowledge: personality (RNG pick from templates), speechPattern (RNG pick), facts (instantiate factTemplates with slots filled from sin chain context)
   - Generate ConflictThreshold[] from archetype resistProfile (direct mapping)
5. Link NPCs to sin nodes: update `sinChain[i].linkedNpcs` with relevant NPC IDs
6. Build relationships using RELATIONSHIP_PATTERNS:
   - For each sin, look up patterns matching the NPC roles assigned to that sin
   - Create NPCRelationship edges
   - Ensure connectivity: every NPC must share at least one sin with at least one other NPC. If an NPC is isolated (assigned to a sin with no other NPCs), also link them to an adjacent sin in the chain.
7. Return { npcs, relationships, updatedSinChain }

Generated NPCs always populate the knowledge field (it is optional in the NPC type `knowledge?: NPCKnowledge` but always present in practice - the LLM dialogue system requires it). Validators in 06-04 should assert `npc.knowledge` exists before accessing facts.

Key constraints:
- Every sin must have at least 2 linked NPCs
- Every NPC must have at least one fact at trust level 0 (entry point)
- NPC IDs must be kebab-case strings matching LocationId patterns
- Knowledge facts with sinId must reference actual sin IDs from the chain
- Generated NPCs must match existing NPC interface (id, name, locationId, description, role, knowledge, conflictThresholds)
  </action>
  <verify>
`npx tsc --noEmit` passes. Test: `generateNPCs(generateSinChain("test", 4), "test")` returns 5-7 NPCs. Every sin has 2+ linkedNpcs. Every NPC has knowledge.facts with at least one trust-0 fact. Every NPC shares at least one sinId with another NPC (implicit connectivity).
  </verify>
  <done>NPC generator produces 5-7 interconnected NPCs per town. Every NPC has knowledge, thresholds, personality. Every sin has 2+ linked NPCs. NPCs are connected via shared sin assignments.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- Generated NPCs match NPC interface (id, name, locationId, description, role, knowledge, conflictThresholds)
- Every sin node has 2+ linkedNpcs after generation
- Every NPC has facts spanning trust levels 0-80
- Every NPC shares at least one sinId with at least one other NPC (no isolates)
- Same seed produces same NPCs
- Different seeds produce different NPC selections
</verification>

<success_criteria>
- 8+ NPC archetypes with DitV-authentic personality templates
- Relationship patterns cover all 7 sin levels
- Generator produces complete NPC casts with knowledge, thresholds, relationships
- NPCs are meaningfully linked to sin nodes (not random assignment)
- Connectivity verified via shared sin assignments (no isolates)
</success_criteria>

<output>
After completion, create `.planning/phases/06-town-generation/06-02-SUMMARY.md`
</output>
