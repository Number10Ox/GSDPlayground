---
phase: 06-town-generation
plan: 06
type: execute
wave: 6
depends_on: ["06-05"]
files_modified:
  - e2e/features/town-generation.feature
  - e2e/steps/townGeneration.steps.ts
  - e2e/town-generation.spec.ts
autonomous: true

must_haves:
  truths:
    - "E2E tests verify town selection works from UI"
    - "E2E tests verify generated towns are playable (can navigate, talk to NPCs)"
    - "E2E tests verify sin chain discoverability in generated towns"
    - "Tests pass in CI (headless Chromium)"
  artifacts:
    - path: "e2e/features/town-generation.feature"
      provides: "BDD feature file for town generation scenarios"
    - path: "e2e/steps/townGeneration.steps.ts"
      provides: "Step helper functions for town generation E2E"
      exports: ["selectTown", "verifyTownLoaded", "verifyNPCsPresent", "verifyLocationNavigation"]
    - path: "e2e/town-generation.spec.ts"
      provides: "Playwright test specs for town generation"
  key_links:
    - from: "e2e/town-generation.spec.ts"
      to: "src/components/TownSelection/TownSelection.tsx"
      via: "interacts with town selection UI via data-testid"
      pattern: "town-selection|select-town"
    - from: "e2e/town-generation.spec.ts"
      to: "src/App.tsx"
      via: "tests full app flow from selection to gameplay"
      pattern: "page\\.goto|page\\.click"
---

<objective>
Create E2E tests that verify the town generation pipeline produces playable towns accessible through the UI.

Purpose: E2E tests prove the full pipeline works: generated towns load, NPCs are interactable, locations are navigable, and the sin chain is discoverable. This catches integration issues between generation and gameplay systems.

Output: BDD feature file + step helpers + Playwright specs covering town selection, generated town navigation, and NPC interaction in generated towns.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@e2e/character.spec.ts
@e2e/steps/investigation.steps.ts
@.planning/phases/06-town-generation/06-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: BDD feature file and step helpers</name>
  <files>e2e/features/town-generation.feature, e2e/steps/townGeneration.steps.ts</files>
  <action>
Create `e2e/features/town-generation.feature`:
```gherkin
Feature: Town Generation
  As a Dog traveling between towns
  I want to choose from multiple procedurally generated towns
  So that each playthrough offers a different moral landscape

  Scenario: Player sees town selection screen
    Given I open the application
    Then I should see the town selection screen
    And I should see at least 3 town options
    And each town should show its name and description

  Scenario: Player selects a hand-crafted town
    Given I open the application
    When I select "Bridal Falls"
    Then the game should load with "Bridal Falls" as the town
    And I should see the town map with locations

  Scenario: Player selects a generated town
    Given I open the application
    When I select a generated town
    Then the game should load with that town
    And I should see at least 5 NPC locations on the map
    And I should be able to navigate between locations

  Scenario: Generated town has interactable NPCs
    Given I have entered a generated town
    When I navigate to a location with an NPC
    Then I should be able to start a conversation
    And the NPC should have available topics

  Scenario: Generated town sin chain is discoverable
    Given I have entered a generated town
    When I talk to NPCs using different approaches
    Then I should be able to uncover at least one discovery
    And the mental map should update with the discovery

  Scenario: Multiple generated towns are different
    Given I open the application
    Then the generated towns should have different names
    And the generated towns should have different NPC counts or sin depths
```

Create `e2e/steps/townGeneration.steps.ts`:
- Export helper functions matching the scenarios:
  - `selectTown(page, townName: string)`: Click the town card button matching the name
  - `verifyTownSelectionVisible(page)`: Assert town-selection container visible, 3+ cards
  - `verifyTownLoaded(page, townName: string)`: Assert game view loaded, town name visible somewhere
  - `verifyNPCsPresent(page)`: Assert at least 5 location nodes on the SVG map
  - `verifyLocationNavigation(page)`: Click a location node, verify currentLocation changes
  - `startNPCConversation(page)`: Navigate to NPC location, click NPC, verify dialogue opens
  - `verifyTopicsAvailable(page)`: Assert topic chips are rendered
  - `attemptDiscovery(page)`: Select topic + approach, intercept streaming response with discovery marker, verify mental map update
- Use existing patterns from investigation.steps.ts for NPC interaction
- Use page.route() for mocking dialogue API responses (same pattern as investigation E2E)
  </action>
  <verify>
`npx tsc --noEmit` passes for step helpers. Feature file has valid Gherkin syntax.
  </verify>
  <done>BDD feature covers 6 scenarios. Step helpers provide reusable functions for town selection and generated town interaction.</done>
</task>

<task type="auto">
  <name>Task 2: Playwright test specs</name>
  <files>e2e/town-generation.spec.ts</files>
  <action>
Create `e2e/town-generation.spec.ts`:
- Import test/expect from @playwright/test
- Import step helpers from townGeneration.steps
- Import existing fixtures/helpers as needed

Test structure (6 tests matching feature scenarios):

1. "shows town selection screen on load":
   - Navigate to app
   - Assert [data-testid="town-selection"] visible
   - Assert 3+ [data-testid^="town-card-"] elements
   - Assert each card has name text and description text

2. "selects Bridal Falls and loads game":
   - Navigate to app
   - Click [data-testid="select-town-bridal-falls"]
   - Assert town-selection disappears
   - Assert game map SVG visible with location nodes
   - Assert "Bridal Falls" text or location names from bridalFalls visible

3. "selects generated town and loads game":
   - Navigate to app
   - Click [data-testid="select-town-hollow-creek"] (or whichever generated town)
   - Assert game loads with different locations than bridalFalls
   - Assert 6+ location nodes on map (generated towns have more locations)
   - Click a non-current location, verify navigation works

4. "generated town has interactable NPCs":
   - Select generated town
   - Navigate to a location with an NPC (click location node)
   - Click NPC interaction trigger
   - Mock the dialogue API response with page.route()
   - Verify topic chips appear
   - Verify approach chips appear after topic selection

5. "generated town sin chain is discoverable":
   - Select generated town
   - Set up page.route() to return response with [DISCOVERY: factId|sinId|content] marker
   - Navigate to NPC, start conversation
   - Select topic + approach
   - Verify discovery notification appears
   - Verify mental map shows new node (if mental map is open)

6. "generated towns have different content":
   - Navigate to app
   - Read all town card names and descriptions
   - Assert no two towns share the same name
   - Assert sin depth indicators differ between generated towns

Key patterns to follow:
- Use page.route() for all API mocking (route interception pattern from 05-07)
- Use dispatchEvent('click') for SVG elements (from 05-07 lessons)
- Wait for animations/transitions with page.waitForSelector
- Use data-testid attributes exclusively for selectors
  </action>
  <verify>
`npx playwright test e2e/town-generation.spec.ts` passes all 6 tests. No flaky tests (run 3x to confirm stability).
  </verify>
  <done>6 E2E tests pass covering town selection, generated town gameplay, NPC interaction, discovery, and variety verification.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes
- `npx playwright test e2e/town-generation.spec.ts` passes all tests
- Tests run in headless Chromium (CI-ready)
- No test depends on specific generated content (tests verify structure, not exact text)
- Total E2E suite still passes: `npx playwright test` (all specs including prior phases)
</verification>

<success_criteria>
- 6 E2E tests covering the full town generation flow
- Tests verify both hand-crafted and generated towns work
- NPC interaction in generated towns produces discoveries
- Tests are stable (no flakiness from timing issues)
- Full E2E suite passes (30 prior tests + 6 new = 36 total)
</success_criteria>

<output>
After completion, create `.planning/phases/06-town-generation/06-06-SUMMARY.md`
</output>
