---
phase: 06-town-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/seededRandom.ts
  - src/templates/sinTemplates.ts
  - src/generators/sinChainGenerator.ts
autonomous: true

must_haves:
  truths:
    - "Sin chain generator produces valid SinNode[] matching existing type"
    - "Each sin level has 3+ templates for variety"
    - "Same seed always produces same sin chain"
    - "Generated chains are 3-7 levels long (configurable)"
  artifacts:
    - path: "src/utils/seededRandom.ts"
      provides: "Deterministic seeded random number generator"
      exports: ["createRNG", "SeededRNG"]
    - path: "src/templates/sinTemplates.ts"
      provides: "3+ templates per sin level (21+ total)"
      exports: ["SIN_TEMPLATES", "SinSlotTemplate"]
    - path: "src/generators/sinChainGenerator.ts"
      provides: "Sin chain generation from templates"
      exports: ["generateSinChain"]
  key_links:
    - from: "src/generators/sinChainGenerator.ts"
      to: "src/templates/sinTemplates.ts"
      via: "imports SIN_TEMPLATES"
      pattern: "import.*SIN_TEMPLATES.*sinTemplates"
    - from: "src/generators/sinChainGenerator.ts"
      to: "src/utils/seededRandom.ts"
      via: "uses createRNG for deterministic selection"
      pattern: "createRNG|SeededRNG"
    - from: "src/generators/sinChainGenerator.ts"
      to: "src/types/investigation.ts"
      via: "returns SinNode[] matching existing type"
      pattern: "SinNode\\[\\]"
---

<objective>
Create the seeded random utility, sin progression templates, and sin chain generator.

Purpose: This is the foundation of town generation. Sin chains define the moral structure of every town. The seeded RNG ensures deterministic generation for reproducibility and testing.

Output: A working `generateSinChain(seed, chainLength)` function that produces valid `SinNode[]` arrays from 21+ hand-authored templates across all 7 sin levels.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-town-generation/06-RESEARCH.md
@src/types/investigation.ts
@src/data/towns/bridalFalls.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Seeded RNG utility and sin templates</name>
  <files>src/utils/seededRandom.ts, src/templates/sinTemplates.ts</files>
  <action>
Create `src/utils/seededRandom.ts`:
- Export `SeededRNG` interface with methods: `next(): number` (0-1), `nextInt(min, max): number`, `pick<T>(array: T[]): T`, `shuffle<T>(array: T[]): T[]`
- Export `createRNG(seed: string): SeededRNG` using a simple mulberry32 or xoshiro128 algorithm seeded by hashing the seed string (use simple string-to-number hash, no external deps)
- All methods must be deterministic given same seed

Create `src/templates/sinTemplates.ts`:
- Export `SinSlotTemplate` interface: `{ level: SinLevel; name: string; descriptionPattern: string; npcRoleSlots: string[]; causeSlot?: string; effectSlot?: string }`
- Export `SIN_TEMPLATES: Record<SinLevel, SinSlotTemplate[]>` with 3 templates per sin level (21 total)
- Templates should use `{town}`, `{authority}`, `{victim}`, `{sinner}` placeholder slots
- DitV-authentic content:
  - Pride: authority hubris, family supremacy, secret knowledge
  - Injustice: denied care, unfair labor, exclusion from worship
  - Sin: theft, adultery, violence against kin
  - Demonic Attacks: plague, crop failure, livestock death
  - False Doctrine: blood rituals, prosperity gospel, fear-based worship
  - Sorcery: communion with demons, cursed objects, binding rituals
  - Hate and Murder: revenge killing, sacrifice, mob violence
- Each template's `npcRoleSlots` should list 2-3 archetype roles relevant to that sin (e.g., Pride: ["steward", "elder", "preacher"])
  </action>
  <verify>
`npx tsc --noEmit` passes. Import both files and verify: `createRNG("test").next()` returns consistent number; `SIN_TEMPLATES.pride.length >= 3` for all levels.
  </verify>
  <done>SeededRNG produces deterministic output. All 7 sin levels have 3+ templates with DitV-authentic content and placeholder slots.</done>
</task>

<task type="auto">
  <name>Task 2: Sin chain generator</name>
  <files>src/generators/sinChainGenerator.ts</files>
  <action>
Create `src/generators/sinChainGenerator.ts`:
- Import `SinNode`, `SinLevel` from `@/types/investigation`
- Import `SIN_TEMPLATES`, `SinSlotTemplate` from `@/templates/sinTemplates`
- Import `createRNG` from `@/utils/seededRandom`
- Import `SIN_CHAIN_ORDER` from `@/reducers/investigationReducer` (that is where it is exported)

Export `generateSinChain(seed: string, chainLength: number): SinNode[]`:
1. Validate chainLength is 3-7, clamp if outside range
2. Create RNG from seed
3. Select `chainLength` sin levels from SIN_CHAIN_ORDER (always starting from 'pride', taking first N)
4. For each selected level:
   - Use RNG to pick one template from `SIN_TEMPLATES[level]`
   - Generate unique sin ID: `sin-${level}-${hash}` (use first 6 chars of seed hash)
   - Fill template name/description patterns with town name derived from seed
   - Create SinNode with `discovered: false`, `resolved: false`, `linkedNpcs: []` (filled later by NPC generator)
5. Return SinNode[] in progression order

Export helper `fillTemplate(pattern: string, slots: Record<string, string>): string` for slot substitution.

Ensure the return type matches the existing SinNode interface exactly (id, level, name, description, discovered, resolved, linkedNpcs).
  </action>
  <verify>
`npx tsc --noEmit` passes. Write a quick test: `generateSinChain("test-seed", 4)` returns 4 SinNodes with levels pride, injustice, sin, demonic-attacks. Same seed always returns same result. Different seeds return different template selections.
  </verify>
  <done>generateSinChain produces valid SinNode[] arrays. Same seed = same chain. Chain length configurable 3-7. All nodes have proper IDs, names, descriptions from templates.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with no type errors
- `createRNG("seed1").next() === createRNG("seed1").next()` (deterministic)
- `createRNG("seed1").next() !== createRNG("seed2").next()` (different seeds differ)
- `generateSinChain("abc", 4).length === 4`
- `generateSinChain("abc", 4)[0].level === 'pride'`
- `generateSinChain("abc", 7).length === 7` (full chain)
- All SinNode fields present and match interface
</verification>

<success_criteria>
- Seeded RNG utility works deterministically
- 21+ sin templates authored with DitV-authentic content
- Sin chain generator produces valid chains of configurable length
- Types compile cleanly against existing investigation.ts
</success_criteria>

<output>
After completion, create `.planning/phases/06-town-generation/06-01-SUMMARY.md`
</output>
